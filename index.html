<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Lieven Clement" />

<meta name="date" content="2021-04-19" />

<title>An introduction to state-space models for time-series analysis with examples on three major crypto-currencies</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-sm-12 col-md-4 col-lg-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-sm-12 col-md-8 col-lg-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">StateSpaceCrypto</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/statOmics/StateSpaceCrypto">
    <span class="fas fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://statomics.github.io/">statOmics</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">An introduction to state-space models for time-series analysis with examples on three major crypto-currencies</h1>
<h4 class="author">Lieven Clement</h4>
<h4 class="date">April 19, 2021</h4>

</div>


<div id="introduction" class="section level1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<ul>
<li><p>Associate Professor of Statistical Genomics in Ghent University</p></li>
<li><p>Advocate of open research and open teaching: All our teaching materials, methods, tools and analyses for papers are open source and freely available on github</p>
<ul>
<li><a href="https://statomics.github.io/" class="uri">https://statomics.github.io/</a></li>
<li><a href="https://statomics.github.io/pages/teaching.html" class="uri">https://statomics.github.io/pages/teaching.html</a></li>
<li><a href="https://github.com/statomics" class="uri">https://github.com/statomics</a></li>
</ul></li>
<li><p>Method development for differential analysis of gene and protein expression</p></li>
<li><p>Background in environmental engineering with a PhD in environmental statistics with a focus on timeseries analysis of river water quality data</p></li>
<li><p>Intro to</p>
<ul>
<li>State Space Models</li>
<li>Kalman filter &amp; smoother</li>
<li>Applied on cryptocurrency data</li>
<li>Brief intro and illustration only, by no means the current state of the art</li>
<li>More advanced State Space Models required for hedging or predicting cryptocurrency data in practice.</li>
</ul></li>
<li><p>This work is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a></p></li>
</ul>
<p><br /></p>
<div id="useful-functions-and-load-libraries" class="section level2">
<h2><span class="header-section-number">1.1</span> Useful functions and load libraries</h2>
<details>
<summary>Click to see loaded libraries </summary>
<p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(astsa)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(tidyverse)</span></code></pre></div>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.3.3     ✔ purrr   0.3.4
## ✔ tibble  3.1.1     ✔ dplyr   1.0.5
## ✔ tidyr   1.1.3     ✔ stringr 1.4.0
## ✔ readr   1.4.0     ✔ forcats 0.5.1</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">library</span>(GGally)</span></code></pre></div>
<pre><code>## Registered S3 method overwritten by &#39;GGally&#39;:
##   method from   
##   +.gg   ggplot2</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">library</span>(gridExtra)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;gridExtra&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     combine</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">library</span>(gifski)</span></code></pre></div>
</p>
</details>
<details>
<summary>Click to see function to retreive coin data from coingecko </summary>
<p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># coinSymbol: symbol of cryptocurrency token or coin</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># days: past number of days you want to retrieve data for. &quot;max&quot; returns all available data for a token or coin.</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co"># currency: fiat currency you want to use for price (&quot;usd&quot;,&quot;eur&quot;,&quot;jpy&quot;, ...)</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co"># interval: time interval on which you want to retreive data.</span></span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a>retreiveCoinData &lt;-<span class="st"> </span><span class="cf">function</span>(</span>
<span id="cb11-7"><a href="#cb11-7"></a>                              <span class="dt">coinSymbol=</span><span class="st">&quot;btc&quot;</span>, </span>
<span id="cb11-8"><a href="#cb11-8"></a>                              <span class="dt">days =</span> <span class="st">&quot;max&quot;</span>, </span>
<span id="cb11-9"><a href="#cb11-9"></a>                              <span class="dt">currency =</span> <span class="st">&quot;usd&quot;</span>, </span>
<span id="cb11-10"><a href="#cb11-10"></a>                              <span class="dt">interval =</span> <span class="st">&quot;daily&quot;</span>)</span>
<span id="cb11-11"><a href="#cb11-11"></a>{   </span>
<span id="cb11-12"><a href="#cb11-12"></a>  <span class="co">#Retreive coinlist to lookup coin id</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>  coinlist &lt;-<span class="st"> </span>httr<span class="op">::</span><span class="kw">GET</span>(<span class="st">&quot;https://api.coingecko.com/api/v3/coins/list&quot;</span>)<span class="op">$</span>content <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="st">    </span>rawToChar <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="st">    </span>jsonlite<span class="op">::</span><span class="kw">fromJSON</span>(.)</span>
<span id="cb11-16"><a href="#cb11-16"></a>  </span>
<span id="cb11-17"><a href="#cb11-17"></a>  coinId &lt;-<span class="st"> </span>coinlist <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(symbol <span class="op">==</span><span class="st"> </span>coinSymbol) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(id)</span>
<span id="cb11-18"><a href="#cb11-18"></a>  </span>
<span id="cb11-19"><a href="#cb11-19"></a>  <span class="co">#retreive coin data via API</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>  coinData &lt;-<span class="st"> </span>httr<span class="op">::</span><span class="kw">GET</span>(</span>
<span id="cb11-21"><a href="#cb11-21"></a>    <span class="kw">paste0</span>(</span>
<span id="cb11-22"><a href="#cb11-22"></a>      <span class="st">&quot;https://api.coingecko.com/api/v3/coins/&quot;</span>,</span>
<span id="cb11-23"><a href="#cb11-23"></a>      coinId,</span>
<span id="cb11-24"><a href="#cb11-24"></a>      <span class="st">&quot;/market_chart?vs_currency=&quot;</span>,</span>
<span id="cb11-25"><a href="#cb11-25"></a>      currency,</span>
<span id="cb11-26"><a href="#cb11-26"></a>      <span class="st">&quot;&amp;days=&quot;</span>,</span>
<span id="cb11-27"><a href="#cb11-27"></a>      days,</span>
<span id="cb11-28"><a href="#cb11-28"></a>      <span class="st">&quot;&amp;interval=&quot;</span>,</span>
<span id="cb11-29"><a href="#cb11-29"></a>      interval)</span>
<span id="cb11-30"><a href="#cb11-30"></a>    )<span class="op">$</span>content <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="st">    </span>rawToChar <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="st">    </span>jsonlite<span class="op">::</span><span class="kw">fromJSON</span>(.)</span>
<span id="cb11-33"><a href="#cb11-33"></a>  </span>
<span id="cb11-34"><a href="#cb11-34"></a>  <span class="co">#store coin data as tible, include coin symbol in price name and covert unix time string to timestamp object</span></span>
<span id="cb11-35"><a href="#cb11-35"></a>  coinData &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">names</span>(coinData), <span class="cf">function</span>(var,coinData) </span>
<span id="cb11-36"><a href="#cb11-36"></a>          {</span>
<span id="cb11-37"><a href="#cb11-37"></a>            data &lt;-<span class="st"> </span>coinData[[var]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</span>
<span id="cb11-38"><a href="#cb11-38"></a>            <span class="kw">names</span>(data) &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb11-39"><a href="#cb11-39"></a>                             <span class="st">&quot;timestamp&quot;</span>,</span>
<span id="cb11-40"><a href="#cb11-40"></a>                             <span class="kw">paste0</span>(coinSymbol,<span class="st">&quot;_&quot;</span>,var)</span>
<span id="cb11-41"><a href="#cb11-41"></a>                             )</span>
<span id="cb11-42"><a href="#cb11-42"></a>            data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-43"><a href="#cb11-43"></a><span class="st">              </span><span class="kw">mutate</span>(</span>
<span id="cb11-44"><a href="#cb11-44"></a>                <span class="dt">timestamp =</span>  <span class="kw">as.POSIXct</span>(</span>
<span id="cb11-45"><a href="#cb11-45"></a>                  timestamp<span class="op">/</span><span class="dv">1000</span>, </span>
<span id="cb11-46"><a href="#cb11-46"></a>                  <span class="dt">origin =</span> <span class="st">&quot;1970-01-01&quot;</span>,<span class="dt">tz=</span><span class="st">&quot;GMT&quot;</span></span>
<span id="cb11-47"><a href="#cb11-47"></a>                  )</span>
<span id="cb11-48"><a href="#cb11-48"></a>                ) </span>
<span id="cb11-49"><a href="#cb11-49"></a>            <span class="kw">return</span>(data)</span>
<span id="cb11-50"><a href="#cb11-50"></a>          }, <span class="dt">coinData =</span> coinData</span>
<span id="cb11-51"><a href="#cb11-51"></a>        )  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(left_join, <span class="dt">by =</span> <span class="st">&quot;timestamp&quot;</span>)</span>
<span id="cb11-52"><a href="#cb11-52"></a>  <span class="co">#rename prices column to include currency</span></span>
<span id="cb11-53"><a href="#cb11-53"></a>  pricesId &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="kw">names</span>(coinData), <span class="dt">pattern=</span><span class="st">&quot;prices&quot;</span>)</span>
<span id="cb11-54"><a href="#cb11-54"></a>  <span class="kw">names</span>(coinData)[pricesId] &lt;-<span class="st"> </span><span class="kw">paste</span>(</span>
<span id="cb11-55"><a href="#cb11-55"></a>    <span class="kw">names</span>(coinData)[pricesId],</span>
<span id="cb11-56"><a href="#cb11-56"></a>    currency,</span>
<span id="cb11-57"><a href="#cb11-57"></a>    <span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)</span>
<span id="cb11-58"><a href="#cb11-58"></a>  </span>
<span id="cb11-59"><a href="#cb11-59"></a>  <span class="co">#get rid of last time because coin gecko returns all daily data at 00:00 GMT and includes the last entry of the current day. </span></span>
<span id="cb11-60"><a href="#cb11-60"></a>  <span class="cf">if</span>(days<span class="op">==</span><span class="st">&quot;max&quot;</span>) </span>
<span id="cb11-61"><a href="#cb11-61"></a>      <span class="kw">return</span>(coinData) <span class="cf">else</span> </span>
<span id="cb11-62"><a href="#cb11-62"></a>        <span class="kw">return</span> (coinData[<span class="dv">1</span><span class="op">:</span>days,])</span>
<span id="cb11-63"><a href="#cb11-63"></a>}</span></code></pre></div>
</p>
</details>
<details>
<summary>Click to see function for acf plots </summary>
<p>
<p>Function to make ACF and PACF plots copied from <a href="https://github.com/mdelhey/mdutils" class="uri">https://github.com/mdelhey/mdutils</a></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>ggacf &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">type =</span> <span class="kw">c</span>(<span class="st">&quot;correlation&quot;</span>, <span class="st">&quot;covariance&quot;</span>, <span class="st">&quot;partial&quot;</span>), <span class="dt">ci =</span> <span class="fl">0.95</span>, ...) {</span>
<span id="cb12-2"><a href="#cb12-2"></a>    type &lt;-<span class="st"> </span><span class="kw">match.arg</span>(type)</span>
<span id="cb12-3"><a href="#cb12-3"></a>    x.acf &lt;-<span class="st"> </span><span class="kw">acf</span>(x, <span class="dt">type =</span> type, <span class="dt">plot =</span> <span class="ot">FALSE</span>, ...)</span>
<span id="cb12-4"><a href="#cb12-4"></a>    x.df &lt;-<span class="st"> </span><span class="kw">with</span>(x.acf, <span class="kw">data.frame</span>(lag, acf))</span>
<span id="cb12-5"><a href="#cb12-5"></a>    x.ci &lt;-<span class="st"> </span><span class="kw">qnorm</span>((<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>ci)<span class="op">/</span><span class="dv">2</span>) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">length</span>(x))</span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="kw">print</span>(x.ci)</span>
<span id="cb12-7"><a href="#cb12-7"></a>    <span class="kw">ggplot</span>(<span class="dt">data =</span> x.df, <span class="kw">aes</span>(<span class="dt">x =</span> lag, <span class="dt">y =</span> acf)) <span class="op">+</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="st">        </span><span class="kw">geom_hline</span>(<span class="kw">aes</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="st">        </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">xend =</span> lag, <span class="dt">yend =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="st">        </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="kw">c</span>(x.ci, <span class="op">-</span>x.ci), <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="op">+</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="st">        </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="fl">0.2</span>))</span>
<span id="cb12-12"><a href="#cb12-12"></a>}</span></code></pre></div>
</p>
</details>
<p><br /></p>
<hr />
</div>
<div id="data-exploration" class="section level2">
<h2><span class="header-section-number">1.2</span> Data exploration</h2>
<p>Select coins bitcoin (btc), etherium (eth) and litecoin (ltc)</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>coinSymbols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;btc&quot;</span>, <span class="st">&quot;eth&quot;</span>, <span class="st">&quot;ltc&quot;</span>)</span></code></pre></div>
<ul>
<li>We want to retreive data from January First 2019 up to today.</li>
<li>We have to calculate the number of days for which we want to retreive data for the coingecko API</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>todaysDate &lt;-<span class="st"> </span><span class="kw">as.POSIXlt</span>(<span class="kw">Sys.Date</span>(),<span class="dt">tz=</span><span class="st">&quot;GMT&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a>startDate &lt;-<span class="st"> </span><span class="kw">as.POSIXlt</span>(<span class="st">&quot;2019-01-01&quot;</span>,<span class="dt">tz=</span><span class="st">&quot;GMT&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a>ndays &lt;-<span class="st"> </span><span class="kw">as.double</span>(todaysDate <span class="op">-</span><span class="st"> </span>startDate) <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span></code></pre></div>
<p>Retreive data from coingecko. We will use the default currency (USD).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>coinData &lt;-<span class="st">  </span>coinSymbols <span class="op">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="st">      </span><span class="kw">map</span>(retreiveCoinData,<span class="dt">days=</span>ndays) <span class="op">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="st">      </span><span class="kw">reduce</span>(left_join, <span class="dt">by =</span> <span class="st">&quot;timestamp&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="st">      </span><span class="kw">arrange</span>(timestamp) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">date=</span><span class="kw">as.Date</span>(timestamp))</span></code></pre></div>
<pre><code>## Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if `.name_repair` is omitted as of tibble 2.0.0.
## Using compatibility `.name_repair`.</code></pre>
<p><br /></p>
<hr />
<div id="time-series-plots" class="section level3">
<h3><span class="header-section-number">1.2.1</span> Time series plots</h3>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>tsPlot &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="st">  </span><span class="kw">select</span>(date,<span class="kw">ends_with</span>(<span class="st">&quot;prices_usd&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="st">  </span><span class="kw">gather</span>(coin, usd, <span class="op">-</span>date) <span class="op">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(date,usd)) <span class="op">+</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>coin,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>)</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>tsPlot</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>tsPlot <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="dt">trans=</span><span class="st">&#39;log10&#39;</span>)</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>returnPlot1 &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;prices_usd&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="st">  </span><span class="kw">apply</span>(.,<span class="dv">2</span>,<span class="cf">function</span>(x) <span class="kw">diff</span>(x)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="st">  </span>as_tibble <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> coinData<span class="op">$</span>date[<span class="op">-</span><span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="st">  </span><span class="kw">gather</span>(coin, usd,<span class="op">-</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(date,usd)) <span class="op">+</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Price Difference (USD)&quot;</span>) <span class="op">+</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>coin,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>)</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>returnPlot1</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>returnPlot2 &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;prices_usd&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="st">  </span><span class="kw">apply</span>(.,<span class="dv">2</span>,<span class="cf">function</span>(x) <span class="kw">log10</span>(x) <span class="op">%&gt;%</span><span class="st"> </span>diff) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="st">  </span>as_tibble <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> coinData<span class="op">$</span>date[<span class="op">-</span><span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="st">  </span><span class="kw">gather</span>(coin, log_return,<span class="op">-</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(date,log_return)) <span class="op">+</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Daily Log Return (log10)&quot;</span>) <span class="op">+</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>coin,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>)</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>returnPlot2</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<hr />
<p><br /></p>
</div>
<div id="correlation-structure" class="section level3">
<h3><span class="header-section-number">1.2.2</span> Correlation Structure</h3>
<div id="correlation-between-cryptocurrency-timeseries" class="section level4">
<h4><span class="header-section-number">1.2.2.1</span> Correlation between cryptocurrency timeseries</h4>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>plotCoinData &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">format</span>(date,<span class="st">&quot;%Y&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.factor) <span class="op">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="st">  </span><span class="kw">select</span>(year,<span class="kw">ends_with</span>(<span class="st">&quot;prices_usd&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="st">  </span><span class="kw">ggpairs</span>(<span class="dt">progress =</span> <span class="ot">FALSE</span>,</span>
<span id="cb24-5"><a href="#cb24-5"></a>  <span class="dt">mapping=</span>ggplot2<span class="op">::</span><span class="kw">aes</span>(<span class="dt">colour =</span> year))</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>plotCoinData</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<ul>
<li><p>There is a strong correlation between the cryptocurrency timeseries!</p></li>
<li><p>The correlation between the cryptocurrencies seems to change over time (Dynamic hedge ratio’s?)</p></li>
</ul>
<p><br /></p>
</div>
<div id="autocorrelation-within-timeseries" class="section level4">
<h4><span class="header-section-number">1.2.2.2</span> Autocorrelation (within timeseries)</h4>
<p>Autocorrelation: <span class="math display">\[\text{cor}[y_t,y_{t-k}]\]</span> with lag <span class="math inline">\(k=1,2,3,\ldots\)</span></p>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>acfPlots &lt;-<span class="st"> </span><span class="kw">paste0</span>(coinSymbols,<span class="st">&quot;_prices_usd&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="st">  </span><span class="kw">map</span>(</span>
<span id="cb27-3"><a href="#cb27-3"></a>    <span class="cf">function</span>(x,coinData)</span>
<span id="cb27-4"><a href="#cb27-4"></a>      coinData <span class="op">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="st">      </span><span class="kw">pull</span>(x) <span class="op">%&gt;%</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="st">      </span>log10 <span class="op">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="st">      </span>ggacf <span class="op">+</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="st">      </span><span class="kw">ggtitle</span>(x),</span>
<span id="cb27-9"><a href="#cb27-9"></a>      <span class="dt">coinData=</span>coinData</span>
<span id="cb27-10"><a href="#cb27-10"></a>      )</span></code></pre></div>
<pre><code>## [1] 0.06762518
## [1] 0.06762518
## [1] 0.06762518</code></pre>
</p>
</details>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">grid.arrange</span>(<span class="dt">grobs=</span>acfPlots)</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<ul>
<li>There is a very strong autocorrelation within time series!</li>
<li>Indeed the price at time t is strongly correlated to that at a few days (lags k) earlier.</li>
</ul>
<p><br /></p>
<hr />
<p>Partial correlation?</p>
<p><span class="math display">\[\text{cor}[y_t,y_{t-k}\vert y_{t-1}\ldots y_{t-k+1}]\]</span></p>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>pacfPlots &lt;-<span class="st"> </span><span class="kw">paste0</span>(coinSymbols,<span class="st">&quot;_prices_usd&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="st">  </span><span class="kw">map</span>(</span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="cf">function</span>(x,coinData)</span>
<span id="cb30-4"><a href="#cb30-4"></a>      coinData <span class="op">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="st">      </span><span class="kw">pull</span>(x) <span class="op">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="st">      </span>log10 <span class="op">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="st">      </span><span class="kw">ggacf</span>(<span class="dt">type=</span><span class="st">&quot;partial&quot;</span>) <span class="op">+</span></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="st">      </span><span class="kw">ylab</span>(<span class="st">&quot;Partial ACF&quot;</span>) <span class="op">+</span></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="st">      </span><span class="kw">ggtitle</span>(x),</span>
<span id="cb30-10"><a href="#cb30-10"></a>      <span class="dt">coinData=</span>coinData</span>
<span id="cb30-11"><a href="#cb30-11"></a>      )</span></code></pre></div>
<pre><code>## [1] 0.06762518
## [1] 0.06762518
## [1] 0.06762518</code></pre>
</p>
</details>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">grid.arrange</span>(<span class="dt">grobs=</span>pacfPlots)</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<ul>
<li>The partial ACF only shows a direct correlation between the current price and the price at the previous day (lag 1).<br />
</li>
<li>Hence, the price of cryptocurrencies seems uncorrelated with that in the past when we condition on yesterdays price.</li>
</ul>
<p><span class="math display">\[\ldots \rightarrow y_{t-2} \rightarrow y_{t-1} \rightarrow y_t \rightarrow y_{t+1} \rightarrow \ldots \]</span></p>
<p><br /></p>
</div>
</div>
<div id="normality" class="section level3">
<h3><span class="header-section-number">1.2.3</span> Normality</h3>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>qqplots &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;prices_usd&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="st">  </span><span class="kw">apply</span>(.,<span class="dv">2</span>,<span class="cf">function</span>(x) <span class="kw">log10</span>(x) <span class="op">%&gt;%</span><span class="st"> </span>diff) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="st">  </span>as_tibble <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> coinData<span class="op">$</span>date[<span class="op">-</span><span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="st">  </span><span class="kw">gather</span>(coin, log_return,<span class="op">-</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> log_return)) <span class="op">+</span></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb33-9"><a href="#cb33-9"></a><span class="st">  </span><span class="kw">geom_qq_line</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb33-10"><a href="#cb33-10"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>coin,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>)</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>qqplots</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<ul>
<li>The log-differenced data are symmetric but non-normally distributed</li>
<li>In the remainder we will introduce Gaussian State Space Models</li>
<li>However, if the timeseries are non-Gaussian the parameter estimators are still assymptotically normally distributed.</li>
<li>In short time-series we can resort to the bootstrap to provide better inference.</li>
</ul>
<p><br /></p>
<hr />
</div>
</div>
</div>
<div id="state-space-models" class="section level1">
<h1><span class="header-section-number">2</span> State Space Models</h1>
<div id="cryptocurrency-example" class="section level2">
<h2><span class="header-section-number">2.1</span> Cryptocurrency example</h2>
<ul>
<li><p>We will log<span class="math inline">\(_\text{10}\)</span>-transform the data and model it with a state space model.</p></li>
<li><p>Let <span class="math inline">\(\mathbf{y}_t\)</span> be a vector of the log-transformed prices of btc, eth and ltc at time <span class="math inline">\(t\)</span> <span class="math display">\[\mathbf{y}_t=\begin{bmatrix}y^\text{btc}_t\\y^\text{eth}_t\\y^\text{ltc}_t\end{bmatrix}\]</span></p></li>
<li><p>Suppose that they are driven by an underlying unknown first order Markovian cryptocurrency price level, referred to as the state <span class="math inline">\(\mathbf{X}\)</span> <span class="math display">\[\mathbf{X}=\begin{bmatrix}X^\text{btc}_t\\X^\text{eth}_t\\X^\text{ltc}_t\end{bmatrix}\]</span></p></li>
<li><p>So the actual observed price <span class="math inline">\(\mathbf{y}_t\)</span> is a noisy realisation of the underlying unknown price level (state) <span class="math inline">\(\mathbf{X}_t\)</span>.</p></li>
</ul>
<p><span class="math display">\[
\begin{array}{ccccccccccc}\ldots &amp; \rightarrow &amp; \mathbf{X}_{t-2} &amp; \rightarrow &amp; \mathbf{X}_{t-1} &amp; \rightarrow &amp; \mathbf{X}_t &amp; \rightarrow &amp; \mathbf{X}_{t+1} &amp; \rightarrow &amp; \ldots\\
&amp;&amp;\downarrow&amp;&amp;\downarrow&amp;&amp;\downarrow&amp;&amp;\downarrow\\
\ldots &amp;  &amp; \mathbf{y}_{t-2} &amp; &amp; \mathbf{y}_{t-1} &amp;  &amp; \mathbf{y}_t &amp; &amp; \mathbf{y}_{t+1} &amp;  &amp; \ldots
\end{array}
\]</span></p>
<p><br /></p>
<ul>
<li>Assume that <span class="math inline">\(\mathbf{y}_t\vert \mathbf{X}_t\)</span> and <span class="math inline">\(\mathbf{X}_t\vert \mathbf{X}_{t-1}\)</span> are multivariate normally (MVN) distributed</li>
</ul>
<p><br /></p>
<ul>
<li>We can than formulate the following State Space Model:</li>
</ul>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t&amp;=&amp;\mathbf{X}_t+\mathbf{v}_t &amp;\text{with}\ \mathbf{v}_t\sim MVN(\mathbf{0},\mathbf{R})\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi} \mathbf{X}_{t-1} + \mathbf{w}_t &amp;\text{with}\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q})
\end{array}
\right.
\]</span></p>
<p>with</p>
<ul>
<li><span class="math inline">\(t = 1, \ldots,n\)</span></li>
<li>an <span class="math inline">\(3 \times 3\)</span> transition matrix <span class="math inline">\(\boldsymbol{\Phi}\)</span> and</li>
<li>independent <span class="math inline">\(3 \times 1\)</span> vectors <span class="math inline">\(\mathbf{v}_t\)</span> and <span class="math inline">\(\mathbf{w}_t\)</span> with mean zero and variance-covariance matrix <span class="math inline">\(\mathbf{R}\)</span> and <span class="math inline">\(\mathbf{Q}\)</span>, respectively.</li>
</ul>
<p><br /></p>
<hr />
</div>
<div id="general-formulation-of-state-space-model" class="section level2">
<h2><span class="header-section-number">2.2</span> General formulation of State Space Model</h2>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t&amp;=&amp;\mathbf{A}_t\mathbf{X}_t+\mathbf{v}_t &amp;with\ \mathbf{v}_t\sim MVN(\mathbf{0},\mathbf{R}_t)\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{X}_{t-1} + \mathbf{w}_t &amp;with\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q}_t)
\end{array}
\right.\]</span></p>
<p>with</p>
<ul>
<li><span class="math inline">\(t=1,\ldots, n\)</span></li>
<li>first order Markovian state process <span class="math inline">\(\mathbf{X}_t=(X_{1t}...X_{mt})^T\)</span>,</li>
<li><span class="math inline">\(\mathbf{y}_t=(y_{1t}...y_{pt})^T\)</span></li>
<li><span class="math inline">\(\mathbf{v}_t \perp \!\!\! \perp \mathbf{w}_t\)</span></li>
<li><span class="math inline">\(\mathbf{A}_t\)</span> the <span class="math inline">\(p \times m\)</span> measurement or observation matrix that links <span class="math inline">\(\mathbf{y}_t\)</span> to <span class="math inline">\(\mathbf{X}_t\)</span></li>
<li>an <span class="math inline">\(m \times m\)</span> transition matrix <span class="math inline">\(\boldsymbol{\Phi}_t\)</span> and</li>
</ul>
<p><br /></p>
<p>Note, that the State Space Model is very flexible!</p>
<ul>
<li><p>By embedding the AR(1) structure in the measurement equation, the time series model becomes much more general.</p></li>
<li><p>When <span class="math inline">\(\mathbf{v}_t\)</span> and <span class="math inline">\(\mathbf{w}_t\)</span> are allowed to be correlated, it can be shown that for specific choices the state-space model can also model specific ARMA models.</p></li>
<li><p>Extensions are very flexible: e.g. </p>
<ul>
<li>missing data,</li>
<li>exogeneous covariates,</li>
<li>more complex autocorrelation structures</li>
<li>…</li>
</ul></li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="prediction-filtering-smoothing" class="section level2">
<h2><span class="header-section-number">2.3</span> Prediction, Filtering &amp; Smoothing</h2>
<ul>
<li><p>From a practical view, a primary aim of the state-space analysis is to produce estimates of the states <span class="math inline">\(\mathbf{X}_t\)</span> by using a set of observations <span class="math inline">\(\mathbf{Y}_r=(\mathbf{y}_1,\ldots, \mathbf{y}_r)^T\)</span>.</p></li>
<li><p>Indeed we want to infer on the underlying latent price level!</p></li>
<li><p>The estimation of <span class="math inline">\(\mathbf{X}_t\)</span> given <span class="math inline">\(\mathbf{Y}_r\)</span> is referred to as</p>
<ol style="list-style-type: decimal">
<li>prediction for <span class="math inline">\(t&gt;r\)</span>,</li>
<li>filtering for <span class="math inline">\(t=r\)</span>, and</li>
<li>smoothing for <span class="math inline">\(t&lt;r\)</span></li>
</ol></li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="kalman-filter-and-smoother" class="section level2">
<h2><span class="header-section-number">2.4</span> Kalman Filter and Smoother</h2>
<div id="cryptocurrency-example-1" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Cryptocurrency example</h3>
<p><span class="math display">\[
\begin{array}{ccccccccccc}\ldots &amp; \rightarrow &amp; \mathbf{X}_{t-2} &amp; \rightarrow &amp; \mathbf{X}_{t-1} &amp; \rightarrow &amp; \mathbf{X}_t &amp; \rightarrow &amp; \mathbf{X}_{t+1} &amp; \rightarrow &amp; \ldots\\
&amp;&amp;\downarrow&amp;&amp;\downarrow&amp;&amp;\downarrow&amp;&amp;\downarrow\\
\ldots &amp;  &amp; \mathbf{y}_{t-2} &amp; &amp; \mathbf{y}_{t-1} &amp;  &amp; \mathbf{y}_t &amp; &amp; \mathbf{y}_{t+1} &amp;  &amp; \ldots\\\\
\end{array}
\]</span></p>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t&amp;=&amp;\mathbf{X}_t+\mathbf{v}_t &amp;\text{with}\ \mathbf{v}_t\sim MVN(\mathbf{0},\mathbf{R})\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi} \mathbf{X}_{t-1} + \mathbf{w}_t &amp;\text{with}\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q})
\end{array}
\right.
\]</span></p>
<p>So in our example <span class="math inline">\(\mathbf{A}_t=\mathbf{I}\)</span></p>
<hr />
<p><br /></p>
<div id="kalman-filter" class="section level4">
<h4><span class="header-section-number">2.4.1.1</span> Kalman Filter</h4>
<ul>
<li><p>Important for e.g. online estimation and prediction</p></li>
<li><p>Let <span class="math inline">\(\mathbf{Y}_r=(\mathbf{y}_1^T,\ldots,\mathbf{y}_r^T)^T\)</span><br />
</p></li>
<li><p>Prediction step: <span class="math display">\[\text{E}\left[\mathbf{X}_t\vert \mathbf{Y}_{t-1}\right]\]</span></p></li>
<li><p>Update step when new observation comes in: <span class="math display">\[\text{E}\left[\mathbf{X}_t\vert \mathbf{Y}_{t}\right]\]</span></p></li>
<li><p>Provides efficient factorisation of the likelihood</p></li>
</ul>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>y &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">ends_with</span>(<span class="st">&quot;_prices_usd&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="st">  </span>log10 <span class="op">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="st">  </span>as.matrix</span>
<span id="cb35-5"><a href="#cb35-5"></a></span>
<span id="cb35-6"><a href="#cb35-6"></a>num &lt;-<span class="st"> </span><span class="kw">nrow</span>(y)</span>
<span id="cb35-7"><a href="#cb35-7"></a></span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="co"># Measurement matrix A = I </span></span>
<span id="cb35-9"><a href="#cb35-9"></a>A=<span class="kw">diag</span>(<span class="dv">3</span>)  <span class="co"># creates 3x3 diagonal matrix</span></span>
<span id="cb35-10"><a href="#cb35-10"></a></span>
<span id="cb35-11"><a href="#cb35-11"></a><span class="co"># initial values</span></span>
<span id="cb35-12"><a href="#cb35-12"></a>mu0 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">1</span>)</span>
<span id="cb35-13"><a href="#cb35-13"></a>Sigma0 &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>,.<span class="dv">1</span>,.<span class="dv">1</span>),<span class="dv">3</span>)</span>
<span id="cb35-14"><a href="#cb35-14"></a>Phi &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>)</span>
<span id="cb35-15"><a href="#cb35-15"></a>cQ &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>,.<span class="dv">1</span>,.<span class="dv">1</span>),<span class="dv">3</span>)</span>
<span id="cb35-16"><a href="#cb35-16"></a>cR &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>,.<span class="dv">1</span>,.<span class="dv">1</span>),<span class="dv">3</span>)</span>
<span id="cb35-17"><a href="#cb35-17"></a></span>
<span id="cb35-18"><a href="#cb35-18"></a>em &lt;-<span class="st"> </span><span class="kw">EM0</span>(<span class="dt">num =</span> num, <span class="dt">y =</span> y, <span class="dt">A =</span> A, <span class="dt">mu0 =</span> mu0, <span class="dt">Sigma0 =</span> Sigma0, <span class="dt">Phi =</span> Phi, <span class="dt">cQ =</span> cQ, <span class="dt">cR =</span> cR, <span class="dt">max.iter =</span> <span class="dv">100</span>, <span class="dt">tol =</span> <span class="fl">.00001</span>)</span>
<span id="cb35-19"><a href="#cb35-19"></a></span>
<span id="cb35-20"><a href="#cb35-20"></a>kf &lt;-<span class="st"> </span><span class="kw">Kfilter0</span>(<span class="dt">num =</span> num, <span class="dt">y =</span> y, <span class="dt">A =</span> A, <span class="dt">mu0 =</span> mu0, <span class="dt">Sigma0 =</span> em<span class="op">$</span>Sigma0, <span class="dt">Phi =</span> em<span class="op">$</span>Phi, <span class="dt">cQ =</span> <span class="kw">chol</span>(em<span class="op">$</span>Q), <span class="dt">cR =</span> <span class="kw">chol</span>(em<span class="op">$</span>R))</span></code></pre></div>
<details>
<summary>Click to see code to make plots </summary>
<p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>dataHlp &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="st">  </span><span class="kw">select</span>(date,<span class="kw">ends_with</span>(<span class="st">&quot;prices_usd&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="st">  </span><span class="kw">gather</span>(coin, usd, <span class="op">-</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xf =</span> kf<span class="op">$</span>xf[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) <span class="op">%&gt;%</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xfll =</span> (kf<span class="op">$</span>xf[,<span class="dv">1</span>,] <span class="op">-</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="st">           </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>ndays,<span class="cf">function</span>(i) kf<span class="op">$</span>Pf[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) <span class="op">%&gt;%</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">xful =</span> (kf<span class="op">$</span>xf[,<span class="dv">1</span>,] <span class="op">+</span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="st">           </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>ndays,<span class="cf">function</span>(i) kf<span class="op">$</span>Pf[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) <span class="op">%&gt;%</span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xp =</span> kf<span class="op">$</span>xp[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) <span class="op">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xpll =</span> (kf<span class="op">$</span>xp[,<span class="dv">1</span>,] <span class="op">-</span></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="st">           </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>ndays,<span class="cf">function</span>(i) kf<span class="op">$</span>Pp[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) <span class="op">%&gt;%</span></span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">xpul =</span> (kf<span class="op">$</span>xp[,<span class="dv">1</span>,] <span class="op">+</span></span>
<span id="cb36-13"><a href="#cb36-13"></a><span class="st">           </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>ndays,<span class="cf">function</span>(i) kf<span class="op">$</span>Pp[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) </span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>tplot &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2020-12-31&quot;</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a>basePlot &lt;-<span class="st"> </span>dataHlp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="st">  </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot) <span class="op">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(date,usd)) <span class="op">+</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>coin,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span>
<span id="cb37-8"><a href="#cb37-8"></a></span>
<span id="cb37-9"><a href="#cb37-9"></a>stopDate &lt;-<span class="st"> </span>dataHlp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(date) <span class="op">%&gt;%</span><span class="st"> </span>max</span>
<span id="cb37-10"><a href="#cb37-10"></a>startDate &lt;-<span class="st"> </span>stopDate <span class="op">-</span><span class="st"> </span><span class="dv">30</span></span>
<span id="cb37-11"><a href="#cb37-11"></a></span>
<span id="cb37-12"><a href="#cb37-12"></a>dataHlp2 &lt;-<span class="st"> </span>dataHlp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-13"><a href="#cb37-13"></a><span class="st">  </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot <span class="op">&amp;</span><span class="st"> </span>date <span class="op">&lt;</span><span class="st"> </span>startDate)</span>
<span id="cb37-14"><a href="#cb37-14"></a></span>
<span id="cb37-15"><a href="#cb37-15"></a>i &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb37-16"><a href="#cb37-16"></a>plotKFilterList &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb37-17"><a href="#cb37-17"></a>  basePlot <span class="op">+</span></span>
<span id="cb37-18"><a href="#cb37-18"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape=</span><span class="dv">21</span>,<span class="dt">size=</span>.<span class="dv">5</span>, <span class="dt">data =</span> dataHlp2) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-19"><a href="#cb37-19"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">10</span><span class="op">^</span>xful,<span class="dt">ymax =</span> <span class="dv">10</span><span class="op">^</span>xfll), <span class="dt">alpha =</span> <span class="fl">0.45</span>, <span class="dt">data =</span> dataHlp2) <span class="op">+</span></span>
<span id="cb37-20"><a href="#cb37-20"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xf), <span class="dt">data =</span> dataHlp2) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-21"><a href="#cb37-21"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot; &quot;</span>) </span>
<span id="cb37-22"><a href="#cb37-22"></a>  )</span>
<span id="cb37-23"><a href="#cb37-23"></a></span>
<span id="cb37-24"><a href="#cb37-24"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="kw">seq</span>(startDate,stopDate,<span class="dv">1</span>))</span>
<span id="cb37-25"><a href="#cb37-25"></a>{</span>
<span id="cb37-26"><a href="#cb37-26"></a>dataHlp2 &lt;-<span class="st"> </span>dataHlp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-27"><a href="#cb37-27"></a><span class="st">  </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot <span class="op">&amp;</span><span class="st"> </span>date <span class="op">&lt;</span><span class="st"> </span>t)</span>
<span id="cb37-28"><a href="#cb37-28"></a>i &lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span> </span>
<span id="cb37-29"><a href="#cb37-29"></a>plotKFilterList[[i]] &lt;-<span class="st"> </span>basePlot <span class="op">+</span></span>
<span id="cb37-30"><a href="#cb37-30"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape=</span><span class="dv">21</span>,<span class="dt">size=</span>.<span class="dv">5</span>, <span class="dt">data =</span> dataHlp2) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-31"><a href="#cb37-31"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">10</span><span class="op">^</span>xful,<span class="dt">ymax =</span> <span class="dv">10</span><span class="op">^</span>xfll), <span class="dt">alpha =</span> <span class="fl">0.45</span>, <span class="dt">data =</span> dataHlp2) <span class="op">+</span></span>
<span id="cb37-32"><a href="#cb37-32"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xf), <span class="dt">data =</span> dataHlp2) <span class="op">+</span></span>
<span id="cb37-33"><a href="#cb37-33"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xp),<span class="dt">data =</span> dataHlp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t),<span class="dt">color=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb37-34"><a href="#cb37-34"></a><span class="st">   </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> <span class="dv">10</span><span class="op">^</span>xpll, <span class="dt">xend =</span> date, <span class="dt">yend =</span> <span class="dv">10</span><span class="op">^</span>xpul), <span class="dt">color =</span> <span class="dv">2</span>, <span class="dt">data =</span> dataHlp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t)) <span class="op">+</span></span>
<span id="cb37-35"><a href="#cb37-35"></a><span class="st">   </span><span class="kw">ggtitle</span>(<span class="st">&quot;Prediction&quot;</span>)</span>
<span id="cb37-36"><a href="#cb37-36"></a></span>
<span id="cb37-37"><a href="#cb37-37"></a>i &lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span> </span>
<span id="cb37-38"><a href="#cb37-38"></a>plotKFilterList[[i]] &lt;-<span class="st"> </span>plotKFilterList[[i<span class="dv">-1</span>]] <span class="op">+</span></span>
<span id="cb37-39"><a href="#cb37-39"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date,usd),<span class="dt">data =</span> dataHlp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-40"><a href="#cb37-40"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;New observation arrives&quot;</span>)</span>
<span id="cb37-41"><a href="#cb37-41"></a></span>
<span id="cb37-42"><a href="#cb37-42"></a>i &lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb37-43"><a href="#cb37-43"></a>dataHlp2 &lt;-<span class="st"> </span>dataHlp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb37-44"><a href="#cb37-44"></a><span class="st">  </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot <span class="op">&amp;</span><span class="st"> </span>date <span class="op">&lt;=</span><span class="st"> </span>t)</span>
<span id="cb37-45"><a href="#cb37-45"></a>plotKFilterList[[i]] &lt;-<span class="st">   </span>basePlot <span class="op">+</span></span>
<span id="cb37-46"><a href="#cb37-46"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape=</span><span class="dv">21</span>,<span class="dt">size=</span>.<span class="dv">5</span>, <span class="dt">data =</span> dataHlp2) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-47"><a href="#cb37-47"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">10</span><span class="op">^</span>xful,<span class="dt">ymax =</span> <span class="dv">10</span><span class="op">^</span>xfll), <span class="dt">alpha =</span> <span class="fl">0.45</span>, <span class="dt">data =</span> dataHlp2) <span class="op">+</span></span>
<span id="cb37-48"><a href="#cb37-48"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xf), <span class="dt">data =</span> dataHlp2) <span class="op">+</span><span class="st"> </span></span>
<span id="cb37-49"><a href="#cb37-49"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xp),<span class="dt">data =</span> dataHlp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t),<span class="dt">color=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb37-50"><a href="#cb37-50"></a><span class="st">  </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> <span class="dv">10</span><span class="op">^</span>xpll, <span class="dt">xend =</span> date, <span class="dt">yend =</span> <span class="dv">10</span><span class="op">^</span>xpul), <span class="dt">color =</span> <span class="dv">2</span>, <span class="dt">data =</span> dataHlp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t)) <span class="op">+</span></span>
<span id="cb37-51"><a href="#cb37-51"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date,usd),<span class="dt">data =</span> dataHlp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t)) <span class="op">+</span></span>
<span id="cb37-52"><a href="#cb37-52"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Update Filter&quot;</span>) </span>
<span id="cb37-53"><a href="#cb37-53"></a>}</span></code></pre></div>
</p>
</details>
<p><img src="index_files/figure-html/unnamed-chunk-25-.gif" width="672" /></p>
</div>
<div id="kalman-smoother" class="section level4">
<h4><span class="header-section-number">2.4.1.2</span> Kalman Smoother</h4>
<ul>
<li>Offline applications: Use all available information <span class="math inline">\(\mathbf{Y}_N=(\mathbf{y}_1^T,\ldots,\mathbf{y}_n^T)^T\)</span>.</li>
<li>Smoothed estimator also based on measurements on later time instants <span class="math inline">\(t+1,\ldots,n\)</span>: <span class="math inline">\(\text{E}\left[\mathbf{X}_t\vert \mathbf{Y}_N\right]\)</span></li>
</ul>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>ks &lt;-<span class="st"> </span><span class="kw">Ksmooth0</span>(<span class="dt">num =</span> num, <span class="dt">y =</span> y, <span class="dt">A =</span> A, <span class="dt">mu0 =</span> mu0, <span class="dt">Sigma0 =</span> em<span class="op">$</span>Sigma0, <span class="dt">Phi =</span> em<span class="op">$</span>Phi, <span class="dt">cQ =</span> <span class="kw">chol</span>(em<span class="op">$</span>Q), <span class="dt">cR =</span> <span class="kw">chol</span>(em<span class="op">$</span>R))</span></code></pre></div>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>tplot &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2020-12-31&quot;</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a>basePlot &lt;-<span class="st"> </span>dataHlp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="st">  </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot) <span class="op">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(date,usd)) <span class="op">+</span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>coin,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span>
<span id="cb39-8"><a href="#cb39-8"></a></span>
<span id="cb39-9"><a href="#cb39-9"></a>dataHlp2 &lt;-<span class="st"> </span>dataHlp  <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xs =</span> ks<span class="op">$</span>xs[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) <span class="op">%&gt;%</span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">xsll =</span> (ks<span class="op">$</span>xs[,<span class="dv">1</span>,] <span class="op">-</span></span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="st">           </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>ndays,<span class="cf">function</span>(i) ks<span class="op">$</span>Ps[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c) <span class="op">%&gt;%</span></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">xsul =</span> (ks<span class="op">$</span>xs[,<span class="dv">1</span>,] <span class="op">+</span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="st">           </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>ndays,<span class="cf">function</span>(i) ks<span class="op">$</span>Pf[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c)</span>
<span id="cb39-15"><a href="#cb39-15"></a></span>
<span id="cb39-16"><a href="#cb39-16"></a></span>
<span id="cb39-17"><a href="#cb39-17"></a>plotKFilterPrediction &lt;-<span class="st"> </span>basePlot <span class="op">+</span></span>
<span id="cb39-18"><a href="#cb39-18"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape=</span><span class="dv">21</span>,<span class="dt">size=</span>.<span class="dv">5</span>, <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb39-19"><a href="#cb39-19"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">10</span><span class="op">^</span>xpul,<span class="dt">ymax =</span> <span class="dv">10</span><span class="op">^</span>xpll), <span class="dt">alpha =</span> <span class="fl">0.45</span>, <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span></span>
<span id="cb39-20"><a href="#cb39-20"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xp), <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb39-21"><a href="#cb39-21"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Kalman one-step-ahead prediction&quot;</span>) </span>
<span id="cb39-22"><a href="#cb39-22"></a></span>
<span id="cb39-23"><a href="#cb39-23"></a>plotKFilter &lt;-<span class="st"> </span>basePlot <span class="op">+</span></span>
<span id="cb39-24"><a href="#cb39-24"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape=</span><span class="dv">21</span>,<span class="dt">size=</span>.<span class="dv">5</span>, <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb39-25"><a href="#cb39-25"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">10</span><span class="op">^</span>xful,<span class="dt">ymax =</span> <span class="dv">10</span><span class="op">^</span>xfll), <span class="dt">alpha =</span> <span class="fl">0.45</span>, <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span></span>
<span id="cb39-26"><a href="#cb39-26"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xf), <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb39-27"><a href="#cb39-27"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Kalman filter&quot;</span>) </span>
<span id="cb39-28"><a href="#cb39-28"></a></span>
<span id="cb39-29"><a href="#cb39-29"></a>plotKSmoother &lt;-<span class="st"> </span>basePlot <span class="op">+</span></span>
<span id="cb39-30"><a href="#cb39-30"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">shape=</span><span class="dv">21</span>,<span class="dt">size=</span>.<span class="dv">5</span>, <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb39-31"><a href="#cb39-31"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> <span class="dv">10</span><span class="op">^</span>xsul,<span class="dt">ymax =</span> <span class="dv">10</span><span class="op">^</span>xsll), <span class="dt">alpha =</span> <span class="fl">0.45</span>, <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span></span>
<span id="cb39-32"><a href="#cb39-32"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date,<span class="dv">10</span><span class="op">^</span>xs), <span class="dt">data =</span> dataHlp2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;</span><span class="st"> </span>tplot)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb39-33"><a href="#cb39-33"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Kalman smoother&quot;</span>) </span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>plotKFilterPrediction</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>plotKFilter</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>plotKSmoother</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-28-.gif" width="672" /></p>
<hr />
<p><br /></p>
</div>
</div>
<div id="under-the-hood-of-the-kalman-filter" class="section level3">
<h3><span class="header-section-number">2.4.2</span> Under the hood of the Kalman Filter</h3>
<p>General formulation of the State Space Model</p>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t&amp;=&amp;\mathbf{A}_t\mathbf{X}_t+\mathbf{v}_t &amp;with\ \mathbf{v}_t\sim MVN(\mathbf{0},\mathbf{R}_t)\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{X}_{t-1} + \mathbf{w}_t &amp;with\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q}_t)
\end{array}
\right.\]</span></p>
<p>Assume that following are known</p>
<ul>
<li><span class="math inline">\(\mathbf{Y}_{t-1}=(\mathbf{y}_1^T,\ldots,\mathbf{y}_{t-1}^T)^T\)</span></li>
<li><span class="math inline">\(\mathbf{X}_{t-1\vert t-1}=\text{E}\left[\mathbf{X}_{t-1}\vert \mathbf{Y}_{t-1}\right]\)</span></li>
<li><span class="math inline">\(\mathbf{P}_{t-1\vert t-1}=\text{Var}\left[\mathbf{X}_{t-1}\vert \mathbf{Y}_{t-1}\right]\)</span></li>
</ul>
<hr />
<p><br /></p>
<div id="prediction-step" class="section level4">
<h4><span class="header-section-number">2.4.2.1</span> Prediction Step</h4>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t&amp;=&amp;\mathbf{A}_t\mathbf{X}_t+\mathbf{v}_t &amp;with\ \mathbf{v}_t\sim MVN(\mathbf{0},\mathbf{R}_t)\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{X}_{t-1} + \mathbf{w}_t &amp;with\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q}_t)
\end{array}
\right.\]</span></p>
<p><br /></p>
<p><span class="math display">\[
\begin{array}{rcl}
\mathbf{X}_t\vert\mathbf{Y}_{t-1}&amp;\sim&amp; MVN(\mathbf{X}_{t\vert t-1}, \mathbf{P}_{t\vert t-1})\\\\
\mathbf{X}_{t\vert t-1}&amp;=&amp;\text{E}\left[\mathbf{X}_t\vert\mathbf{Y}_{t-1}\right]\\&amp;=&amp;\boldsymbol{\Phi}_t\text{E}\left[\mathbf{X}_{t-1}\vert\mathbf{Y}_{t-1}\right]\\
&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{X}_{t-1\vert t-1}\\\\
\mathbf{P}_{t\vert t-1}&amp;=&amp;\text{Var}\left[\mathbf{X}_t\vert\mathbf{Y}_{t-1}\right] \\&amp;=&amp; \boldsymbol{\Phi}_t \text{Var}\left[\mathbf{X}_{t-1}\vert\mathbf{Y}_{t-1}\right]  \boldsymbol{\Phi}_t^T+\text{Var}\left[\mathbf{w}_t\vert \mathbf{Y}_{t-1}\right]\\
&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{P}_{t-1\vert t-1} \boldsymbol{\Phi}_t^T+\mathbf{Q}_t.
 \end{array}
\]</span></p>
<p>One step ahead prediction: <span class="math display">\[\text{E}\left[\mathbf{y}_{t}\vert \mathbf{Y}_{t-1}\right]=\mathbf{A}_t\mathbf{X}_{t\vert t-1}\]</span></p>
<hr />
<p><br /></p>
</div>
<div id="update-step" class="section level4">
<h4><span class="header-section-number">2.4.2.2</span> Update Step</h4>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t&amp;=&amp;\mathbf{A}_t\mathbf{X}_t+\mathbf{v}_t &amp;with\ \mathbf{v}_t\sim MVN(\mathbf{0},\mathbf{R}_t)\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{X}_{t-1} + \mathbf{w}_t &amp;with\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q}_t)
\end{array}
\right.\]</span></p>
<p><br /></p>
<p>If observation <span class="math inline">\(\mathbf{y}_t\)</span> at time <span class="math inline">\(t\)</span> becomes available</p>
<p><span class="math display">\[
\begin{array}{rcl}
\mathbf{X}_t\vert\mathbf{Y}_{t-1}&amp;\sim&amp; MVN(\mathbf{X}_{t\vert t}, \mathbf{P}_{t\vert t})\\\\
\mathbf{X}_{t\vert t}&amp;=&amp;\text{E}\left[\mathbf{X}_t\vert \mathbf{Y}_{t}\right]\\
&amp;=&amp;\text{E}\left[\mathbf{X}_t\vert \mathbf{Y}_{t-1}, \boldsymbol{y}_t\right]\\\\
\mathbf{P}_{t\vert t} &amp;=&amp; \text{Var}\left[\mathbf{X}_t\vert\mathbf{Y}_t\right]\\
&amp;=&amp;\text{Var}\left[\mathbf{X}_t\vert\mathbf{Y}_{t-1},\mathbf{y}_t\right]
\end{array}
\]</span></p>
<p>Exploit that <span class="math inline">\(\mathbf{X}_t\)</span> and <span class="math inline">\(\mathbf{y}_t\)</span> given <span class="math inline">\(\mathbf{Y}_{t-1}\)</span> are multivariate normally distributed! <span class="math display">\[\left.\begin{bmatrix}
\mathbf{X}_t\\
\mathbf{y}_t
\end{bmatrix} \right\vert \mathbf{Y}_{t-1}  \sim MVN\left(\begin{bmatrix}
\mathbf{X}_{t\vert t-1}\\
\mathbf{A}_{t}\mathbf{X}_{t\vert t-1}
\end{bmatrix}, \begin{bmatrix}
\mathbf{P}_{t\vert t-1}&amp;\mathbf{P}_{t\vert t-1}\mathbf{A}_{t}^T\\
\mathbf{A}_{t} \mathbf{P}_{t\vert t-1}&amp;\boldsymbol{\Sigma}_t
\end{bmatrix}\right)
\]</span></p>
<p>With</p>
<p><span class="math display">\[\begin{array}{lcl}
\boldsymbol{\Sigma}_t=\text{Var}\left[\mathbf{y}_t\vert \mathbf{Y}_{t-1}\right]&amp;=&amp;\text{Var}\left[\mathbf{A}_t\mathbf{X}_t+\mathbf{v}_t\vert\mathbf{Y}_{t-1}\right]\\&amp;=&amp;\mathbf{A}_t\text{Var}\left[\mathbf{X}_t\vert \mathbf{Y}_{t-1}\right]\mathbf{A}_t^T+\text{Var}\left[\mathbf{v}_t\right]\\
&amp;=&amp;\mathbf{A}_t \mathbf{P}_{t\vert t-1} \mathbf{A}_t^T + \mathbf{R}_t
\end{array}\]</span></p>
<p>It can be shown that <span class="math inline">\(\mathbf{X}_t\vert \mathbf{Y}_t\)</span> is the Best Linear Unbiased Predictor BLUP by exploiting the conditional expectation for jointly multivariate normal data (See <a href="https://en.wikipedia.org/wiki/Multivariate_normal_distribution#Conditional_distributions">wikipedia</a> ).</p>
<p><span class="math display">\[
\begin{array}{rcl}
\text{E}\left[\mathbf{X}_t\vert\mathbf{Y}_{t-1},\mathbf{y}_t\right]
&amp;=&amp;\text{E}\left[\mathbf{X}_t\vert \mathbf{Y}_{t-1}\right]+\text{Cov}\left[\mathbf{X}_t,\mathbf{y}_t\vert\mathbf{Y}_{t-1}\right]\text{Var}\left[\mathbf{y}_t\vert\mathbf{Y}_{t-1}\right]^{-1}\left(\mathbf{y}_t-\mathbf{A}_t\mathbf{X}_{t\vert t-1
}\right),\\
\mathbf{X}_{t\vert t}&amp;=&amp;\mathbf{X}_{t\vert t-1}+\mathbf{P}_{t\vert t-1} \mathbf{A}_t^T\boldsymbol{\Sigma}_t^{-1}\left(\mathbf{y}_t-\mathbf{A}_t\mathbf{X}_{t\vert t-1
}\right),
\end{array}
\]</span></p>
<p>and</p>
<p><span class="math display">\[
\begin{array}{rcl}
\text{Var}\left[\mathbf{X}_t\vert\mathbf{Y}_{t-1},\mathbf{y}_t\right]&amp;=&amp;\text{Var}\left[\mathbf{X}_t\vert\mathbf{Y}_{t-1}\right]-\text{Cov}\left[\mathbf{X}_t,\mathbf{y}_t\vert\mathbf{Y}_{t-1}\right]\text{Var}\left[\mathbf{y}_t\vert\mathbf{Y}_{t-1}\right]^{-1}\text{Cov}\left[\mathbf{X}_t,\mathbf{y}_t\vert\mathbf{Y}_{t-1}\right]^T\\
\mathbf{P}_{t\vert t}&amp;=&amp;\mathbf{P}_{t\vert t-1}-\mathbf{P}_{t\vert t-1} \mathbf{A}_t^T \boldsymbol{\Sigma}_t^{-1} \mathbf{A}_t \mathbf{P}_{t\vert t-1},
\end{array}
\]</span></p>
<p>Note, that prediction error / innovation: <span class="math display">\[\boldsymbol{\epsilon}_t =\mathbf{y}_t-\mathbf{A}_t\mathbf{X}_{t\vert t-1}\]</span></p>
<ul>
<li><span class="math inline">\(\boldsymbol{\epsilon}_t\ \perp \!\!\! \perp \ \mathbf{y}_r\)</span> for all <span class="math inline">\(r=1,\ldots,t-1\)</span></li>
<li><span class="math display">\[\boldsymbol{\epsilon}_t \sim \text{MVN}\left(\mathbf{0},\boldsymbol{\Sigma
}_t\right)\]</span></li>
<li>innovations are key to use Kalman Filter for decomposition of the likelihood.</li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="summary-kalman-filter" class="section level4">
<h4><span class="header-section-number">2.4.2.3</span> Summary Kalman Filter</h4>
<p>If <span class="math inline">\(\mathbf{X}_{0\vert 0}\)</span> and <span class="math inline">\(\mathbf{P}_{0\vert 0}\)</span> are known, then the Kalman filter becomes:</p>
<p>for <span class="math inline">\(t=1,\ldots, n\)</span></p>
<ol style="list-style-type: decimal">
<li>Prediction step</li>
</ol>
<p><span class="math display">\[
\begin{array}{rcl}
\mathbf{X}_{t\vert t-1}&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{X}_{t-1\vert t-1} \\\\
\mathbf{P}_{t\vert t-1}&amp;=&amp;\boldsymbol{\Phi}_t \mathbf{P}_{t-1\vert t-1} \boldsymbol{\Phi}_t^T + \mathbf{Q}_t.
\end{array}
\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>Update step <span class="math display">\[
\begin{array}{rcl}
\mathbf{X}_{t\vert t}&amp;=&amp;\mathbf{X}_{t\vert t-1}+ \mathbf{P}_{t\vert t-1}  \mathbf{A}_t^T \boldsymbol{\Sigma}_t^{-1} (\mathbf{y}_t - \mathbf{A}_t \mathbf{X}_{t\vert t-1} )\\\\
\mathbf{P}_{t\vert t}&amp;=&amp;\mathbf{P}_{t\vert t-1}-\mathbf{P}_{t\vert t-1} \mathbf{A}_t^T \boldsymbol{\Sigma}_t^{-1} \mathbf{A}_t \mathbf{P}_{t\vert t-1}\\\\
\boldsymbol{\Sigma}_t&amp;=&amp;\mathbf{A}_t \mathbf{P}_{t\vert t-1} \mathbf{A}_t^T + \mathbf{R}_t.
\end{array}
\]</span></li>
</ol>
<hr />
<p><br /></p>
</div>
</div>
<div id="under-the-hood-of-the-kalman-smoother" class="section level3">
<h3><span class="header-section-number">2.4.3</span> Under the hood of the Kalman Smoother</h3>
<ul>
<li><p><span class="math inline">\(\text{E}\left[\mathbf{X}_t\vert \mathbf{Y}_N\right]\)</span></p></li>
<li><p>Start with the final quantities, <span class="math inline">\(\mathbf{X}_{n\vert n}\)</span> and <span class="math inline">\(\mathbf{P}_{n\vert n}\)</span> and proceeds backwards.</p></li>
<li><p>For <span class="math inline">\(t=n-1, \ldots, 0\)</span>, it consists of the following backward recursions</p></li>
</ul>
<p><span class="math display">\[\begin{align}
&amp;\mathbf{X}_{t\vert n}=\mathbf{X}_{t\vert t}+\mathbf{J}_t(\mathbf{X}_{t+1\vert n}-\mathbf{X}_{t+1\vert t}) \label{SS_B1} \\
&amp;\mathbf{P}_{t\vert n}=\mathbf{P}_{t\vert t}+\mathbf{J}_{t}(\mathbf{P}_{t+1\vert n}-\mathbf{P}_{t+1\vert t})\mathbf{J}_t^{T} \label{SS_B2}\\
&amp;\mathbf{J}_t=\mathbf{P}_{t\vert t}\Phi_{t+1}^T\mathbf{P}_{t+1\vert t}^{-1}. \label{SS_B3}
\end{align}\]</span></p>
<p><img src="index_files/figure-html/unnamed-chunk-29-.gif" width="672" /></p>
<hr />
<p><br /></p>
</div>
</div>
<div id="parameter-estimation" class="section level2">
<h2><span class="header-section-number">2.5</span> Parameter Estimation</h2>
<div id="likelihood-and-the-prediction-error-decomposition" class="section level3">
<h3><span class="header-section-number">2.5.1</span> Likelihood and the prediction error decomposition</h3>
<p>Classical iid setting, <span class="math display">\[\begin{equation*}
\log L_{\mathbf{Y_N}}(\boldsymbol{\Psi})=\sum\limits_{t=1}^n \log p(\mathbf{y_t}), 
\end{equation*}\]</span> Not possible for dependent observations. State-space model allows factorisation using conditional density functions <span class="math display">\[\begin{equation*}
\log L_{\mathbf{Y}_N}(\boldsymbol{\Psi})=\sum\limits_{t=1}^n\log p(\mathbf{y}_t\vert \mathbf{Y}_{t-1})
\end{equation*}\]</span> <span class="math display">\[\mathbf{y}_t\vert\mathbf{Y}_{t-1}\sim MVN(\mathbf{A}_t \mathbf{X}_{t\vert t-1},\boldsymbol{\Sigma}_t)\]</span> <span class="math display">\[\begin{equation*}
\log L_{\mathbf{Y}_N}(\boldsymbol{\Psi})=-\frac{pn}{2}\log 2 \pi - \frac{1}{2} \sum\limits_{t=1}^n \log \vert \boldsymbol{\Sigma}_t\vert -\frac{1}{2} \sum\limits_{t=1}^n \boldsymbol{\epsilon}_t^T \boldsymbol{\Sigma}_t^{-1} \boldsymbol{\epsilon}_t,
 \end{equation*}\]</span></p>
<p>Which can be efficiently calculated by the Kalman filter and can thus be used to estimate the model parameters.</p>
<hr />
<p><br /></p>
</div>
<div id="maximum-likelihood" class="section level3">
<h3><span class="header-section-number">2.5.2</span> Maximum Likelihood</h3>
<ul>
<li>Numerical optimisation of likelihood (often troublesome):
<ol style="list-style-type: decimal">
<li>Choose initial values for the parameters</li>
<li>Run Kalman Filter and calculate likelihood</li>
<li>Run one iteration of Newton-Raphson with the -2 log likelihood as criterion</li>
<li>Repeat steps 2-3 with the current Newton-Raphson parameter estimates until convergence.</li>
</ol></li>
</ul>
<p><br /></p>
<ul>
<li>For time invariant system: EM algorithm (often slow)</li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="em-algorithm" class="section level3">
<h3><span class="header-section-number">2.5.3</span> EM algorithm</h3>
<div id="complete-likelihood-of-mathbfx-and-mathbfy" class="section level4">
<h4><span class="header-section-number">2.5.3.1</span> Complete likelihood of <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(\mathbf{Y}\)</span></h4>
<p><span class="math display">\[\begin{multline*}
\log L_{\mathbf{Y},\mathbf{X}}(\boldsymbol{\Psi}) \sim -\frac{1}{2} \log|\boldsymbol{\Sigma}_{0}| -\frac{1}{2} (\mathbf{X}_0-\boldsymbol{\mu}_0)^T \boldsymbol{\Sigma}_{0}^{-1} (\mathbf{X}_0-\boldsymbol{\mu}_0)\\
    -\frac{n}{2} \log |\mathbf{Q}|-\frac{1}{2}\sum_{t=1}^n (\mathbf{X}_t-\boldsymbol{\Phi X}_{t-1})^T \mathbf{Q}^{-1}(\mathbf{X}_t-\boldsymbol{\Phi X}_{t-1})\\    
    -\frac{n}{2} \log|\mathbf{R}| -\frac{1}{2} \sum_{t=1}^n (\mathbf{Y}_t-\mathbf{A}_t\mathbf{X}_t)^T\mathbf{R}^{-1}(\mathbf{Y}_t-\mathbf{A}_t\mathbf{X}_t),
\end{multline*}\]</span></p>
<ul>
<li>Cannot be calculated: state is unobservable</li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="em-algorithm-1" class="section level4">
<h4><span class="header-section-number">2.5.3.2</span> EM algorithm</h4>
<ol style="list-style-type: decimal">
<li><p>E-step: <span class="math inline">\(Q(\boldsymbol{\Psi}, \boldsymbol{\Psi}^k) = \text{E}\left[-2\log L_{\mathbf{Y},\mathbf{X}}(\boldsymbol{\Psi}) \vert \mathbf{Y}_N, \boldsymbol{\Psi}^k\right]\)</span></p></li>
<li><p>M-step: Minimise <span class="math inline">\(Q(\boldsymbol{\Psi}, \boldsymbol{\Psi}^k)\)</span> to obtain the update of the parameter set <span class="math inline">\(\boldsymbol{\Psi}^{k+1}\)</span>.</p></li>
<li><p>Repeate 1-2 until convergence</p></li>
</ol>
<p>Before we derive the algorithm we first introduce the lag one covariance estimators</p>
<p><span class="math display">\[\mathbf{P}_{t,t-1\vert r}=\text{cov}\left[\mathbf{X}_t,\mathbf{X}_{t-1}\vert \mathbf{Y}_r\right]\]</span>.</p>
<ul>
<li><p>Filtered values <span class="math display">\[\begin{equation}
\mathbf{P}_{t,t-1\vert t}=(\mathbf{I}-\mathbf{P}_{t\vert t-1}\mathbf{A}_t^T\boldsymbol{\Sigma}_t^{-1}\mathbf{A}_t)\boldsymbol{\Phi}_t\mathbf{P}_{t-1\vert t-1}, \label{SS_F6}
\end{equation}\]</span></p></li>
<li><p>smoothed values <span class="math display">\[\begin{equation}
\mathbf{P}_{t,t-1\vert n}=\mathbf{P}_{t,t-1\vert t}+(\mathbf{P}_{t\vert n}-\mathbf{P}_{t\vert t})\mathbf{P}_{t\vert t}^{-1}\mathbf{P}_{t,t-1\vert t}. \label{SS_B4}
\end{equation}\]</span></p></li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="em-algorithm-e-step" class="section level4">
<h4><span class="header-section-number">2.5.3.3</span> EM-algorithm: E-step</h4>
<p><span class="math display">\[\begin{multline*}
Q(\boldsymbol{\Psi}, \boldsymbol{\Psi}^k) \sim \text{E}\left[ \log|\boldsymbol{\Sigma}_{0}| + (\mathbf{X}_0-\boldsymbol{\mu}_{0})^T \boldsymbol{\Sigma}_{0}^{-1} (\mathbf{X}_0-\boldsymbol{\mu}_{0})\vert \mathbf{Y}_N, \boldsymbol{\Psi}^k\right]\\\\
    +\text{E}\left[n \log |\mathbf{Q}|+\sum_{t=1}^n (\mathbf{X}_t-\boldsymbol{\Phi X}_{t-1})^T \mathbf{Q}^{-1}(\mathbf{X}_t-\boldsymbol{\Phi X}_{t-1})\vert \mathbf{Y}_N, \boldsymbol{\Psi}^k\right]\\\\    
    +\text{E}\left[n \log|\mathbf{R}| + \sum_{t=1}^n (\mathbf{Y}_t-\mathbf{A}_t\mathbf{X}_t)^T\mathbf{R}^{-1}(\mathbf{Y}_t-\mathbf{A}_t\mathbf{X}_t)\vert \mathbf{Y}_N, \boldsymbol{\Psi}^k\right]
\end{multline*}\]</span></p>
<p><span class="math display">\[ \quad \]</span></p>
<p><span class="math display">\[\begin{multline*}
Q(\boldsymbol{\Psi}, \boldsymbol{\Psi}^k)\sim \log|\boldsymbol{\Sigma}_{0}| + \text{tr}\left[
\boldsymbol{\Sigma}_{0}^{-1} \left \lbrace \mathbf{P}_{0\vert n} + (\mathbf{X}_{0\vert n}- \boldsymbol{\mu}_{0})(\mathbf{X}_{0\vert n}- \boldsymbol{\mu}_{0})^T\right\rbrace\right]\\\\
+n \log |\mathbf{Q}| + \text{tr}\left[ \mathbf{Q^{-1}}\left\lbrace\mathbf{S}_{11} - \mathbf{S}_{10}\boldsymbol{\Phi}^T-\boldsymbol{\Phi} \mathbf{S}_{10}^T+\boldsymbol{\Phi} \mathbf{S}_{00} \boldsymbol{\Phi}^T\right\rbrace\right]\\\\+n\log |\mathbf{R}|
+ \text{tr}\left[\mathbf{R^{-1}}\sum\limits_{t=1}^n \left\lbrace(\mathbf{y}_t-\mathbf{A}_t \mathbf{X}_{t\vert n})(\mathbf{y}_t-\mathbf{A}_t\mathbf{X}_{t\vert n})^T+\mathbf{A}_t\mathbf{P}_{t\vert n} \mathbf{A}_t^T\right\rbrace\right],
\end{multline*}\]</span></p>
<p>with <span class="math display">\[\begin{align*}
\mathbf{S}_{11}&amp;=\sum\limits_{t=1}^n (\mathbf{X}_{t\vert n} \mathbf{X}_{t\vert n}^T + \mathbf{P}_{t\vert n})\\
\mathbf{S}_{10}&amp;=\sum\limits_{t=1}^n (\mathbf{X}_{t\vert n}\mathbf{X}_{t-1\vert n}^T + \mathbf{P}_{t,t-1\vert n})\\
\mathbf{S}_{00}&amp;=\sum\limits_{t=1}^n (\mathbf{X}_{t-1\vert n} \mathbf{X}_{t-1\vert n}^T + \mathbf{P}_{t-1\vert n})\\
\end{align*}\]</span></p>
<hr />
<p><br /></p>
</div>
<div id="em-algorithm-m-step-minimise-qboldsymbolpsi-boldsymbolpsik" class="section level4">
<h4><span class="header-section-number">2.5.3.4</span> EM algorithm: M-step minimise <span class="math inline">\(Q(\boldsymbol{\Psi}, \boldsymbol{\Psi}^k)\)</span></h4>
<p><span class="math display">\[\begin{align*}
\boldsymbol{\Phi}^{k+1}=&amp;\mathbf{S}_{10}\mathbf{S}_{00}^{-1}\\\\
\mathbf{Q}^{k+1}=&amp; n^{-1}(\mathbf{S}_{11}-\mathbf{S}_{10}\mathbf{S}_{00}^{-1}\mathbf{S}_{10}^T),\\\\
\mathbf{R}^{k+1}=&amp;n^{-1}\sum\limits_{t=1}^n \left[(\mathbf{y}_t-\mathbf{A}_t \mathbf{X}_{t\vert n})(\mathbf{y}_t-\mathbf{A}_t\mathbf{X}_{t\vert n})^T+\mathbf{A}_t\mathbf{P}_{t\vert n} \mathbf{A}_t^T\right]\\\\
\boldsymbol{\mu}_0^{k+1}=&amp; \mathbf{X}_{0\vert n}\\\\
\boldsymbol{\Sigma}_0^{k+1}=&amp;\mathbf{P}_{0\vert n}
\end{align*}\]</span></p>
<hr />
<p><br /></p>
</div>
</div>
</div>
</div>
<div id="extensions" class="section level1">
<h1><span class="header-section-number">3</span> Extensions</h1>
<ol style="list-style-type: decimal">
<li>Link between State Space models and cubic smoothing splines</li>
<li>More complex temporal structures</li>
<li>Time varying coefficient model</li>
<li>Missing data</li>
<li>Kalman filter for Generalized Least Squares (GLS)</li>
<li>Advanced topics</li>
</ol>
<hr />
<p><br /></p>
<div id="link-with-cubic-smoothing-splines" class="section level2">
<h2><span class="header-section-number">3.1</span> Link with Cubic Smoothing Splines</h2>
<p>Basic idea of smoothing splines:</p>
<p><span class="math display">\[y_t = \mu_t + v_t\]</span></p>
<p>with <span class="math inline">\(t = 1,...,n,\)</span> and <span class="math inline">\(\mu_t\)</span> a smooth function of t, and <span class="math inline">\(v_t\)</span> is <span class="math inline">\(N(0,\sigma^2_v)\)</span>.</p>
<p>In cubic smoothing <span class="math inline">\(\mu_t\)</span> is estimated by minimizing</p>
<p><span class="math display">\[
\sum\limits_{t=1}^n [y_t - \mu_t]^2 + \lambda \int\limits_{t=1}^n \left(\frac{d^2\mu_t}{dt^2}\right)^2 dt
\]</span></p>
<p>with respect to <span class="math inline">\(\mu_t\)</span> , where <span class="math inline">\(\lambda &gt; 0\)</span> is a smoothing parameter.</p>
<ul>
<li><p><span class="math inline">\(\lambda\)</span> controls the degree of smoothness, with larger values yielding smoother estimates.</p></li>
<li><p>If <span class="math inline">\(\lambda = 0\)</span>, then minimizer is the data itself <span class="math inline">\(\hat \mu_t = y_t\)</span>, not smooth!<br />
</p></li>
<li><p>If <span class="math inline">\(\lambda =\infty\)</span> will force the second derivative to be, resulting in a linear regression : <span class="math inline">\(\mu_t = \beta_0+\beta t\)</span></p></li>
</ul>
<p><br /></p>
<p>When knots are placed at the time points <span class="math inline">\(t\)</span>, it can be shown that the loss function reduces to</p>
<p><span class="math display">\[
\sum\limits_{t=1}^n [y_t - \mu_t]^2 + \lambda \sum\limits_{t=1}^n  \left(\bigtriangledown^2 \mu_t\right)^2
\]</span></p>
<p>with <span class="math inline">\(\bigtriangledown^2 \mu_t = \mu_t - 2 \mu_{t-1} + \mu_{t-2}\)</span> finite differences.</p>
<hr />
<p><br /></p>
<div id="recasting-in-a-state-space-model" class="section level3">
<h3><span class="header-section-number">3.1.1</span> Recasting in a state space model</h3>
<p><span class="math display">\[
\bigtriangledown^2 \mu_t = w_t \\
\]</span></p>
<p>and rewriting it</p>
<p><span class="math display">\[
\mu_t  =  2 \mu_{t-1} - \mu_{t-2} + w_t 
\]</span></p>
<p>enable us to recast the spline in a state space model:</p>
<p><span class="math display">\[\begin{eqnarray*}
\begin{bmatrix}
\mu_t\\
\mu_{t-1}
\end{bmatrix} &amp;=&amp; \begin{bmatrix} 2 &amp; - 1\\ 1 &amp; 0\end{bmatrix} \begin{bmatrix} \mu_{t-1} \\ \mu_{t-2} \end{bmatrix} + \begin{bmatrix}1\\0\end{bmatrix} w_t\\
y_t &amp;=&amp;  \begin{bmatrix} 1&amp;0\end{bmatrix}\begin{bmatrix} \mu_{t-1} \\ \mu_{t-2} \end{bmatrix} + v_t
\end{eqnarray*}\]</span></p>
<hr />
<p><br /></p>
</div>
<div id="maximize-complete-data-likelihood-to-the-states" class="section level3">
<h3><span class="header-section-number">3.1.2</span> Maximize complete data likelihood to the States:</h3>
<p><span class="math display">\[
\log L_{\mathbf{Y},\mathbf{X}}(\boldsymbol{\Psi})  \propto \sigma_v^{-2} \sum\limits_{t=1}^n \left(y_t - \mu_t\right)^2 + \sigma_w^{-2} \sum\limits_{t=1}^n \left(\bigtriangledown^2 \mu_t\right)^2  
\]</span></p>
<p>is equivalent to maximizing:</p>
<p><span class="math display">\[
\log L_{\mathbf{Y},\mathbf{X}}(\boldsymbol{\Psi})  \propto  \sum\limits_{t=1}^n \left(y_t - \mu_t\right)^2 + \frac{\sigma_v^{2}}{\sigma_w^{2}} \sum\limits_{t=1}^n \left(\bigtriangledown^2 \mu_t\right)^2  
\]</span></p>
<ul>
<li><p>So the State Space model has the same solution as a smoothing spline with penalty <span class="math inline">\(\lambda = \frac{\sigma_v^{2}}{\sigma_w^{2}}\)</span>!</p></li>
<li><p>Mean <span class="math inline">\(\leftrightarrow\)</span> Variance</p></li>
<li><p>Link mixed models and ridge regression/penalisation</p></li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="example" class="section level3">
<h3><span class="header-section-number">3.1.3</span> Example</h3>
<ul>
<li>We simulate the signal, or state process, <span class="math inline">\(\mu_t\)</span> and observations <span class="math inline">\(y_t\)</span> with <span class="math inline">\(n = 50\)</span>, <span class="math inline">\(\sigma^2_\omega = .1\)</span> and <span class="math inline">\(\sigma^2_\epsilon\)</span> = 1.</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb43-2"><a href="#cb43-2"></a>num =<span class="st"> </span><span class="dv">50</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>w =<span class="st"> </span><span class="kw">rnorm</span>(num,<span class="dv">0</span>,.<span class="dv">1</span>)</span>
<span id="cb43-4"><a href="#cb43-4"></a>mu   =<span class="st"> </span><span class="kw">cumsum</span>(<span class="kw">cumsum</span>(w))</span>
<span id="cb43-5"><a href="#cb43-5"></a></span>
<span id="cb43-6"><a href="#cb43-6"></a>y =<span class="st"> </span>mu <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(num,<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>plotSmootherReal &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">t=</span><span class="dv">1</span><span class="op">:</span>num,<span class="dt">mu=</span>mu,<span class="dt">y=</span>y) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>t,<span class="dt">y=</span>y)) <span class="op">+</span></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x=</span>t,<span class="dt">y=</span>mu))</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>plotSmootherReal</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<div id="state-space-model" class="section level4">
<h4><span class="header-section-number">3.1.3.1</span> State space model</h4>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="co">## State Space ##</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>Phi &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>),<span class="dv">2</span>) </span>
<span id="cb46-3"><a href="#cb46-3"></a>A &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>),<span class="dv">1</span>) </span>
<span id="cb46-4"><a href="#cb46-4"></a>mu0 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dv">2</span>)</span>
<span id="cb46-5"><a href="#cb46-5"></a>Sigma0 &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>,<span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="estimation" class="section level4">
<h4><span class="header-section-number">3.1.3.2</span> Estimation</h4>
<p>Explain maximum likelihood implementation.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co">## Fitting </span></span>
<span id="cb47-2"><a href="#cb47-2"></a>Phi &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>),<span class="dv">2</span>) </span>
<span id="cb47-3"><a href="#cb47-3"></a>A &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>),<span class="dv">1</span>) </span>
<span id="cb47-4"><a href="#cb47-4"></a>mu0 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dv">2</span>) </span>
<span id="cb47-5"><a href="#cb47-5"></a>Sigma0 &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb47-6"><a href="#cb47-6"></a>Linn &lt;-<span class="st"> </span><span class="cf">function</span>(para){</span>
<span id="cb47-7"><a href="#cb47-7"></a>  sigw &lt;-<span class="st"> </span>para[<span class="dv">1</span>]</span>
<span id="cb47-8"><a href="#cb47-8"></a>  sigv &lt;-<span class="st"> </span>para[<span class="dv">2</span>]</span>
<span id="cb47-9"><a href="#cb47-9"></a>  cQ   &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(sigw,<span class="dv">0</span>))</span>
<span id="cb47-10"><a href="#cb47-10"></a>  kf   &lt;-<span class="st"> </span><span class="kw">Kfilter0</span>(num, y, A, mu0, Sigma0, Phi, cQ, sigv)</span>
<span id="cb47-11"><a href="#cb47-11"></a>  <span class="kw">return</span>(kf<span class="op">$</span>like)   }</span>
<span id="cb47-12"><a href="#cb47-12"></a></span>
<span id="cb47-13"><a href="#cb47-13"></a>init.par &lt;-<span class="st"> </span><span class="kw">c</span>(.<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb47-14"><a href="#cb47-14"></a></span>
<span id="cb47-15"><a href="#cb47-15"></a>est &lt;-<span class="st"> </span><span class="kw">optim</span>(</span>
<span id="cb47-16"><a href="#cb47-16"></a>  <span class="dt">par =</span> init.par, </span>
<span id="cb47-17"><a href="#cb47-17"></a>  <span class="dt">fn =</span> Linn, </span>
<span id="cb47-18"><a href="#cb47-18"></a>  <span class="dt">method=</span><span class="st">&quot;BFGS&quot;</span>, </span>
<span id="cb47-19"><a href="#cb47-19"></a>  <span class="dt">hessian=</span><span class="ot">TRUE</span>,</span>
<span id="cb47-20"><a href="#cb47-20"></a>  <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">trace=</span><span class="dv">1</span>,<span class="dt">REPORT=</span><span class="dv">1</span>))</span></code></pre></div>
</div>
<div id="smoother" class="section level4">
<h4><span class="header-section-number">3.1.3.3</span> Smoother</h4>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>sigw &lt;-<span class="st"> </span>est<span class="op">$</span>par[<span class="dv">1</span>]</span>
<span id="cb48-2"><a href="#cb48-2"></a>cQ &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(sigw,<span class="dv">0</span>))</span>
<span id="cb48-3"><a href="#cb48-3"></a>sigv &lt;-<span class="st"> </span>est<span class="op">$</span>par[<span class="dv">2</span>]</span>
<span id="cb48-4"><a href="#cb48-4"></a>ks &lt;-<span class="st"> </span><span class="kw">Ksmooth0</span>(num, y, A, mu0, Sigma0, Phi, cQ, sigv)</span></code></pre></div>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>dataHlp3 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">t =</span> <span class="dv">1</span><span class="op">:</span>num, <span class="dt">muFit =</span> ks<span class="op">$</span>xs[<span class="dv">1</span>,<span class="dv">1</span>,]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb49-3"><a href="#cb49-3"></a>    <span class="dt">mull =</span> muFit <span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(ks<span class="op">$</span>Ps[<span class="dv">1</span>,<span class="dv">1</span>,]),</span>
<span id="cb49-4"><a href="#cb49-4"></a>    <span class="dt">muul =</span> muFit <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(ks<span class="op">$</span>Ps[<span class="dv">1</span>,<span class="dv">1</span>,]),</span>
<span id="cb49-5"><a href="#cb49-5"></a>         )</span>
<span id="cb49-6"><a href="#cb49-6"></a></span>
<span id="cb49-7"><a href="#cb49-7"></a>dataHlp4 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb49-8"><a href="#cb49-8"></a>  <span class="dt">t=</span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>num,<span class="dv">3</span>),</span>
<span id="cb49-9"><a href="#cb49-9"></a>  <span class="dt">mu=</span><span class="kw">c</span>(<span class="kw">smooth.spline</span>(y)<span class="op">$</span>y,mu,ks<span class="op">$</span>xs[<span class="dv">1</span>,<span class="dv">1</span>,]),</span>
<span id="cb49-10"><a href="#cb49-10"></a>  <span class="dt">method=</span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;GCV spline&quot;</span>,<span class="st">&quot;Ground Truth&quot;</span>,<span class="st">&quot;Kalman Smoother&quot;</span>),<span class="dt">each=</span>num))</span>
<span id="cb49-11"><a href="#cb49-11"></a></span>
<span id="cb49-12"><a href="#cb49-12"></a>cubicSmootherPlot &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb49-13"><a href="#cb49-13"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(</span>
<span id="cb49-14"><a href="#cb49-14"></a>    <span class="kw">aes</span>(<span class="dt">x=</span>t,<span class="dt">ymin =</span> mull,<span class="dt">ymax =</span> muul), </span>
<span id="cb49-15"><a href="#cb49-15"></a>    <span class="dt">alpha =</span> <span class="fl">0.45</span>, </span>
<span id="cb49-16"><a href="#cb49-16"></a>    <span class="dt">color =</span> <span class="ot">NA</span>,</span>
<span id="cb49-17"><a href="#cb49-17"></a>    <span class="dt">data =</span> dataHlp3) <span class="op">+</span></span>
<span id="cb49-18"><a href="#cb49-18"></a><span class="st">  </span><span class="kw">geom_point</span>(</span>
<span id="cb49-19"><a href="#cb49-19"></a>    <span class="kw">aes</span>(<span class="dt">x=</span>x,<span class="dt">y=</span>obs),</span>
<span id="cb49-20"><a href="#cb49-20"></a>    <span class="dt">color=</span><span class="st">&quot;black&quot;</span>, </span>
<span id="cb49-21"><a href="#cb49-21"></a>    <span class="dt">data=</span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="dv">1</span><span class="op">:</span>num,<span class="dt">obs=</span>y)) <span class="op">+</span></span>
<span id="cb49-22"><a href="#cb49-22"></a><span class="st">  </span><span class="kw">geom_line</span>(</span>
<span id="cb49-23"><a href="#cb49-23"></a>    <span class="kw">aes</span>(<span class="dt">x =</span> t, <span class="dt">y =</span> mu, <span class="dt">color =</span> method, <span class="dt">linetype =</span> method),</span>
<span id="cb49-24"><a href="#cb49-24"></a>    <span class="dt">data =</span> dataHlp4) <span class="op">+</span></span>
<span id="cb49-25"><a href="#cb49-25"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;black&quot;</span>,<span class="st">&quot;red&quot;</span>)) <span class="op">+</span></span>
<span id="cb49-26"><a href="#cb49-26"></a><span class="st">  </span><span class="kw">scale_linetype_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>)) </span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>cubicSmootherPlot</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<hr />
<p><br /></p>
</div>
</div>
</div>
<div id="more-complex-temporal-structures" class="section level2">
<h2><span class="header-section-number">3.2</span> More complex temporal structures</h2>
<ul>
<li>Extend state vector with states at previous lags, i.e. <span class="math inline">\(t-1, \ldots, t-p\)</span></li>
</ul>
<p><span class="math display">\[\mathbf{X}_t=[X_{1t} \ldots X_{mt}, \ldots, X_{1t-p}\ldots X_{mt-p}]^T\]</span></p>
<ul>
<li>By embedding the AR(p) State in the measurement equation, the correlation structure again becomes much more flexible.</li>
</ul>
<hr />
<p><br /></p>
</div>
<div id="time-varying-coefficient-model" class="section level2">
<h2><span class="header-section-number">3.3</span> Time Varying Coefficient Model</h2>
<p>Regression models with time varying model parameters can also be easily provided by extending the state vector, i.e. </p>
<p><span class="math display">\[\mathbf{X}_t=[X_{1t} \ldots X_{mt},\mathbf{\beta}_t]^T\]</span></p>
<div id="example-hedge-ratio-crypto-currencies" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Example Hedge ratio crypto-currencies</h3>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>coinData &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb51-3"><a href="#cb51-3"></a>    <span class="dt">year =</span> <span class="kw">format</span>(date,<span class="st">&quot;%Y&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.factor,</span>
<span id="cb51-4"><a href="#cb51-4"></a>    <span class="dt">colors =</span> <span class="kw">as.double</span>(date)<span class="op">-</span><span class="kw">mean</span>(<span class="kw">as.double</span>(date))</span>
<span id="cb51-5"><a href="#cb51-5"></a>    ) </span>
<span id="cb51-6"><a href="#cb51-6"></a></span>
<span id="cb51-7"><a href="#cb51-7"></a>plotHedge &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb51-8"><a href="#cb51-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(eth_prices_usd, ltc_prices_usd, <span class="dt">color=</span>year)) <span class="op">+</span></span>
<span id="cb51-9"><a href="#cb51-9"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">.7</span>, <span class="dt">shape =</span> <span class="dv">1</span>) </span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>plotHedge</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
</div>
<div id="define-state-space-model" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Define state space model</h3>
<p><span class="math display">\[y_t = \beta_{0t} + \beta_{1t} z_t + v_t\]</span></p>
<p>with</p>
<ul>
<li><span class="math inline">\(y_t\)</span>: ltc price and</li>
<li><span class="math inline">\(z_t\)</span>: eth price</li>
</ul>
<p>State space model: <span class="math display">\[
\left\lbrace
\begin{array}{llll}
y_t&amp;=&amp;\mathbf{A}_t\mathbf{X}_t+v_t &amp;with\ v_t\sim N(0,\sigma_v^2)\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi} \mathbf{X}_{t-1} + \mathbf{w}_t &amp;with\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q})
\end{array}
\right.\]</span></p>
<p>with</p>
<ul>
<li><span class="math inline">\(\mathbf{A}_t = \begin{bmatrix} 1 &amp; z_t\end{bmatrix}\)</span></li>
<li><span class="math inline">\(\mathbf{X}_t= \begin{bmatrix} \beta_{0t}\\ \beta_{1t} \end{bmatrix}\)</span></li>
</ul>
</div>
<div id="r-implementation" class="section level3">
<h3><span class="header-section-number">3.3.3</span> R implementation</h3>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>y &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="st">  </span><span class="kw">pull</span>(<span class="st">&quot;ltc_prices_usd&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="st">  </span><span class="kw">as.matrix</span>(<span class="dt">ncol=</span><span class="dv">1</span>)</span>
<span id="cb53-4"><a href="#cb53-4"></a></span>
<span id="cb53-5"><a href="#cb53-5"></a>z &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-6"><a href="#cb53-6"></a><span class="st">  </span><span class="kw">pull</span>(<span class="st">&quot;eth_prices_usd&quot;</span>) </span>
<span id="cb53-7"><a href="#cb53-7"></a></span>
<span id="cb53-8"><a href="#cb53-8"></a>num &lt;-<span class="st"> </span><span class="kw">nrow</span>(y)</span>
<span id="cb53-9"><a href="#cb53-9"></a></span>
<span id="cb53-10"><a href="#cb53-10"></a><span class="co"># Measurement matrix A = </span></span>
<span id="cb53-11"><a href="#cb53-11"></a>A &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,num))  </span>
<span id="cb53-12"><a href="#cb53-12"></a>A[,<span class="dv">1</span>,] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb53-13"><a href="#cb53-13"></a>A[,<span class="dv">2</span>,] &lt;-<span class="st"> </span>z</span>
<span id="cb53-14"><a href="#cb53-14"></a></span>
<span id="cb53-15"><a href="#cb53-15"></a><span class="co"># initial values</span></span>
<span id="cb53-16"><a href="#cb53-16"></a>mu0 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb53-17"><a href="#cb53-17"></a>Sigma0 &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>,.<span class="dv">1</span>),<span class="dv">2</span>)</span>
<span id="cb53-18"><a href="#cb53-18"></a>Phi &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb53-19"><a href="#cb53-19"></a>cQ &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>,.<span class="dv">1</span>),<span class="dv">2</span>)</span>
<span id="cb53-20"><a href="#cb53-20"></a>cR &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>),<span class="dv">1</span>)</span>
<span id="cb53-21"><a href="#cb53-21"></a></span>
<span id="cb53-22"><a href="#cb53-22"></a>em &lt;-<span class="st"> </span><span class="kw">EM1</span>(num, y, A, mu0, Sigma0, Phi, cQ, cR, <span class="dv">100</span>, <span class="fl">.001</span>)</span>
<span id="cb53-23"><a href="#cb53-23"></a>ks &lt;-<span class="st"> </span><span class="kw">Ksmooth1</span>(num, y, A, em<span class="op">$</span>mu0, em<span class="op">$</span>Sigma0, em<span class="op">$</span>Phi, <span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">chol</span>(em<span class="op">$</span>Q), <span class="kw">chol</span>(em<span class="op">$</span>R), <span class="dv">0</span>)</span></code></pre></div>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>plotBetasVarying &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb54-2"><a href="#cb54-2"></a>    <span class="dt">time=</span>coinData<span class="op">$</span>date, </span>
<span id="cb54-3"><a href="#cb54-3"></a>    <span class="dt">beta=</span><span class="kw">c</span>(ks<span class="op">$</span>xf[<span class="dv">1</span>,<span class="dv">1</span>,], ks<span class="op">$</span>xf[<span class="dv">2</span>,<span class="dv">1</span>,]),</span>
<span id="cb54-4"><a href="#cb54-4"></a>    <span class="dt">state=</span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;intercept&quot;</span>,ndays), <span class="kw">rep</span>(<span class="st">&quot;slope&quot;</span>,ndays))</span>
<span id="cb54-5"><a href="#cb54-5"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb54-6"><a href="#cb54-6"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(time, beta)) <span class="op">+</span></span>
<span id="cb54-7"><a href="#cb54-7"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb54-8"><a href="#cb54-8"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>state, <span class="dt">nrow=</span><span class="dv">2</span>, <span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></span>
<span id="cb54-9"><a href="#cb54-9"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>plotBetasVarying</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>coinData &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb56-3"><a href="#cb56-3"></a>    <span class="dt">hedgeInt =</span> ks<span class="op">$</span>xf[<span class="dv">1</span>,<span class="dv">1</span>,],</span>
<span id="cb56-4"><a href="#cb56-4"></a>    <span class="dt">hedgeSlp =</span> ks<span class="op">$</span>xf[<span class="dv">2</span>,<span class="dv">1</span>,]  </span>
<span id="cb56-5"><a href="#cb56-5"></a>    )</span>
<span id="cb56-6"><a href="#cb56-6"></a></span>
<span id="cb56-7"><a href="#cb56-7"></a>plotHedge &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb56-8"><a href="#cb56-8"></a>i&lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb56-9"><a href="#cb56-9"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="kw">pretty</span>(coinData<span class="op">$</span>date, <span class="dv">36</span>))</span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="co">#for (t in c(</span></span>
<span id="cb56-11"><a href="#cb56-11"></a><span class="co">#  seq(</span></span>
<span id="cb56-12"><a href="#cb56-12"></a><span class="co">#    min(coinData$date),</span></span>
<span id="cb56-13"><a href="#cb56-13"></a><span class="co">#    as.Date(&quot;2019-12-31&quot;),</span></span>
<span id="cb56-14"><a href="#cb56-14"></a><span class="co">#    7),</span></span>
<span id="cb56-15"><a href="#cb56-15"></a><span class="co">#  seq(</span></span>
<span id="cb56-16"><a href="#cb56-16"></a><span class="co">#    as.Date(&quot;2021-01-01&quot;),</span></span>
<span id="cb56-17"><a href="#cb56-17"></a><span class="co">#    max(coinData$date),</span></span>
<span id="cb56-18"><a href="#cb56-18"></a><span class="co">#    7)</span></span>
<span id="cb56-19"><a href="#cb56-19"></a><span class="co">#  )</span></span>
<span id="cb56-20"><a href="#cb56-20"></a><span class="co">#  )</span></span>
<span id="cb56-21"><a href="#cb56-21"></a>{</span>
<span id="cb56-22"><a href="#cb56-22"></a>  i &lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb56-23"><a href="#cb56-23"></a>  plotHedge[[i]] &lt;-<span class="st"> </span>coinData <span class="op">%&gt;%</span></span>
<span id="cb56-24"><a href="#cb56-24"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(eth_prices_usd, ltc_prices_usd, <span class="dt">color=</span>year)) <span class="op">+</span></span>
<span id="cb56-25"><a href="#cb56-25"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">.7</span>, <span class="dt">shape =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb56-26"><a href="#cb56-26"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>eth_prices_usd, <span class="dt">y =</span> ltc_prices_usd, <span class="dt">color =</span> year), <span class="dt">data =</span> coinData <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t), <span class="dt">shape =</span> <span class="dv">17</span>, <span class="dt">size =</span> <span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb56-27"><a href="#cb56-27"></a><span class="st">    </span><span class="kw">geom_abline</span>(<span class="kw">aes</span>(<span class="dt">intercept=</span>hedgeInt, <span class="dt">slope=</span>hedgeSlp, <span class="dt">color =</span> year), <span class="dt">data =</span> coinData <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">==</span><span class="st"> </span>t))</span>
<span id="cb56-28"><a href="#cb56-28"></a>}</span></code></pre></div>
</p>
</details>
<p>Animation includes regression line for first day of each month.</p>
<p><img src="index_files/figure-html/unnamed-chunk-44-.gif" width="672" /></p>
<hr />
<p><br /></p>
</div>
</div>
<div id="missing-data" class="section level2">
<h2><span class="header-section-number">3.4</span> Missing Data</h2>
<div id="data" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Data</h3>
<ul>
<li><p>Data from Jones (1984)</p></li>
<li><p>Measurements made for 91 days on three variables:</p>
<ul>
<li><span class="math inline">\(y_1\)</span>: log(white blood count) [WBC]</li>
<li><span class="math inline">\(y_2\)</span>: log(platelet) [PLT]</li>
<li><span class="math inline">\(y_3\)</span>: hematocrit [HCT]</li>
</ul></li>
</ul>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>bloodTidy &lt;-<span class="st"> </span>blood <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb57-2"><a href="#cb57-2"></a><span class="st">  </span>as.data.frame <span class="op">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t=</span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(blood)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb57-4"><a href="#cb57-4"></a><span class="st">  </span><span class="kw">gather</span>(variable, concentration, <span class="op">-</span>t)</span>
<span id="cb57-5"><a href="#cb57-5"></a>plotBlood &lt;-<span class="st"> </span>bloodTidy <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb57-6"><a href="#cb57-6"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(t,concentration)) <span class="op">+</span></span>
<span id="cb57-7"><a href="#cb57-7"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb57-8"><a href="#cb57-8"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>variable,<span class="dt">nrow=</span><span class="dv">3</span>,<span class="dt">scales=</span><span class="st">&quot;free_y&quot;</span>) <span class="op">+</span></span>
<span id="cb57-9"><a href="#cb57-9"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>plotBlood</span></code></pre></div>
<pre><code>## Warning: Removed 111 rows containing missing values (geom_point).</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-46-1.png" width="672" /></p>
<ul>
<li>Some data are missing!</li>
</ul>
</div>
<div id="solution" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Solution</h3>
<ol style="list-style-type: decimal">
<li>Replace missing data with 0 and remove the correlations use</li>
</ol>
<p><span class="math display">\[
\mathbf{y}_t=\left[\mathbf{y}_t^{(obs)} 0\right]^T
\]</span></p>
<p><span class="math display">\[\mathbf{R}_t=\begin{bmatrix}\mathbf{R}_{11t}&amp; \mathbf{0}\\\mathbf{0}&amp;\mathbf{R}_{22t}\end{bmatrix}\]</span></p>
<p><span class="math display">\[\mathbf{A}_t=\begin{bmatrix}\mathbf{A}^{(obs)}\\\mathbf{0}\end{bmatrix}\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li><p>Then you can apply the existing recursions for the Kalman Filter and Smoother</p></li>
<li><p>The EM algorithm is designed to handle missing data.</p></li>
</ol>
</div>
<div id="example-1" class="section level3">
<h3><span class="header-section-number">3.4.3</span> Example</h3>
<ul>
<li>Define state space model and estimation</li>
</ul>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t&amp;=&amp;\mathbf{A}_t\mathbf{X}_t+ \mathbf{v}_t &amp;with\ \mathbf{v}_t\sim N(0,\mathbf{R}_t)\\
\mathbf{X}_t&amp;=&amp;\boldsymbol{\Phi} \mathbf{X}_{t-1} + \mathbf{w}_t &amp;with\ \mathbf{w}_t\sim MVN(\mathbf{0},\mathbf{Q})
\end{array}
\right.\]</span></p>
<p>with <span class="math inline">\(\mathbf{A}=\mathbf{I}\)</span></p>
<ol style="list-style-type: decimal">
<li>Replace missing values by 0</li>
</ol>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>y &lt;-<span class="st"> </span>blood <span class="op">%&gt;%</span><span class="st"> </span>as.matrix</span>
<span id="cb60-2"><a href="#cb60-2"></a>y[<span class="kw">is.na</span>(y)] =<span class="st"> </span><span class="dv">0</span></span>
<span id="cb60-3"><a href="#cb60-3"></a>num &lt;-<span class="st"> </span><span class="kw">nrow</span>(y)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Construct time variant matrix A.</li>
</ol>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>A  &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dv">0</span>, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,num))</span>
<span id="cb61-2"><a href="#cb61-2"></a><span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>num) { <span class="cf">if</span> (y[k,<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) A[,,k] &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>) } <span class="co"># </span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Initalisation and estimation. Note, that we do not have to adjust covariance matrix <span class="math inline">\(\mathbf{R}\)</span> to account for missingness because all observations are measured or missing at a particular timestep.</li>
</ol>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a><span class="co">#Initial values</span></span>
<span id="cb62-2"><a href="#cb62-2"></a>mu0 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb62-3"><a href="#cb62-3"></a>Sigma0 &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>, <span class="fl">.1</span>, <span class="dv">1</span>), <span class="dv">3</span>)</span>
<span id="cb62-4"><a href="#cb62-4"></a>Phi &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb62-5"><a href="#cb62-5"></a>cQ &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>, <span class="fl">.1</span>, <span class="dv">1</span>), <span class="dv">3</span>) </span>
<span id="cb62-6"><a href="#cb62-6"></a>cR &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(.<span class="dv">1</span>, <span class="fl">.1</span>, <span class="dv">1</span>), <span class="dv">3</span>)</span>
<span id="cb62-7"><a href="#cb62-7"></a></span>
<span id="cb62-8"><a href="#cb62-8"></a>em &lt;-<span class="st"> </span><span class="kw">EM1</span>(num, y, A, mu0, Sigma0, Phi, cQ, cR, <span class="dv">100</span>, <span class="fl">.001</span>)</span>
<span id="cb62-9"><a href="#cb62-9"></a>ks &lt;-<span class="st"> </span><span class="kw">Ksmooth1</span>(num, y, A, em<span class="op">$</span>mu0, em<span class="op">$</span>Sigma0, em<span class="op">$</span>Phi, <span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">chol</span>(em<span class="op">$</span>Q), <span class="kw">chol</span>(em<span class="op">$</span>R), <span class="dv">0</span>)</span></code></pre></div>
<details>
<summary>Click to see code for plot </summary>
<p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>bloodTidy &lt;-<span class="st"> </span>bloodTidy <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb63-3"><a href="#cb63-3"></a>    <span class="dt">xs=</span>ks<span class="op">$</span>xs[,<span class="dv">1</span>,] <span class="op">%&gt;%</span><span class="st"> </span>t <span class="op">%&gt;%</span><span class="st"> </span>c,</span>
<span id="cb63-4"><a href="#cb63-4"></a>    <span class="dt">xsll =</span> (ks<span class="op">$</span>xs[,<span class="dv">1</span>,] <span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>num,<span class="cf">function</span>(i) ks<span class="op">$</span>Ps[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c,</span>
<span id="cb63-5"><a href="#cb63-5"></a>    <span class="dt">xsul =</span> (ks<span class="op">$</span>xs[,<span class="dv">1</span>,] <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>num,<span class="cf">function</span>(i) ks<span class="op">$</span>Pf[,,i] <span class="op">%&gt;%</span><span class="st"> </span>diag <span class="op">%&gt;%</span><span class="st"> </span>sqrt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>c</span>
<span id="cb63-6"><a href="#cb63-6"></a>    )</span>
<span id="cb63-7"><a href="#cb63-7"></a></span>
<span id="cb63-8"><a href="#cb63-8"></a>plotBloodResults &lt;-<span class="st"> </span>plotBlood <span class="op">+</span></span>
<span id="cb63-9"><a href="#cb63-9"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(</span>
<span id="cb63-10"><a href="#cb63-10"></a>    <span class="kw">aes</span>(<span class="dt">ymin =</span> xsll,<span class="dt">ymax =</span> xsul), </span>
<span id="cb63-11"><a href="#cb63-11"></a>    <span class="dt">alpha =</span> <span class="fl">0.45</span>, </span>
<span id="cb63-12"><a href="#cb63-12"></a>    <span class="dt">data =</span> bloodTidy) <span class="op">+</span></span>
<span id="cb63-13"><a href="#cb63-13"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x=</span>t,<span class="dt">y=</span>xs),<span class="dt">data=</span>bloodTidy) <span class="op">+</span></span>
<span id="cb63-14"><a href="#cb63-14"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;time (days)&quot;</span>) <span class="op">+</span></span>
<span id="cb63-15"><a href="#cb63-15"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Kalman Smoother&quot;</span>)</span></code></pre></div>
</p>
</details>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>plotBloodResults</span></code></pre></div>
<pre><code>## Warning: Removed 111 rows containing missing values (geom_point).</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
<hr />
<p><br /></p>
</div>
</div>
<div id="kalman-filter-for-generalized-least-squares-gls" class="section level2">
<h2><span class="header-section-number">3.5</span> Kalman Filter for Generalized Least Squares (GLS)</h2>
<p><span class="math display">\[
\left\lbrace
\begin{array}{llll}
\mathbf{y}_t &amp;=&amp; \mathbf{A}_t \mathbf{X}_t + \mathbf{Z}_t\boldsymbol{\beta}+ \mathbf{v}_t\\
\mathbf{X}_t &amp;=&amp;\boldsymbol{\Phi}_t \mathbf{X}_{t-1} + \mathbf{w}_t\\
\end{array}
\right.
\]</span></p>
<p>The state-space model can be further reformulated as a regression model <span class="math display">\[
\mathbf{y}_t=\mathbf{Z}_t\boldsymbol{\beta}+ \mathbf{u}_t,
\text{ with } \mathbf{u}_t=\mathbf{A}_t \mathbf{X}_t + \mathbf{v}_t
\]</span></p>
<p><span class="math display">\[\begin{equation}
\mathbf{Y}_N=\mathbf{Z}_N \boldsymbol{\beta} + \mathbf{U}_N,
\label{measurement.reg.gls}
\end{equation}\]</span> with <span class="math inline">\(\mathbf{U}_N \sim MVN(\mathbf{0},\mathbf{V})\)</span>. <span class="math display">\[\begin{equation}
\hat{\boldsymbol{\beta}}_{GLS}=(\mathbf{Z}_N^T\mathbf{V}^{-1}\mathbf{Z}_N)^{-1}\mathbf{Z}_N^T \mathbf{V}^{-1} \mathbf{Y}_N.
\end{equation}\]</span></p>
<p>From GLS theory, <span class="math display">\[\begin{equation}
\text{Var}\left[\hat{\boldsymbol{\beta}}_{GLS}\right]=(\mathbf{Z}_N^T\mathbf{V}^{-1}\mathbf{Z}_N)^{-1}.
\end{equation}\]</span></p>
<p>Kalman Filter and Smoother</p>
<ol style="list-style-type: decimal">
<li><p>If <span class="math inline">\(\beta\)</span> is known, the kalman filter and smoother recursions still hold when we account for <span class="math inline">\(\mathbf{Z}_t\boldsymbol{\beta}\)</span> in the update step. <span class="math display">\[
\mathbf{X}_{t\vert t}=\mathbf{X}_{t\vert t-1}+ \mathbf{P}_{t\vert t-1}  \mathbf{A}_t^T \boldsymbol{\Sigma}_t^{-1} (\mathbf{y}_t - \mathbf{A}_t \mathbf{X}_{t\vert t-1} - \mathbf{Z}_t\boldsymbol{\beta})
\]</span></p></li>
<li><p>Harvey (1989) showed that for a given <span class="math inline">\(\boldsymbol{\Psi}\)</span></p></li>
</ol>
<ul>
<li>applying the same Kalman filter (without recalculating <span class="math inline">\(\mathbf{P}_{t\vert t-1}\)</span>, <span class="math inline">\(\mathbf{P}_{t\vert t}\)</span> and <span class="math inline">\(\boldsymbol{\Sigma}_t\)</span>) to <span class="math inline">\(\mathbf{Y}_t\)</span> and each of the columns of <span class="math inline">\(\mathbf{Z}_t\)</span></li>
<li>results in
<ul>
<li>A <span class="math inline">\(p\times1\)</span> vector of innovations, <span class="math inline">\(\mathbf{Y}_t^*\)</span> on <span class="math inline">\(\mathbf{Y}_t\)</span> and</li>
<li>a <span class="math inline">\(p\times m\)</span> matrix of innovations, <span class="math inline">\(\mathbf{Z_t^*}\)</span> on <span class="math inline">\((\mathbf{Z_{1t}},\ldots, \mathbf{Z_{mt}})\)</span> are produced.</li>
</ul></li>
<li>so that the GLS estimator of <span class="math inline">\(\boldsymbol{\beta}\)</span> can be obtained</li>
</ul>
<p><span class="math display">\[
\boldsymbol{\hat \beta_{GLS}}=\left[\sum\limits_{t=1}^N \mathbf{Z_t^{*T}\Sigma_t^{-1}Z_t^{*}}\right]^{-1}\sum\limits_{t=1}^N \mathbf{Z_t^{*T}\Sigma_t^{-1}y_t^{*}}.
\]</span></p>
<ul>
<li>the innovations <span class="math inline">\(\boldsymbol{\epsilon}_t\)</span> are then equivalent to <span class="math inline">\(\boldsymbol{\epsilon}_t=\mathbf{y}_t^* -\mathbf{z}_t^* \hat{ \boldsymbol{\beta}}_{GLS}\)</span> <span class="math display">\[\begin{equation}
\log L_{\mathbf{Y}_N}(\boldsymbol{\Psi})=-\frac{pn}{2}\log 2 \pi - \frac{1}{2} \sum\limits_{t=1}^n \log \vert \boldsymbol{\Sigma}_t\vert -\frac{1}{2} \sum\limits_{t=1}^n \boldsymbol{\epsilon}_t^T \boldsymbol{\Sigma}_t^{-1} \boldsymbol{\epsilon}_t.
\end{equation}\]</span></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Hence, we can thus update the M-step of the EM algorithm with the GLS estimator for <span class="math inline">\(\boldsymbol{\beta}\)</span>.</li>
</ol>
<hr />
<p><br /></p>
</div>
<div id="more-advanced-topics" class="section level2">
<h2><span class="header-section-number">3.6</span> More Advanced Topics</h2>
<ul>
<li><p>State Space models can also be used to model processes with stochastic volatility, e.g. when modeling returns.</p></li>
<li><p>When the states are discrete, the State Space Model becomes a Hidden Markov Model</p></li>
<li><p>Non-stationary time series. Specific formulations of State-Space Models for instance allow to model seasonal variation and trends.</p></li>
<li><p>Non-normality. Note, that the errors of the log-normal model are non-guassian. But, they are symmetric with broader tails. The estimators that are used here are assymptotically normally distributed. In relatively short time series we can</p>
<ul>
<li>resort to bootstrapping the innovations to provide better inference or</li>
<li>we can explicitely model the errors with another distribution</li>
</ul></li>
</ul>
<hr />
<p><br /></p>
</div>
</div>
<div id="literature" class="section level1">
<h1><span class="header-section-number">4</span> Literature</h1>
<ul>
<li>The presentation is largely based on the methods in chapter 6 of R. Shumway and D. Stoffer (2017) Time Series Analysis and Its Applications With R Examples - 4th Edition, which is freely available on Prof. David Stoffer’s website <a href="https://www.stat.pitt.edu/stoffer/tsa4/tsa4.htm" class="uri">https://www.stat.pitt.edu/stoffer/tsa4/tsa4.htm</a></li>
</ul>
<hr />
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAiQW4gaW50cm9kdWN0aW9uIHRvIHN0YXRlLXNwYWNlIG1vZGVscyBmb3IgdGltZS1zZXJpZXMgYW5hbHlzaXMgd2l0aCBleGFtcGxlcyBvbiB0aHJlZSBtYWpvciBjcnlwdG8tY3VycmVuY2llcyIKYXV0aG9yOiAiTGlldmVuIENsZW1lbnQiCmRhdGU6ICdgciBmb3JtYXQoU3lzLkRhdGUoKSwgIiVCICVkLCAlWSIpYCcKb3V0cHV0OgogICAgaHRtbF9kb2N1bWVudDoKICAgICAgY29kZV9kb3dubG9hZDogdHJ1ZQogICAgICB0aGVtZTogY29zbW8KICAgICAgdG9jOiB0cnVlCiAgICAgIHRvY19mbG9hdDogdHJ1ZQogICAgICBoaWdobGlnaHQ6IHRhbmdvCiAgICAgIG51bWJlcl9zZWN0aW9uczogdHJ1ZQotLS0KCgojIEludHJvZHVjdGlvbgoKLSBBc3NvY2lhdGUgUHJvZmVzc29yIG9mIFN0YXRpc3RpY2FsIEdlbm9taWNzIGluIEdoZW50IFVuaXZlcnNpdHkKCi0gQWR2b2NhdGUgb2Ygb3BlbiByZXNlYXJjaCBhbmQgb3BlbiB0ZWFjaGluZzoKQWxsIG91ciB0ZWFjaGluZyBtYXRlcmlhbHMsIG1ldGhvZHMsIHRvb2xzIGFuZCBhbmFseXNlcyBmb3IgcGFwZXJzIGFyZSBvcGVuIHNvdXJjZSBhbmQgZnJlZWx5IGF2YWlsYWJsZSBvbiBnaXRodWIgCgogICAgLSBodHRwczovL3N0YXRvbWljcy5naXRodWIuaW8vCiAgICAtIGh0dHBzOi8vc3RhdG9taWNzLmdpdGh1Yi5pby9wYWdlcy90ZWFjaGluZy5odG1sCiAgICAtIGh0dHBzOi8vZ2l0aHViLmNvbS9zdGF0b21pY3MKCi0gTWV0aG9kIGRldmVsb3BtZW50IGZvciBkaWZmZXJlbnRpYWwgYW5hbHlzaXMgb2YgZ2VuZSBhbmQgcHJvdGVpbiBleHByZXNzaW9uCgotIEJhY2tncm91bmQgaW4gZW52aXJvbm1lbnRhbCBlbmdpbmVlcmluZyB3aXRoIGEgUGhEIGluIGVudmlyb25tZW50YWwgc3RhdGlzdGljcyB3aXRoIGEgZm9jdXMgb24gdGltZXNlcmllcyBhbmFseXNpcyBvZiByaXZlciB3YXRlciBxdWFsaXR5IGRhdGEgCgotIEludHJvIHRvIAoKICAgIC0gU3RhdGUgU3BhY2UgTW9kZWxzIAogICAgLSBLYWxtYW4gZmlsdGVyICAmIHNtb290aGVyCiAgICAtIEFwcGxpZWQgb24gY3J5cHRvY3VycmVuY3kgZGF0YQogICAgLSBCcmllZiBpbnRybyBhbmQgaWxsdXN0cmF0aW9uIG9ubHksIGJ5IG5vIG1lYW5zIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBhcnQgCiAgICAtIE1vcmUgYWR2YW5jZWQgU3RhdGUgU3BhY2UgTW9kZWxzIHJlcXVpcmVkIGZvciBoZWRnaW5nIG9yIHByZWRpY3RpbmcgY3J5cHRvY3VycmVuY3kgZGF0YSBpbiBwcmFjdGljZS4KCi0gVGhpcyB3b3JrIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBbQ3JlYXRpdmUgQ29tbW9ucyBBdHRyaWJ1dGlvbi1Ob25Db21tZXJjaWFsLVNoYXJlQWxpa2UgNC4wIEludGVybmF0aW9uYWwgKENDIEJZLU5DLVNBIDQuMCldKGh0dHBzOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS1uYy1zYS80LjApCgo8YnIgLz4gCgoKIyMgVXNlZnVsIGZ1bmN0aW9ucyBhbmQgbG9hZCBsaWJyYXJpZXMKCjxkZXRhaWxzPjxzdW1tYXJ5PkNsaWNrIHRvIHNlZSBsb2FkZWQgbGlicmFyaWVzIDwvc3VtbWFyeT48cD4KYGBge3J9CmxpYnJhcnkoYXN0c2EpCmxpYnJhcnkodGlkeXZlcnNlKQpsaWJyYXJ5KEdHYWxseSkKbGlicmFyeShncmlkRXh0cmEpCmxpYnJhcnkoZ2lmc2tpKQpgYGAKPC9wPjwvZGV0YWlscz4KCjxkZXRhaWxzPjxzdW1tYXJ5PkNsaWNrIHRvIHNlZSBmdW5jdGlvbiB0byByZXRyZWl2ZSBjb2luIGRhdGEgZnJvbSBjb2luZ2Vja28gPC9zdW1tYXJ5PjxwPgoKYGBge3J9CiMgY29pblN5bWJvbDogc3ltYm9sIG9mIGNyeXB0b2N1cnJlbmN5IHRva2VuIG9yIGNvaW4KIyBkYXlzOiBwYXN0IG51bWJlciBvZiBkYXlzIHlvdSB3YW50IHRvIHJldHJpZXZlIGRhdGEgZm9yLiAibWF4IiByZXR1cm5zIGFsbCBhdmFpbGFibGUgZGF0YSBmb3IgYSB0b2tlbiBvciBjb2luLgojIGN1cnJlbmN5OiBmaWF0IGN1cnJlbmN5IHlvdSB3YW50IHRvIHVzZSBmb3IgcHJpY2UgKCJ1c2QiLCJldXIiLCJqcHkiLCAuLi4pCiMgaW50ZXJ2YWw6IHRpbWUgaW50ZXJ2YWwgb24gd2hpY2ggeW91IHdhbnQgdG8gcmV0cmVpdmUgZGF0YS4KCnJldHJlaXZlQ29pbkRhdGEgPC0gZnVuY3Rpb24oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvaW5TeW1ib2w9ImJ0YyIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlzID0gIm1heCIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW5jeSA9ICJ1c2QiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSAiZGFpbHkiKQp7ICAgCiAgI1JldHJlaXZlIGNvaW5saXN0IHRvIGxvb2t1cCBjb2luIGlkCiAgY29pbmxpc3QgPC0gaHR0cjo6R0VUKCJodHRwczovL2FwaS5jb2luZ2Vja28uY29tL2FwaS92My9jb2lucy9saXN0IikkY29udGVudCAlPiUgCiAgICByYXdUb0NoYXIgJT4lIAogICAganNvbmxpdGU6OmZyb21KU09OKC4pCiAgCiAgY29pbklkIDwtIGNvaW5saXN0ICU+JSBmaWx0ZXIoc3ltYm9sID09IGNvaW5TeW1ib2wpICU+JSBwdWxsKGlkKQogIAogICNyZXRyZWl2ZSBjb2luIGRhdGEgdmlhIEFQSQogIGNvaW5EYXRhIDwtIGh0dHI6OkdFVCgKICAgIHBhc3RlMCgKICAgICAgImh0dHBzOi8vYXBpLmNvaW5nZWNrby5jb20vYXBpL3YzL2NvaW5zLyIsCiAgICAgIGNvaW5JZCwKICAgICAgIi9tYXJrZXRfY2hhcnQ/dnNfY3VycmVuY3k9IiwKICAgICAgY3VycmVuY3ksCiAgICAgICImZGF5cz0iLAogICAgICBkYXlzLAogICAgICAiJmludGVydmFsPSIsCiAgICAgIGludGVydmFsKQogICAgKSRjb250ZW50ICU+JSAKICAgIHJhd1RvQ2hhciAlPiUgCiAgICBqc29ubGl0ZTo6ZnJvbUpTT04oLikKICAKICAjc3RvcmUgY29pbiBkYXRhIGFzIHRpYmxlLCBpbmNsdWRlIGNvaW4gc3ltYm9sIGluIHByaWNlIG5hbWUgYW5kIGNvdmVydCB1bml4IHRpbWUgc3RyaW5nIHRvIHRpbWVzdGFtcCBvYmplY3QKICBjb2luRGF0YSA8LSBsYXBwbHkobmFtZXMoY29pbkRhdGEpLCBmdW5jdGlvbih2YXIsY29pbkRhdGEpIAogICAgICAgICAgewogICAgICAgICAgICBkYXRhIDwtIGNvaW5EYXRhW1t2YXJdXSAlPiUgYXNfdGliYmxlKCkKICAgICAgICAgICAgbmFtZXMoZGF0YSkgPC0gYygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXN0ZTAoY29pblN5bWJvbCwiXyIsdmFyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZGF0YSA8LSBkYXRhICU+JSAKICAgICAgICAgICAgICBtdXRhdGUoCiAgICAgICAgICAgICAgICB0aW1lc3RhbXAgPSAgYXMuUE9TSVhjdCgKICAgICAgICAgICAgICAgICAgdGltZXN0YW1wLzEwMDAsIAogICAgICAgICAgICAgICAgICBvcmlnaW4gPSAiMTk3MC0wMS0wMSIsdHo9IkdNVCIKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKSAKICAgICAgICAgICAgcmV0dXJuKGRhdGEpCiAgICAgICAgICB9LCBjb2luRGF0YSA9IGNvaW5EYXRhCiAgICAgICAgKSAgJT4lIHJlZHVjZShsZWZ0X2pvaW4sIGJ5ID0gInRpbWVzdGFtcCIpCiAgI3JlbmFtZSBwcmljZXMgY29sdW1uIHRvIGluY2x1ZGUgY3VycmVuY3kKICBwcmljZXNJZCA8LSBncmVwKG5hbWVzKGNvaW5EYXRhKSwgcGF0dGVybj0icHJpY2VzIikKICBuYW1lcyhjb2luRGF0YSlbcHJpY2VzSWRdIDwtIHBhc3RlKAogICAgbmFtZXMoY29pbkRhdGEpW3ByaWNlc0lkXSwKICAgIGN1cnJlbmN5LAogICAgc2VwPSJfIikKICAKICAjZ2V0IHJpZCBvZiBsYXN0IHRpbWUgYmVjYXVzZSBjb2luIGdlY2tvIHJldHVybnMgYWxsIGRhaWx5IGRhdGEgYXQgMDA6MDAgR01UIGFuZCBpbmNsdWRlcyB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgY3VycmVudCBkYXkuIAogIGlmKGRheXM9PSJtYXgiKSAKICAgICAgcmV0dXJuKGNvaW5EYXRhKSBlbHNlIAogICAgICAgIHJldHVybiAoY29pbkRhdGFbMTpkYXlzLF0pCn0KYGBgCjwvcD48L2RldGFpbHM+Cgo8ZGV0YWlscz48c3VtbWFyeT5DbGljayB0byBzZWUgZnVuY3Rpb24gZm9yIGFjZiBwbG90cyA8L3N1bW1hcnk+PHA+CkZ1bmN0aW9uIHRvIG1ha2UgQUNGIGFuZCBQQUNGIHBsb3RzIGNvcGllZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9tZGVsaGV5L21kdXRpbHMKCmBgYHtyfQpnZ2FjZiA8LSBmdW5jdGlvbih4LCB0eXBlID0gYygiY29ycmVsYXRpb24iLCAiY292YXJpYW5jZSIsICJwYXJ0aWFsIiksIGNpID0gMC45NSwgLi4uKSB7CiAgICB0eXBlIDwtIG1hdGNoLmFyZyh0eXBlKQogICAgeC5hY2YgPC0gYWNmKHgsIHR5cGUgPSB0eXBlLCBwbG90ID0gRkFMU0UsIC4uLikKICAgIHguZGYgPC0gd2l0aCh4LmFjZiwgZGF0YS5mcmFtZShsYWcsIGFjZikpCiAgICB4LmNpIDwtIHFub3JtKCgxICsgY2kpLzIpIC8gc3FydChsZW5ndGgoeCkpCiAgICBwcmludCh4LmNpKQogICAgZ2dwbG90KGRhdGEgPSB4LmRmLCBhZXMoeCA9IGxhZywgeSA9IGFjZikpICsKICAgICAgICBnZW9tX2hsaW5lKGFlcyh5aW50ZXJjZXB0ID0gMCkpICsKICAgICAgICBnZW9tX3NlZ21lbnQoYWVzKHhlbmQgPSBsYWcsIHllbmQgPSAwKSkgKwogICAgICAgIGdlb21faGxpbmUoeWludGVyY2VwdCA9IGMoeC5jaSwgLXguY2kpLCBjb2xvciA9ICJibHVlIiwgbGluZXR5cGUgPSAiZGFzaGVkIikgKwogICAgICAgIHNjYWxlX3lfY29udGludW91cyhicmVha3MgPSBzZXEoMC4wLCAxLjAsIDAuMikpCn0KYGBgCjwvcD48L2RldGFpbHM+CgoKICAgIAo8YnIgLz4gCgotLS0KCiMjIERhdGEgZXhwbG9yYXRpb24KClNlbGVjdCBjb2lucyBiaXRjb2luIChidGMpLCBldGhlcml1bSAoZXRoKSBhbmQgbGl0ZWNvaW4gKGx0YykgCgpgYGB7ciBtZXNzYWdlPUZBTFNFfQpjb2luU3ltYm9scyA8LSBjKCJidGMiLCAiZXRoIiwgImx0YyIpCmBgYAoKLSBXZSB3YW50IHRvIHJldHJlaXZlIGRhdGEgZnJvbSBKYW51YXJ5IEZpcnN0IDIwMTkgdXAgdG8gdG9kYXkuCi0gV2UgaGF2ZSB0byBjYWxjdWxhdGUgdGhlIG51bWJlciBvZiBkYXlzIGZvciB3aGljaCB3ZSB3YW50IHRvIHJldHJlaXZlIGRhdGEgZm9yIHRoZSBjb2luZ2Vja28gQVBJCgpgYGB7cn0KdG9kYXlzRGF0ZSA8LSBhcy5QT1NJWGx0KFN5cy5EYXRlKCksdHo9IkdNVCIpCnN0YXJ0RGF0ZSA8LSBhcy5QT1NJWGx0KCIyMDE5LTAxLTAxIix0ej0iR01UIikKbmRheXMgPC0gYXMuZG91YmxlKHRvZGF5c0RhdGUgLSBzdGFydERhdGUpICsgMQpgYGAKClJldHJlaXZlIGRhdGEgZnJvbSBjb2luZ2Vja28uIFdlIHdpbGwgdXNlIHRoZSBkZWZhdWx0IGN1cnJlbmN5IChVU0QpLgoKYGBge3J9CmNvaW5EYXRhIDwtICBjb2luU3ltYm9scyAlPiUKICAgICAgbWFwKHJldHJlaXZlQ29pbkRhdGEsZGF5cz1uZGF5cykgJT4lCiAgICAgIHJlZHVjZShsZWZ0X2pvaW4sIGJ5ID0gInRpbWVzdGFtcCIpICU+JQogICAgICBhcnJhbmdlKHRpbWVzdGFtcCkgJT4lIAogICAgICBtdXRhdGUoZGF0ZT1hcy5EYXRlKHRpbWVzdGFtcCkpCmBgYAogICAgCjxiciAvPiAKCgotLS0KCiMjIyBUaW1lIHNlcmllcyBwbG90cyAKCjxkZXRhaWxzPjxzdW1tYXJ5PkNsaWNrIHRvIHNlZSBjb2RlIGZvciBwbG90IDwvc3VtbWFyeT48cD4KYGBge3J9CnRzUGxvdCA8LSBjb2luRGF0YSAlPiUKICBzZWxlY3QoZGF0ZSxlbmRzX3dpdGgoInByaWNlc191c2QiKSkgJT4lCiAgZ2F0aGVyKGNvaW4sIHVzZCwgLWRhdGUpICU+JQogIGdncGxvdChhZXMoZGF0ZSx1c2QpKSArCiAgZ2VvbV9saW5lKCkgKwogIGZhY2V0X3dyYXAofmNvaW4sbnJvdz0zLHNjYWxlcz0iZnJlZV95IikKYGBgCjwvcD48L2RldGFpbHM+CgpgYGB7cn0KdHNQbG90CmBgYAoKYGBge3J9CnRzUGxvdCArIHNjYWxlX3lfY29udGludW91cyh0cmFucz0nbG9nMTAnKQpgYGAKICAgIAoKPGRldGFpbHM+PHN1bW1hcnk+Q2xpY2sgdG8gc2VlIGNvZGUgZm9yIHBsb3QgPC9zdW1tYXJ5PjxwPgpgYGB7cn0KcmV0dXJuUGxvdDEgPC0gY29pbkRhdGEgJT4lCiAgc2VsZWN0KGVuZHNfd2l0aCgicHJpY2VzX3VzZCIpKSAlPiUKICBhcHBseSguLDIsZnVuY3Rpb24oeCkgZGlmZih4KSkgJT4lIAogIGFzX3RpYmJsZSAlPiUgCiAgbXV0YXRlKGRhdGUgPSBjb2luRGF0YSRkYXRlWy0xXSkgJT4lIAogIGdhdGhlcihjb2luLCB1c2QsLWRhdGUpICU+JSAKICBnZ3Bsb3QoYWVzKGRhdGUsdXNkKSkgKwogIGdlb21fcG9pbnQoKSArCiAgeWxhYigiUHJpY2UgRGlmZmVyZW5jZSAoVVNEKSIpICsKICBmYWNldF93cmFwKH5jb2luLG5yb3c9MyxzY2FsZXM9ImZyZWVfeSIpCmBgYAo8L3A+PC9kZXRhaWxzPgoKYGBge3J9CnJldHVyblBsb3QxCmBgYAoKPGRldGFpbHM+PHN1bW1hcnk+Q2xpY2sgdG8gc2VlIGNvZGUgZm9yIHBsb3QgPC9zdW1tYXJ5PjxwPgpgYGB7cn0KcmV0dXJuUGxvdDIgPC0gY29pbkRhdGEgJT4lCiAgc2VsZWN0KGVuZHNfd2l0aCgicHJpY2VzX3VzZCIpKSAlPiUKICBhcHBseSguLDIsZnVuY3Rpb24oeCkgbG9nMTAoeCkgJT4lIGRpZmYpICU+JSAKICBhc190aWJibGUgJT4lIAogIG11dGF0ZShkYXRlID0gY29pbkRhdGEkZGF0ZVstMV0pICU+JSAKICBnYXRoZXIoY29pbiwgbG9nX3JldHVybiwtZGF0ZSkgJT4lIAogIGdncGxvdChhZXMoZGF0ZSxsb2dfcmV0dXJuKSkgKwogIGdlb21fcG9pbnQoKSArCiAgeWxhYigiRGFpbHkgTG9nIFJldHVybiAobG9nMTApIikgKwogIGZhY2V0X3dyYXAofmNvaW4sbnJvdz0zLHNjYWxlcz0iZnJlZV95IikKYGBgCjwvcD48L2RldGFpbHM+CgpgYGB7cn0KcmV0dXJuUGxvdDIKYGBgICAKCgoKLS0tCgo8YnIgLz4gCgojIyMgQ29ycmVsYXRpb24gU3RydWN0dXJlCgojIyMjIENvcnJlbGF0aW9uIGJldHdlZW4gY3J5cHRvY3VycmVuY3kgdGltZXNlcmllcwoKPGRldGFpbHM+PHN1bW1hcnk+Q2xpY2sgdG8gc2VlIGNvZGUgZm9yIHBsb3QgPC9zdW1tYXJ5PjxwPgpgYGB7ciBtZXNzYWdlPUZBTFNFfQpwbG90Q29pbkRhdGEgPC0gY29pbkRhdGEgJT4lCiAgbXV0YXRlKHllYXIgPSBmb3JtYXQoZGF0ZSwiJVkiKSAlPiUgYXMuZmFjdG9yKSAlPiUKICBzZWxlY3QoeWVhcixlbmRzX3dpdGgoInByaWNlc191c2QiKSkgJT4lCiAgZ2dwYWlycyhwcm9ncmVzcyA9IEZBTFNFLAogIG1hcHBpbmc9Z2dwbG90Mjo6YWVzKGNvbG91ciA9IHllYXIpKQpgYGAKPC9wPjwvZGV0YWlscz4KCmBgYHtyIHJlc3VsdHM9ImhpZGUifQpwbG90Q29pbkRhdGEKYGBgCgotIFRoZXJlIGlzIGEgc3Ryb25nIGNvcnJlbGF0aW9uIGJldHdlZW4gdGhlIGNyeXB0b2N1cnJlbmN5IHRpbWVzZXJpZXMhCgotIFRoZSBjb3JyZWxhdGlvbiBiZXR3ZWVuIHRoZSBjcnlwdG9jdXJyZW5jaWVzIHNlZW1zIHRvIGNoYW5nZSBvdmVyIHRpbWUgKER5bmFtaWMgaGVkZ2UgcmF0aW8ncz8pCiAgICAKPGJyIC8+IAoKCiMjIyMgQXV0b2NvcnJlbGF0aW9uICh3aXRoaW4gdGltZXNlcmllcykKCkF1dG9jb3JyZWxhdGlvbjogClxbXHRleHR7Y29yfVt5X3QseV97dC1rfV1cXSB3aXRoIGxhZyAkaz0xLDIsMyxcbGRvdHMkCgo8ZGV0YWlscz48c3VtbWFyeT5DbGljayB0byBzZWUgY29kZSBmb3IgcGxvdCA8L3N1bW1hcnk+PHA+CmBgYHtyfQphY2ZQbG90cyA8LSBwYXN0ZTAoY29pblN5bWJvbHMsIl9wcmljZXNfdXNkIikgJT4lCiAgbWFwKAogICAgZnVuY3Rpb24oeCxjb2luRGF0YSkKICAgICAgY29pbkRhdGEgJT4lCiAgICAgIHB1bGwoeCkgJT4lCiAgICAgIGxvZzEwICU+JQogICAgICBnZ2FjZiArCiAgICAgIGdndGl0bGUoeCksCiAgICAgIGNvaW5EYXRhPWNvaW5EYXRhCiAgICAgICkKYGBgCjwvcD48L2RldGFpbHM+CgpgYGB7cn0KZ3JpZC5hcnJhbmdlKGdyb2JzPWFjZlBsb3RzKQpgYGAKCi0gVGhlcmUgaXMgIGEgdmVyeSBzdHJvbmcgYXV0b2NvcnJlbGF0aW9uIHdpdGhpbiB0aW1lIHNlcmllcyEKLSBJbmRlZWQgdGhlIHByaWNlIGF0IHRpbWUgdCBpcyBzdHJvbmdseSBjb3JyZWxhdGVkIHRvIHRoYXQgYXQgYSBmZXcgZGF5cyAobGFncyBrKSBlYXJsaWVyLgoKICAgIAo8YnIgLz4gCgotLS0KClBhcnRpYWwgY29ycmVsYXRpb24/CgpcW1x0ZXh0e2Nvcn1beV90LHlfe3Qta31cdmVydCB5X3t0LTF9XGxkb3RzIHlfe3QtaysxfV1cXQoKPGRldGFpbHM+PHN1bW1hcnk+Q2xpY2sgdG8gc2VlIGNvZGUgZm9yIHBsb3QgPC9zdW1tYXJ5PjxwPgpgYGB7cn0KcGFjZlBsb3RzIDwtIHBhc3RlMChjb2luU3ltYm9scywiX3ByaWNlc191c2QiKSAlPiUKICBtYXAoCiAgICBmdW5jdGlvbih4LGNvaW5EYXRhKQogICAgICBjb2luRGF0YSAlPiUKICAgICAgcHVsbCh4KSAlPiUKICAgICAgbG9nMTAgJT4lCiAgICAgIGdnYWNmKHR5cGU9InBhcnRpYWwiKSArCiAgICAgIHlsYWIoIlBhcnRpYWwgQUNGIikgKwogICAgICBnZ3RpdGxlKHgpLAogICAgICBjb2luRGF0YT1jb2luRGF0YQogICAgICApCmBgYAo8L3A+PC9kZXRhaWxzPgoKYGBge3J9CmdyaWQuYXJyYW5nZShncm9icz1wYWNmUGxvdHMpCmBgYAoKCi0gVGhlIHBhcnRpYWwgQUNGIG9ubHkgc2hvd3MgYSBkaXJlY3QgY29ycmVsYXRpb24gYmV0d2VlbiB0aGUgY3VycmVudCBwcmljZSBhbmQgdGhlIHByaWNlIGF0IHRoZSBwcmV2aW91cyBkYXkgKGxhZyAxKS4gIAotIEhlbmNlLCB0aGUgcHJpY2Ugb2YgY3J5cHRvY3VycmVuY2llcyBzZWVtcyB1bmNvcnJlbGF0ZWQgd2l0aCB0aGF0IGluIHRoZSBwYXN0IHdoZW4gd2UgY29uZGl0aW9uIG9uIHllc3RlcmRheXMgcHJpY2UuCgpcW1xsZG90cyBccmlnaHRhcnJvdyB5X3t0LTJ9IFxyaWdodGFycm93IHlfe3QtMX0gXHJpZ2h0YXJyb3cgeV90IFxyaWdodGFycm93IHlfe3QrMX0gXHJpZ2h0YXJyb3cgXGxkb3RzIFxdCiAgICAKPGJyIC8+IAoKCiMjIyBOb3JtYWxpdHkKCjxkZXRhaWxzPjxzdW1tYXJ5PkNsaWNrIHRvIHNlZSBjb2RlIGZvciBwbG90IDwvc3VtbWFyeT48cD4KYGBge3J9CnFxcGxvdHMgPC0gY29pbkRhdGEgJT4lCiAgc2VsZWN0KGVuZHNfd2l0aCgicHJpY2VzX3VzZCIpKSAlPiUKICBhcHBseSguLDIsZnVuY3Rpb24oeCkgbG9nMTAoeCkgJT4lIGRpZmYpICU+JSAKICBhc190aWJibGUgJT4lIAogIG11dGF0ZShkYXRlID0gY29pbkRhdGEkZGF0ZVstMV0pICU+JSAKICBnYXRoZXIoY29pbiwgbG9nX3JldHVybiwtZGF0ZSkgJT4lIAogIGdncGxvdChhZXMoc2FtcGxlID0gbG9nX3JldHVybikpICsKICBnZW9tX3FxKCkgKyAKICBnZW9tX3FxX2xpbmUoKSArIAogIGZhY2V0X3dyYXAofmNvaW4sbnJvdz0zLHNjYWxlcz0iZnJlZV95IikKYGBgCjwvcD48L2RldGFpbHM+CgpgYGB7cn0KcXFwbG90cwpgYGAKCi0gVGhlIGxvZy1kaWZmZXJlbmNlZCBkYXRhIGFyZSBzeW1tZXRyaWMgYnV0IG5vbi1ub3JtYWxseSBkaXN0cmlidXRlZAotIEluIHRoZSByZW1haW5kZXIgd2Ugd2lsbCBpbnRyb2R1Y2UgR2F1c3NpYW4gU3RhdGUgU3BhY2UgTW9kZWxzCi0gSG93ZXZlciwgaWYgdGhlIHRpbWVzZXJpZXMgYXJlIG5vbi1HYXVzc2lhbiB0aGUgcGFyYW1ldGVyIGVzdGltYXRvcnMgYXJlIHN0aWxsIGFzc3ltcHRvdGljYWxseSBub3JtYWxseSBkaXN0cmlidXRlZC4gCi0gSW4gc2hvcnQgdGltZS1zZXJpZXMgd2UgY2FuIHJlc29ydCB0byB0aGUgYm9vdHN0cmFwIHRvIHByb3ZpZGUgYmV0dGVyIGluZmVyZW5jZS4gCgo8YnIgLz4gCgotLS0KCiMgU3RhdGUgU3BhY2UgTW9kZWxzCgojIyBDcnlwdG9jdXJyZW5jeSBleGFtcGxlIAoKLSBXZSB3aWxsIGxvZyRfXHRleHR7MTB9JC10cmFuc2Zvcm0gdGhlIGRhdGEgYW5kIG1vZGVsIGl0IHdpdGggYSBzdGF0ZSBzcGFjZSBtb2RlbC4gCgotIExldCAkXG1hdGhiZnt5fV90JCBiZSBhIHZlY3RvciBvZiB0aGUgbG9nLXRyYW5zZm9ybWVkIHByaWNlcyBvZiBidGMsIGV0aCBhbmQgbHRjIGF0IHRpbWUgJHQkClxbXG1hdGhiZnt5fV90PVxiZWdpbntibWF0cml4fXleXHRleHR7YnRjfV90XFx5Xlx0ZXh0e2V0aH1fdFxceV5cdGV4dHtsdGN9X3RcZW5ke2JtYXRyaXh9XF0KLSBTdXBwb3NlIHRoYXQgdGhleSBhcmUgZHJpdmVuIGJ5IGFuIHVuZGVybHlpbmcgdW5rbm93biBmaXJzdCBvcmRlciBNYXJrb3ZpYW4gY3J5cHRvY3VycmVuY3kgcHJpY2UgbGV2ZWwsIHJlZmVycmVkIHRvIGFzIHRoZSBzdGF0ZSAkXG1hdGhiZntYfSQKXFtcbWF0aGJme1h9PVxiZWdpbntibWF0cml4fVheXHRleHR7YnRjfV90XFxYXlx0ZXh0e2V0aH1fdFxcWF5cdGV4dHtsdGN9X3RcZW5ke2JtYXRyaXh9XF0KLSBTbyB0aGUgYWN0dWFsIG9ic2VydmVkIHByaWNlICRcbWF0aGJme3l9X3QkIGlzIGEgbm9pc3kgcmVhbGlzYXRpb24gb2YgdGhlIHVuZGVybHlpbmcgdW5rbm93biBwcmljZSBsZXZlbCAoc3RhdGUpICAkXG1hdGhiZntYfV90JC4gCgpcWwpcYmVnaW57YXJyYXl9e2NjY2NjY2NjY2NjfVxsZG90cyAmIFxyaWdodGFycm93ICYgXG1hdGhiZntYfV97dC0yfSAmIFxyaWdodGFycm93ICYgXG1hdGhiZntYfV97dC0xfSAmIFxyaWdodGFycm93ICYgXG1hdGhiZntYfV90ICYgXHJpZ2h0YXJyb3cgJiBcbWF0aGJme1h9X3t0KzF9ICYgXHJpZ2h0YXJyb3cgJiBcbGRvdHNcXAomJlxkb3duYXJyb3cmJlxkb3duYXJyb3cmJlxkb3duYXJyb3cmJlxkb3duYXJyb3dcXApcbGRvdHMgJiAgJiBcbWF0aGJme3l9X3t0LTJ9ICYgJiBcbWF0aGJme3l9X3t0LTF9ICYgICYgXG1hdGhiZnt5fV90ICYgJiBcbWF0aGJme3l9X3t0KzF9ICYgICYgXGxkb3RzClxlbmR7YXJyYXl9ClxdCgogICAgCjxiciAvPiAKCi0gQXNzdW1lIHRoYXQgJFxtYXRoYmZ7eX1fdFx2ZXJ0IFxtYXRoYmZ7WH1fdCQgYW5kICRcbWF0aGJme1h9X3RcdmVydCBcbWF0aGJme1h9X3t0LTF9JCBhcmUgbXVsdGl2YXJpYXRlIG5vcm1hbGx5IChNVk4pIGRpc3RyaWJ1dGVkIAoKPGJyIC8+CgotIFdlIGNhbiB0aGFuIGZvcm11bGF0ZSB0aGUgZm9sbG93aW5nIFN0YXRlIFNwYWNlIE1vZGVsOiAKClxbClxsZWZ0XGxicmFjZQpcYmVnaW57YXJyYXl9e2xsbGx9ClxtYXRoYmZ7eX1fdCY9JlxtYXRoYmZ7WH1fdCtcbWF0aGJme3Z9X3QgJlx0ZXh0e3dpdGh9XCBcbWF0aGJme3Z9X3Rcc2ltIE1WTihcbWF0aGJmezB9LFxtYXRoYmZ7Un0pXFwKXG1hdGhiZntYfV90Jj0mXGJvbGRzeW1ib2x7XFBoaX0gXG1hdGhiZntYfV97dC0xfSArIFxtYXRoYmZ7d31fdCAmXHRleHR7d2l0aH1cIFxtYXRoYmZ7d31fdFxzaW0gTVZOKFxtYXRoYmZ7MH0sXG1hdGhiZntRfSkKXGVuZHthcnJheX0KXHJpZ2h0LgpcXQoKd2l0aCAKCi0gJHQgPSAxLCBcbGRvdHMsbiQgCi0gYW4gJDMgXHRpbWVzIDMkIHRyYW5zaXRpb24gbWF0cml4ICRcYm9sZHN5bWJvbHtcUGhpfSQgYW5kIAotIGluZGVwZW5kZW50ICQzIFx0aW1lcyAxJCB2ZWN0b3JzICRcbWF0aGJme3Z9X3QkIGFuZCAkXG1hdGhiZnt3fV90JCB3aXRoIG1lYW4gemVybyBhbmQgdmFyaWFuY2UtY292YXJpYW5jZSBtYXRyaXggJFxtYXRoYmZ7Un0kIGFuZCAkXG1hdGhiZntRfSQsIHJlc3BlY3RpdmVseS4KCgo8YnIgLz4KCi0tLQoKIyMgR2VuZXJhbCBmb3JtdWxhdGlvbiBvZiBTdGF0ZSBTcGFjZSBNb2RlbAoKXFsKXGxlZnRcbGJyYWNlClxiZWdpbnthcnJheX17bGxsbH0KXG1hdGhiZnt5fV90Jj0mXG1hdGhiZntBfV90XG1hdGhiZntYfV90K1xtYXRoYmZ7dn1fdCAmd2l0aFwgXG1hdGhiZnt2fV90XHNpbSBNVk4oXG1hdGhiZnswfSxcbWF0aGJme1J9X3QpXFwKXG1hdGhiZntYfV90Jj0mXGJvbGRzeW1ib2x7XFBoaX1fdCBcbWF0aGJme1h9X3t0LTF9ICsgXG1hdGhiZnt3fV90ICZ3aXRoXCBcbWF0aGJme3d9X3Rcc2ltIE1WTihcbWF0aGJmezB9LFxtYXRoYmZ7UX1fdCkKXGVuZHthcnJheX0KXHJpZ2h0LlxdCgp3aXRoIAoKLSAkdD0xLFxsZG90cywgbiQKLSBmaXJzdCBvcmRlciBNYXJrb3ZpYW4gc3RhdGUgcHJvY2VzcyAkXG1hdGhiZntYfV90PShYX3sxdH0uLi5YX3ttdH0pXlQkLCAKLSAkXG1hdGhiZnt5fV90PSh5X3sxdH0uLi55X3twdH0pXlQkCi0gJFxtYXRoYmZ7dn1fdCBccGVycCBcIVwhXCEgXHBlcnAgXG1hdGhiZnt3fV90JAotICRcbWF0aGJme0F9X3QkIHRoZSAkcCBcdGltZXMgbSQgbWVhc3VyZW1lbnQgb3Igb2JzZXJ2YXRpb24gbWF0cml4IHRoYXQgbGlua3MgJFxtYXRoYmZ7eX1fdCQgdG8gJFxtYXRoYmZ7WH1fdCQKLSBhbiAkbSBcdGltZXMgbSQgdHJhbnNpdGlvbiBtYXRyaXggJFxib2xkc3ltYm9se1xQaGl9X3QkIGFuZCAKCjxiciAvPiAKCk5vdGUsIHRoYXQgdGhlIFN0YXRlIFNwYWNlIE1vZGVsIGlzIHZlcnkgZmxleGlibGUhIAoKLSBCeSBlbWJlZGRpbmcgdGhlIEFSKDEpIHN0cnVjdHVyZSBpbiB0aGUgbWVhc3VyZW1lbnQgZXF1YXRpb24sIHRoZSB0aW1lIHNlcmllcyBtb2RlbCBiZWNvbWVzIG11Y2ggbW9yZSBnZW5lcmFsLiAKLSBXaGVuICRcbWF0aGJme3Z9X3QkIGFuZCAkXG1hdGhiZnt3fV90JCBhcmUgYWxsb3dlZCB0byBiZSBjb3JyZWxhdGVkLCBpdCBjYW4gYmUgc2hvd24gdGhhdCBmb3Igc3BlY2lmaWMgY2hvaWNlcyB0aGUgc3RhdGUtc3BhY2UgbW9kZWwgY2FuIGFsc28gbW9kZWwgc3BlY2lmaWMgQVJNQSBtb2RlbHMuIAotIEV4dGVuc2lvbnMgYXJlIHZlcnkgZmxleGlibGU6IGUuZy4gCiAgICAgCiAgICAgLSBtaXNzaW5nIGRhdGEsIAogICAgIC0gZXhvZ2VuZW91cyBjb3ZhcmlhdGVzLCAKICAgICAtIG1vcmUgY29tcGxleCBhdXRvY29ycmVsYXRpb24gc3RydWN0dXJlcyAKICAgICAtIC4uLgoKLS0tCgo8YnIgLz4KCiMjIFByZWRpY3Rpb24sIEZpbHRlcmluZyAmIFNtb290aGluZwoKLSBGcm9tIGEgcHJhY3RpY2FsIHZpZXcsIGEgcHJpbWFyeSBhaW0gb2YgdGhlIHN0YXRlLXNwYWNlIGFuYWx5c2lzIGlzIHRvIHByb2R1Y2UgZXN0aW1hdGVzIG9mIHRoZSBzdGF0ZXMgJFxtYXRoYmZ7WH1fdCQgYnkgdXNpbmcgYSBzZXQgb2Ygb2JzZXJ2YXRpb25zICRcbWF0aGJme1l9X3I9KFxtYXRoYmZ7eX1fMSxcbGRvdHMsIFxtYXRoYmZ7eX1fcileVCQuCgotIEluZGVlZCB3ZSB3YW50IHRvIGluZmVyIG9uIHRoZSB1bmRlcmx5aW5nIGxhdGVudCBwcmljZSBsZXZlbCEKCi0gVGhlIGVzdGltYXRpb24gb2YgJFxtYXRoYmZ7WH1fdCQgZ2l2ZW4gJFxtYXRoYmZ7WX1fciQgaXMgcmVmZXJyZWQgdG8gYXMKICAgIAogICAgMS4gcHJlZGljdGlvbiBmb3IgJHQ+ciQsCiAgICAyLiBmaWx0ZXJpbmcgZm9yICR0PXIkLCBhbmQKICAgIDMuIHNtb290aGluZyBmb3IgJHQ8ciQKCi0tLQoKPGJyIC8+CgoKIyMgS2FsbWFuIEZpbHRlciBhbmQgU21vb3RoZXIKCiMjIyBDcnlwdG9jdXJyZW5jeSBleGFtcGxlIAoKXFsKXGJlZ2lue2FycmF5fXtjY2NjY2NjY2NjY31cbGRvdHMgJiBccmlnaHRhcnJvdyAmIFxtYXRoYmZ7WH1fe3QtMn0gJiBccmlnaHRhcnJvdyAmIFxtYXRoYmZ7WH1fe3QtMX0gJiBccmlnaHRhcnJvdyAmIFxtYXRoYmZ7WH1fdCAmIFxyaWdodGFycm93ICYgXG1hdGhiZntYfV97dCsxfSAmIFxyaWdodGFycm93ICYgXGxkb3RzXFwKJiZcZG93bmFycm93JiZcZG93bmFycm93JiZcZG93bmFycm93JiZcZG93bmFycm93XFwKXGxkb3RzICYgICYgXG1hdGhiZnt5fV97dC0yfSAmICYgXG1hdGhiZnt5fV97dC0xfSAmICAmIFxtYXRoYmZ7eX1fdCAmICYgXG1hdGhiZnt5fV97dCsxfSAmICAmIFxsZG90c1xcXFwKXGVuZHthcnJheX0KXF0KClxbClxsZWZ0XGxicmFjZQpcYmVnaW57YXJyYXl9e2xsbGx9ClxtYXRoYmZ7eX1fdCY9JlxtYXRoYmZ7WH1fdCtcbWF0aGJme3Z9X3QgJlx0ZXh0e3dpdGh9XCBcbWF0aGJme3Z9X3Rcc2ltIE1WTihcbWF0aGJmezB9LFxtYXRoYmZ7Un0pXFwKXG1hdGhiZntYfV90Jj0mXGJvbGRzeW1ib2x7XFBoaX0gXG1hdGhiZntYfV97dC0xfSArIFxtYXRoYmZ7d31fdCAmXHRleHR7d2l0aH1cIFxtYXRoYmZ7d31fdFxzaW0gTVZOKFxtYXRoYmZ7MH0sXG1hdGhiZntRfSkKXGVuZHthcnJheX0KXHJpZ2h0LgpcXQoKU28gaW4gb3VyIGV4YW1wbGUgJFxtYXRoYmZ7QX1fdD1cbWF0aGJme0l9JAoKLS0tCgo8YnIgLz4KCgojIyMjIEthbG1hbiBGaWx0ZXIKCi0gSW1wb3J0YW50IGZvciBlLmcuIG9ubGluZSBlc3RpbWF0aW9uIGFuZCBwcmVkaWN0aW9uCi0gTGV0ICRcbWF0aGJme1l9X3I9KFxtYXRoYmZ7eX1fMV5ULFxsZG90cyxcbWF0aGJme3l9X3JeVCleVCQgICAKLSBQcmVkaWN0aW9uIHN0ZXA6IFxbXHRleHR7RX1cbGVmdFtcbWF0aGJme1h9X3RcdmVydCBcbWF0aGJme1l9X3t0LTF9XHJpZ2h0XVxdCi0gVXBkYXRlIHN0ZXAgd2hlbiBuZXcgb2JzZXJ2YXRpb24gY29tZXMgaW46IApcW1x0ZXh0e0V9XGxlZnRbXG1hdGhiZntYfV90XHZlcnQgXG1hdGhiZntZfV97dH1ccmlnaHRdXF0KCi0gUHJvdmlkZXMgZWZmaWNpZW50IGZhY3RvcmlzYXRpb24gb2YgdGhlIGxpa2VsaWhvb2QKCmBgYHtyIG1lc3NhZ2U9RkFMU0UsIHJlc3VsdHM9ImhpZGUifQp5IDwtIGNvaW5EYXRhICU+JSAKICBzZWxlY3QoZW5kc193aXRoKCJfcHJpY2VzX3VzZCIpKSAlPiUgCiAgbG9nMTAgJT4lCiAgYXMubWF0cml4CgpudW0gPC0gbnJvdyh5KQoKIyBNZWFzdXJlbWVudCBtYXRyaXggQSA9IEkgCkE9ZGlhZygzKSAgIyBjcmVhdGVzIDN4MyBkaWFnb25hbCBtYXRyaXgKCiMgaW5pdGlhbCB2YWx1ZXMKbXUwIDwtIG1hdHJpeCgwLDMsMSkKU2lnbWEwIDwtIGRpYWcoYyguMSwuMSwuMSksMykKUGhpIDwtIGRpYWcoMSwzKQpjUSA8LSBkaWFnKGMoLjEsLjEsLjEpLDMpCmNSIDwtIGRpYWcoYyguMSwuMSwuMSksMykKCmVtIDwtIEVNMChudW0gPSBudW0sIHkgPSB5LCBBID0gQSwgbXUwID0gbXUwLCBTaWdtYTAgPSBTaWdtYTAsIFBoaSA9IFBoaSwgY1EgPSBjUSwgY1IgPSBjUiwgbWF4Lml0ZXIgPSAxMDAsIHRvbCA9IC4wMDAwMSkKCmtmIDwtIEtmaWx0ZXIwKG51bSA9IG51bSwgeSA9IHksIEEgPSBBLCBtdTAgPSBtdTAsIFNpZ21hMCA9IGVtJFNpZ21hMCwgUGhpID0gZW0kUGhpLCBjUSA9IGNob2woZW0kUSksIGNSID0gY2hvbChlbSRSKSkKYGBgCgo8ZGV0YWlscz48c3VtbWFyeT5DbGljayB0byBzZWUgY29kZSB0byBtYWtlIHBsb3RzIDwvc3VtbWFyeT48cD4KYGBge3J9CmRhdGFIbHAgPC0gY29pbkRhdGEgJT4lCiAgc2VsZWN0KGRhdGUsZW5kc193aXRoKCJwcmljZXNfdXNkIikpICU+JQogIGdhdGhlcihjb2luLCB1c2QsIC1kYXRlKSAlPiUgCiAgbXV0YXRlKHhmID0ga2YkeGZbLDEsXSAlPiUgdCguKSAlPiUgYykgJT4lCiAgbXV0YXRlKHhmbGwgPSAoa2YkeGZbLDEsXSAtCiAgICAgICAgICAgMiAqIHNhcHBseSgxOm5kYXlzLGZ1bmN0aW9uKGkpIGtmJFBmWywsaV0gJT4lIGRpYWcgJT4lIHNxcnQpKSAlPiUgdCguKSAlPiUgYykgJT4lCiBtdXRhdGUoeGZ1bCA9IChrZiR4ZlssMSxdICsKICAgICAgICAgICAyICogc2FwcGx5KDE6bmRheXMsZnVuY3Rpb24oaSkga2YkUGZbLCxpXSAlPiUgZGlhZyAlPiUgc3FydCkpICU+JSB0KC4pICU+JSBjKSAlPiUKICBtdXRhdGUoeHAgPSBrZiR4cFssMSxdICU+JSB0KC4pICU+JSBjKSAlPiUKICBtdXRhdGUoeHBsbCA9IChrZiR4cFssMSxdIC0KICAgICAgICAgICAyICogc2FwcGx5KDE6bmRheXMsZnVuY3Rpb24oaSkga2YkUHBbLCxpXSAlPiUgZGlhZyAlPiUgc3FydCkpICU+JSB0KC4pICU+JSBjKSAlPiUKIG11dGF0ZSh4cHVsID0gKGtmJHhwWywxLF0gKwogICAgICAgICAgIDIgKiBzYXBwbHkoMTpuZGF5cyxmdW5jdGlvbihpKSBrZiRQcFssLGldICU+JSBkaWFnICU+JSBzcXJ0KSkgJT4lIHQoLikgJT4lIGMpIApgYGAKCmBgYHtyfQp0cGxvdCA8LSBhcy5EYXRlKCIyMDIwLTEyLTMxIikKYmFzZVBsb3QgPC0gZGF0YUhscCAlPiUgCiAgZmlsdGVyKGRhdGUgPiB0cGxvdCkgJT4lCiAgZ2dwbG90KGFlcyhkYXRlLHVzZCkpICsKICBnZW9tX3BvaW50KGFscGhhPTApICsKICBmYWNldF93cmFwKH5jb2luLG5yb3c9MyxzY2FsZXM9ImZyZWVfeSIpICsKICB0aGVtZV9taW5pbWFsKCkKCnN0b3BEYXRlIDwtIGRhdGFIbHAgJT4lIHB1bGwoZGF0ZSkgJT4lIG1heApzdGFydERhdGUgPC0gc3RvcERhdGUgLSAzMAoKZGF0YUhscDIgPC0gZGF0YUhscCAlPiUgCiAgZmlsdGVyKGRhdGUgPiB0cGxvdCAmIGRhdGUgPCBzdGFydERhdGUpCgppIDwtIDEKcGxvdEtGaWx0ZXJMaXN0IDwtIGxpc3QoCiAgYmFzZVBsb3QgKwogIGdlb21fcG9pbnQoc2hhcGU9MjEsc2l6ZT0uNSwgZGF0YSA9IGRhdGFIbHAyKSArIAogIGdlb21fcmliYm9uKGFlcyh5bWluID0gMTBeeGZ1bCx5bWF4ID0gMTBeeGZsbCksIGFscGhhID0gMC40NSwgZGF0YSA9IGRhdGFIbHAyKSArCiAgZ2VvbV9saW5lKGFlcyhkYXRlLDEwXnhmKSwgZGF0YSA9IGRhdGFIbHAyKSArIAogIGdndGl0bGUoIiAiKSAKICApCgpmb3IgKHQgaW4gc2VxKHN0YXJ0RGF0ZSxzdG9wRGF0ZSwxKSkKewpkYXRhSGxwMiA8LSBkYXRhSGxwICU+JSAKICBmaWx0ZXIoZGF0ZSA+IHRwbG90ICYgZGF0ZSA8IHQpCmkgPC0gaSsxIApwbG90S0ZpbHRlckxpc3RbW2ldXSA8LSBiYXNlUGxvdCArCiAgZ2VvbV9wb2ludChzaGFwZT0yMSxzaXplPS41LCBkYXRhID0gZGF0YUhscDIpICsgCiAgZ2VvbV9yaWJib24oYWVzKHltaW4gPSAxMF54ZnVsLHltYXggPSAxMF54ZmxsKSwgYWxwaGEgPSAwLjQ1LCBkYXRhID0gZGF0YUhscDIpICsKICBnZW9tX2xpbmUoYWVzKGRhdGUsMTBeeGYpLCBkYXRhID0gZGF0YUhscDIpICsKICBnZW9tX3BvaW50KGFlcyhkYXRlLDEwXnhwKSxkYXRhID0gZGF0YUhscCAlPiUgZmlsdGVyKGRhdGUgPT0gdCksY29sb3I9MikgKwogICBnZW9tX3NlZ21lbnQoYWVzKHggPSBkYXRlLCB5ID0gMTBeeHBsbCwgeGVuZCA9IGRhdGUsIHllbmQgPSAxMF54cHVsKSwgY29sb3IgPSAyLCBkYXRhID0gZGF0YUhscCAlPiUgZmlsdGVyKGRhdGUgPT0gdCkpICsKICAgZ2d0aXRsZSgiUHJlZGljdGlvbiIpCgppIDwtIGkrMSAKcGxvdEtGaWx0ZXJMaXN0W1tpXV0gPC0gcGxvdEtGaWx0ZXJMaXN0W1tpLTFdXSArCiAgZ2VvbV9wb2ludChhZXMoZGF0ZSx1c2QpLGRhdGEgPSBkYXRhSGxwICU+JSBmaWx0ZXIoZGF0ZSA9PSB0KSkgKyAKICBnZ3RpdGxlKCJOZXcgb2JzZXJ2YXRpb24gYXJyaXZlcyIpCgppIDwtIGkgKyAxCmRhdGFIbHAyIDwtIGRhdGFIbHAgJT4lIAogIGZpbHRlcihkYXRlID4gdHBsb3QgJiBkYXRlIDw9IHQpCnBsb3RLRmlsdGVyTGlzdFtbaV1dIDwtICAgYmFzZVBsb3QgKwogIGdlb21fcG9pbnQoc2hhcGU9MjEsc2l6ZT0uNSwgZGF0YSA9IGRhdGFIbHAyKSArIAogIGdlb21fcmliYm9uKGFlcyh5bWluID0gMTBeeGZ1bCx5bWF4ID0gMTBeeGZsbCksIGFscGhhID0gMC40NSwgZGF0YSA9IGRhdGFIbHAyKSArCiAgZ2VvbV9saW5lKGFlcyhkYXRlLDEwXnhmKSwgZGF0YSA9IGRhdGFIbHAyKSArIAogIGdlb21fcG9pbnQoYWVzKGRhdGUsMTBeeHApLGRhdGEgPSBkYXRhSGxwICU+JSBmaWx0ZXIoZGF0ZSA9PSB0KSxjb2xvcj0yKSArCiAgZ2VvbV9zZWdtZW50KGFlcyh4ID0gZGF0ZSwgeSA9IDEwXnhwbGwsIHhlbmQgPSBkYXRlLCB5ZW5kID0gMTBeeHB1bCksIGNvbG9yID0gMiwgZGF0YSA9IGRhdGFIbHAgJT4lIGZpbHRlcihkYXRlID09IHQpKSArCiAgZ2VvbV9wb2ludChhZXMoZGF0ZSx1c2QpLGRhdGEgPSBkYXRhSGxwICU+JSBmaWx0ZXIoZGF0ZSA9PSB0KSkgKwogIGdndGl0bGUoIlVwZGF0ZSBGaWx0ZXIiKSAKfQpgYGAKPC9wPjwvZGV0YWlscz4KCmBgYHtyLCBhbmltYXRpb24uaG9vaz0iZ2lmc2tpIiwgZWNobz1GQUxTRSwgbWVzc2FnZSA9IEZBTFNFLCByZXN1bHRzPSJoaWRlIiwgaW50ZXJ2YWw9LjV9CmZvciAoayBpbiAxOjcpIAp7CiAgICBmb3IgKGkgaW4gMTo1KSBwcmludChwbG90S0ZpbHRlckxpc3RbW2tdXSkKfQpmb3IgKGsgaW4gODpsZW5ndGgocGxvdEtGaWx0ZXJMaXN0KSkgcHJpbnQocGxvdEtGaWx0ZXJMaXN0W1trXV0pCmBgYAoKCiMjIyMgS2FsbWFuIFNtb290aGVyCgotIE9mZmxpbmUgYXBwbGljYXRpb25zOiBVc2UgYWxsIGF2YWlsYWJsZSBpbmZvcm1hdGlvbiAkXG1hdGhiZntZfV9OPShcbWF0aGJme3l9XzFeVCxcbGRvdHMsXG1hdGhiZnt5fV9uXlQpXlQkLgotIFNtb290aGVkIGVzdGltYXRvciBhbHNvIGJhc2VkIG9uIG1lYXN1cmVtZW50cyBvbiBsYXRlciB0aW1lIGluc3RhbnRzICR0KzEsXGxkb3RzLG4kOiAkXHRleHR7RX1cbGVmdFtcbWF0aGJme1h9X3RcdmVydCBcbWF0aGJme1l9X05ccmlnaHRdJAoKCmBgYHtyfQprcyA8LSBLc21vb3RoMChudW0gPSBudW0sIHkgPSB5LCBBID0gQSwgbXUwID0gbXUwLCBTaWdtYTAgPSBlbSRTaWdtYTAsIFBoaSA9IGVtJFBoaSwgY1EgPSBjaG9sKGVtJFEpLCBjUiA9IGNob2woZW0kUikpCmBgYAoKCjxkZXRhaWxzPjxzdW1tYXJ5PkNsaWNrIHRvIHNlZSBjb2RlIGZvciBwbG90IDwvc3VtbWFyeT48cD4KYGBge3J9CnRwbG90IDwtIGFzLkRhdGUoIjIwMjAtMTItMzEiKQpiYXNlUGxvdCA8LSBkYXRhSGxwICU+JSAKICBmaWx0ZXIoZGF0ZSA+IHRwbG90KSAlPiUKICBnZ3Bsb3QoYWVzKGRhdGUsdXNkKSkgKwogIGdlb21fcG9pbnQoYWxwaGE9MCkgKwogIGZhY2V0X3dyYXAofmNvaW4sbnJvdz0zLHNjYWxlcz0iZnJlZV95IikgKwogIHRoZW1lX21pbmltYWwoKQoKZGF0YUhscDIgPC0gZGF0YUhscCAgJT4lIAogIG11dGF0ZSh4cyA9IGtzJHhzWywxLF0gJT4lIHQoLikgJT4lIGMpICU+JQogIG11dGF0ZSh4c2xsID0gKGtzJHhzWywxLF0gLQogICAgICAgICAgIDIgKiBzYXBwbHkoMTpuZGF5cyxmdW5jdGlvbihpKSBrcyRQc1ssLGldICU+JSBkaWFnICU+JSBzcXJ0KSkgJT4lIHQoLikgJT4lIGMpICU+JQogbXV0YXRlKHhzdWwgPSAoa3MkeHNbLDEsXSArCiAgICAgICAgICAgMiAqIHNhcHBseSgxOm5kYXlzLGZ1bmN0aW9uKGkpIGtzJFBmWywsaV0gJT4lIGRpYWcgJT4lIHNxcnQpKSAlPiUgdCguKSAlPiUgYykKCgpwbG90S0ZpbHRlclByZWRpY3Rpb24gPC0gYmFzZVBsb3QgKwogIGdlb21fcG9pbnQoc2hhcGU9MjEsc2l6ZT0uNSwgZGF0YSA9IGRhdGFIbHAyICU+JSBmaWx0ZXIoZGF0ZSA+IHRwbG90KSkgKyAKICBnZW9tX3JpYmJvbihhZXMoeW1pbiA9IDEwXnhwdWwseW1heCA9IDEwXnhwbGwpLCBhbHBoYSA9IDAuNDUsIGRhdGEgPSBkYXRhSGxwMiAlPiUgZmlsdGVyKGRhdGUgPiB0cGxvdCkpICsKICBnZW9tX2xpbmUoYWVzKGRhdGUsMTBeeHApLCBkYXRhID0gZGF0YUhscDIgJT4lIGZpbHRlcihkYXRlID4gdHBsb3QpKSArIAogIGdndGl0bGUoIkthbG1hbiBvbmUtc3RlcC1haGVhZCBwcmVkaWN0aW9uIikgCgpwbG90S0ZpbHRlciA8LSBiYXNlUGxvdCArCiAgZ2VvbV9wb2ludChzaGFwZT0yMSxzaXplPS41LCBkYXRhID0gZGF0YUhscDIgJT4lIGZpbHRlcihkYXRlID4gdHBsb3QpKSArIAogIGdlb21fcmliYm9uKGFlcyh5bWluID0gMTBeeGZ1bCx5bWF4ID0gMTBeeGZsbCksIGFscGhhID0gMC40NSwgZGF0YSA9IGRhdGFIbHAyICU+JSBmaWx0ZXIoZGF0ZSA+IHRwbG90KSkgKwogIGdlb21fbGluZShhZXMoZGF0ZSwxMF54ZiksIGRhdGEgPSBkYXRhSGxwMiAlPiUgZmlsdGVyKGRhdGUgPiB0cGxvdCkpICsgCiAgZ2d0aXRsZSgiS2FsbWFuIGZpbHRlciIpIAoKcGxvdEtTbW9vdGhlciA8LSBiYXNlUGxvdCArCiAgZ2VvbV9wb2ludChzaGFwZT0yMSxzaXplPS41LCBkYXRhID0gZGF0YUhscDIgJT4lIGZpbHRlcihkYXRlID4gdHBsb3QpKSArIAogIGdlb21fcmliYm9uKGFlcyh5bWluID0gMTBeeHN1bCx5bWF4ID0gMTBeeHNsbCksIGFscGhhID0gMC40NSwgZGF0YSA9IGRhdGFIbHAyICU+JSBmaWx0ZXIoZGF0ZSA+IHRwbG90KSkgKwogIGdlb21fbGluZShhZXMoZGF0ZSwxMF54cyksIGRhdGEgPSBkYXRhSGxwMiAlPiUgZmlsdGVyKGRhdGUgPiB0cGxvdCkpICsgCiAgZ2d0aXRsZSgiS2FsbWFuIHNtb290aGVyIikgCmBgYAo8L3A+PC9kZXRhaWxzPgoKYGBge3IsIGFuaW1hdGlvbi5ob29rPSJnaWZza2kiLCBtZXNzYWdlID0gRkFMU0UsIHJlc3VsdHM9ImhpZGUiLCBpbnRlcnZhbCA9IDR9CnBsb3RLRmlsdGVyUHJlZGljdGlvbgpwbG90S0ZpbHRlcgpwbG90S1Ntb290aGVyCmBgYAoKLS0tCgo8YnIgLz4KCiMjIyBVbmRlciB0aGUgaG9vZCBvZiB0aGUgS2FsbWFuIEZpbHRlcgoKR2VuZXJhbCBmb3JtdWxhdGlvbiBvZiB0aGUgU3RhdGUgU3BhY2UgTW9kZWwgCgpcWwpcbGVmdFxsYnJhY2UKXGJlZ2lue2FycmF5fXtsbGxsfQpcbWF0aGJme3l9X3QmPSZcbWF0aGJme0F9X3RcbWF0aGJme1h9X3QrXG1hdGhiZnt2fV90ICZ3aXRoXCBcbWF0aGJme3Z9X3Rcc2ltIE1WTihcbWF0aGJmezB9LFxtYXRoYmZ7Un1fdClcXApcbWF0aGJme1h9X3QmPSZcYm9sZHN5bWJvbHtcUGhpfV90IFxtYXRoYmZ7WH1fe3QtMX0gKyBcbWF0aGJme3d9X3QgJndpdGhcIFxtYXRoYmZ7d31fdFxzaW0gTVZOKFxtYXRoYmZ7MH0sXG1hdGhiZntRfV90KQpcZW5ke2FycmF5fQpccmlnaHQuXF0KCkFzc3VtZSB0aGF0IGZvbGxvd2luZyBhcmUga25vd24KCi0gJFxtYXRoYmZ7WX1fe3QtMX09KFxtYXRoYmZ7eX1fMV5ULFxsZG90cyxcbWF0aGJme3l9X3t0LTF9XlQpXlQkCi0gJFxtYXRoYmZ7WH1fe3QtMVx2ZXJ0IHQtMX09XHRleHR7RX1cbGVmdFtcbWF0aGJme1h9X3t0LTF9XHZlcnQgXG1hdGhiZntZfV97dC0xfVxyaWdodF0kIAotICRcbWF0aGJme1B9X3t0LTFcdmVydCB0LTF9PVx0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme1h9X3t0LTF9XHZlcnQgXG1hdGhiZntZfV97dC0xfVxyaWdodF0kIAoKCi0tLQoKCjxiciAvPgoKCiMjIyMgUHJlZGljdGlvbiBTdGVwCgpcWwpcbGVmdFxsYnJhY2UKXGJlZ2lue2FycmF5fXtsbGxsfQpcbWF0aGJme3l9X3QmPSZcbWF0aGJme0F9X3RcbWF0aGJme1h9X3QrXG1hdGhiZnt2fV90ICZ3aXRoXCBcbWF0aGJme3Z9X3Rcc2ltIE1WTihcbWF0aGJmezB9LFxtYXRoYmZ7Un1fdClcXApcbWF0aGJme1h9X3QmPSZcYm9sZHN5bWJvbHtcUGhpfV90IFxtYXRoYmZ7WH1fe3QtMX0gKyBcbWF0aGJme3d9X3QgJndpdGhcIFxtYXRoYmZ7d31fdFxzaW0gTVZOKFxtYXRoYmZ7MH0sXG1hdGhiZntRfV90KQpcZW5ke2FycmF5fQpccmlnaHQuXF0KCjxiciAvPgoKClxbClxiZWdpbnthcnJheX17cmNsfQpcbWF0aGJme1h9X3RcdmVydFxtYXRoYmZ7WX1fe3QtMX0mXHNpbSYgTVZOKFxtYXRoYmZ7WH1fe3RcdmVydCB0LTF9LCBcbWF0aGJme1B9X3t0XHZlcnQgdC0xfSlcXFxcClxtYXRoYmZ7WH1fe3RcdmVydCB0LTF9Jj0mXHRleHR7RX1cbGVmdFtcbWF0aGJme1h9X3RcdmVydFxtYXRoYmZ7WX1fe3QtMX1ccmlnaHRdXFwmPSZcYm9sZHN5bWJvbHtcUGhpfV90XHRleHR7RX1cbGVmdFtcbWF0aGJme1h9X3t0LTF9XHZlcnRcbWF0aGJme1l9X3t0LTF9XHJpZ2h0XVxcCiY9Jlxib2xkc3ltYm9se1xQaGl9X3QgXG1hdGhiZntYfV97dC0xXHZlcnQgdC0xfVxcXFwKXG1hdGhiZntQfV97dFx2ZXJ0IHQtMX0mPSZcdGV4dHtWYXJ9XGxlZnRbXG1hdGhiZntYfV90XHZlcnRcbWF0aGJme1l9X3t0LTF9XHJpZ2h0XSBcXCY9JiBcYm9sZHN5bWJvbHtcUGhpfV90IFx0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme1h9X3t0LTF9XHZlcnRcbWF0aGJme1l9X3t0LTF9XHJpZ2h0XSAgXGJvbGRzeW1ib2x7XFBoaX1fdF5UK1x0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme3d9X3RcdmVydCBcbWF0aGJme1l9X3t0LTF9XHJpZ2h0XVxcCiY9Jlxib2xkc3ltYm9se1xQaGl9X3QgXG1hdGhiZntQfV97dC0xXHZlcnQgdC0xfSBcYm9sZHN5bWJvbHtcUGhpfV90XlQrXG1hdGhiZntRfV90LgogXGVuZHthcnJheX0KXF0KCk9uZSBzdGVwIGFoZWFkIHByZWRpY3Rpb246IFxbXHRleHR7RX1cbGVmdFtcbWF0aGJme3l9X3t0fVx2ZXJ0IFxtYXRoYmZ7WX1fe3QtMX1ccmlnaHRdPVxtYXRoYmZ7QX1fdFxtYXRoYmZ7WH1fe3RcdmVydCB0LTF9XF0KCi0tLQoKCjxiciAvPgoKIyMjIyBVcGRhdGUgU3RlcApcWwpcbGVmdFxsYnJhY2UKXGJlZ2lue2FycmF5fXtsbGxsfQpcbWF0aGJme3l9X3QmPSZcbWF0aGJme0F9X3RcbWF0aGJme1h9X3QrXG1hdGhiZnt2fV90ICZ3aXRoXCBcbWF0aGJme3Z9X3Rcc2ltIE1WTihcbWF0aGJmezB9LFxtYXRoYmZ7Un1fdClcXApcbWF0aGJme1h9X3QmPSZcYm9sZHN5bWJvbHtcUGhpfV90IFxtYXRoYmZ7WH1fe3QtMX0gKyBcbWF0aGJme3d9X3QgJndpdGhcIFxtYXRoYmZ7d31fdFxzaW0gTVZOKFxtYXRoYmZ7MH0sXG1hdGhiZntRfV90KQpcZW5ke2FycmF5fQpccmlnaHQuXF0KCjxiciAvPgoKSWYgb2JzZXJ2YXRpb24gJFxtYXRoYmZ7eX1fdCQgYXQgdGltZSAkdCQgYmVjb21lcyBhdmFpbGFibGUKClxbClxiZWdpbnthcnJheX17cmNsfQpcbWF0aGJme1h9X3RcdmVydFxtYXRoYmZ7WX1fe3QtMX0mXHNpbSYgTVZOKFxtYXRoYmZ7WH1fe3RcdmVydCB0fSwgXG1hdGhiZntQfV97dFx2ZXJ0IHR9KVxcXFwKXG1hdGhiZntYfV97dFx2ZXJ0IHR9Jj0mXHRleHR7RX1cbGVmdFtcbWF0aGJme1h9X3RcdmVydCBcbWF0aGJme1l9X3t0fVxyaWdodF1cXAomPSZcdGV4dHtFfVxsZWZ0W1xtYXRoYmZ7WH1fdFx2ZXJ0IFxtYXRoYmZ7WX1fe3QtMX0sIFxib2xkc3ltYm9se3l9X3RccmlnaHRdXFxcXApcbWF0aGJme1B9X3t0XHZlcnQgdH0gJj0mIFx0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme1h9X3RcdmVydFxtYXRoYmZ7WX1fdFxyaWdodF1cXAomPSZcdGV4dHtWYXJ9XGxlZnRbXG1hdGhiZntYfV90XHZlcnRcbWF0aGJme1l9X3t0LTF9LFxtYXRoYmZ7eX1fdFxyaWdodF0KXGVuZHthcnJheX0KXF0KCkV4cGxvaXQgdGhhdCAkXG1hdGhiZntYfV90JCBhbmQgJFxtYXRoYmZ7eX1fdCQgZ2l2ZW4gJFxtYXRoYmZ7WX1fe3QtMX0kIGFyZSBtdWx0aXZhcmlhdGUgbm9ybWFsbHkgZGlzdHJpYnV0ZWQhIApcW1xsZWZ0LlxiZWdpbntibWF0cml4fQpcbWF0aGJme1h9X3RcXApcbWF0aGJme3l9X3QKXGVuZHtibWF0cml4fSBccmlnaHRcdmVydCBcbWF0aGJme1l9X3t0LTF9ICBcc2ltIE1WTlxsZWZ0KFxiZWdpbntibWF0cml4fQpcbWF0aGJme1h9X3t0XHZlcnQgdC0xfVxcClxtYXRoYmZ7QX1fe3R9XG1hdGhiZntYfV97dFx2ZXJ0IHQtMX0KXGVuZHtibWF0cml4fSwgXGJlZ2lue2JtYXRyaXh9ClxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9JlxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9XG1hdGhiZntBfV97dH1eVFxcClxtYXRoYmZ7QX1fe3R9IFxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9Jlxib2xkc3ltYm9se1xTaWdtYX1fdApcZW5ke2JtYXRyaXh9XHJpZ2h0KQpcXQoKV2l0aCAKClxbXGJlZ2lue2FycmF5fXtsY2x9Clxib2xkc3ltYm9se1xTaWdtYX1fdD1cdGV4dHtWYXJ9XGxlZnRbXG1hdGhiZnt5fV90XHZlcnQgXG1hdGhiZntZfV97dC0xfVxyaWdodF0mPSZcdGV4dHtWYXJ9XGxlZnRbXG1hdGhiZntBfV90XG1hdGhiZntYfV90K1xtYXRoYmZ7dn1fdFx2ZXJ0XG1hdGhiZntZfV97dC0xfVxyaWdodF1cXCY9JlxtYXRoYmZ7QX1fdFx0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme1h9X3RcdmVydCBcbWF0aGJme1l9X3t0LTF9XHJpZ2h0XVxtYXRoYmZ7QX1fdF5UK1x0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme3Z9X3RccmlnaHRdXFwKJj0mXG1hdGhiZntBfV90IFxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9IFxtYXRoYmZ7QX1fdF5UICsgXG1hdGhiZntSfV90ClxlbmR7YXJyYXl9XF0KCgpJdCBjYW4gYmUgc2hvd24gdGhhdCAkXG1hdGhiZntYfV90XHZlcnQgXG1hdGhiZntZfV90JCBpcyB0aGUgQmVzdCBMaW5lYXIgVW5iaWFzZWQgUHJlZGljdG9yIEJMVVAgYnkgZXhwbG9pdGluZyB0aGUgY29uZGl0aW9uYWwgZXhwZWN0YXRpb24gZm9yIGpvaW50bHkgbXVsdGl2YXJpYXRlIG5vcm1hbCBkYXRhIChTZWUgW3dpa2lwZWRpYV0oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTXVsdGl2YXJpYXRlX25vcm1hbF9kaXN0cmlidXRpb24jQ29uZGl0aW9uYWxfZGlzdHJpYnV0aW9ucykKKS4KClxbClxiZWdpbnthcnJheX17cmNsfQpcdGV4dHtFfVxsZWZ0W1xtYXRoYmZ7WH1fdFx2ZXJ0XG1hdGhiZntZfV97dC0xfSxcbWF0aGJme3l9X3RccmlnaHRdCiY9Jlx0ZXh0e0V9XGxlZnRbXG1hdGhiZntYfV90XHZlcnQgXG1hdGhiZntZfV97dC0xfVxyaWdodF0rXHRleHR7Q292fVxsZWZ0W1xtYXRoYmZ7WH1fdCxcbWF0aGJme3l9X3RcdmVydFxtYXRoYmZ7WX1fe3QtMX1ccmlnaHRdXHRleHR7VmFyfVxsZWZ0W1xtYXRoYmZ7eX1fdFx2ZXJ0XG1hdGhiZntZfV97dC0xfVxyaWdodF1eey0xfVxsZWZ0KFxtYXRoYmZ7eX1fdC1cbWF0aGJme0F9X3RcbWF0aGJme1h9X3t0XHZlcnQgdC0xCn1ccmlnaHQpLFxcClxtYXRoYmZ7WH1fe3RcdmVydCB0fSY9JlxtYXRoYmZ7WH1fe3RcdmVydCB0LTF9K1xtYXRoYmZ7UH1fe3RcdmVydCB0LTF9IFxtYXRoYmZ7QX1fdF5UXGJvbGRzeW1ib2x7XFNpZ21hfV90XnstMX1cbGVmdChcbWF0aGJme3l9X3QtXG1hdGhiZntBfV90XG1hdGhiZntYfV97dFx2ZXJ0IHQtMQp9XHJpZ2h0KSwKXGVuZHthcnJheX0KXF0KCmFuZAoKXFsKXGJlZ2lue2FycmF5fXtyY2x9Clx0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme1h9X3RcdmVydFxtYXRoYmZ7WX1fe3QtMX0sXG1hdGhiZnt5fV90XHJpZ2h0XSY9Jlx0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme1h9X3RcdmVydFxtYXRoYmZ7WX1fe3QtMX1ccmlnaHRdLVx0ZXh0e0Nvdn1cbGVmdFtcbWF0aGJme1h9X3QsXG1hdGhiZnt5fV90XHZlcnRcbWF0aGJme1l9X3t0LTF9XHJpZ2h0XVx0ZXh0e1Zhcn1cbGVmdFtcbWF0aGJme3l9X3RcdmVydFxtYXRoYmZ7WX1fe3QtMX1ccmlnaHRdXnstMX1cdGV4dHtDb3Z9XGxlZnRbXG1hdGhiZntYfV90LFxtYXRoYmZ7eX1fdFx2ZXJ0XG1hdGhiZntZfV97dC0xfVxyaWdodF1eVFxcClxtYXRoYmZ7UH1fe3RcdmVydCB0fSY9JlxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9LVxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9IFxtYXRoYmZ7QX1fdF5UIFxib2xkc3ltYm9se1xTaWdtYX1fdF57LTF9IFxtYXRoYmZ7QX1fdCBcbWF0aGJme1B9X3t0XHZlcnQgdC0xfSwKXGVuZHthcnJheX0KXF0KCk5vdGUsIHRoYXQgcHJlZGljdGlvbiBlcnJvciAvIGlubm92YXRpb246IFxbXGJvbGRzeW1ib2x7XGVwc2lsb259X3QgPVxtYXRoYmZ7eX1fdC1cbWF0aGJme0F9X3RcbWF0aGJme1h9X3t0XHZlcnQgdC0xfVxdCgotICRcYm9sZHN5bWJvbHtcZXBzaWxvbn1fdFwgXHBlcnAgXCFcIVwhIFxwZXJwIFwgXG1hdGhiZnt5fV9yJCBmb3IgYWxsICRyPTEsXGxkb3RzLHQtMSQKLSBcW1xib2xkc3ltYm9se1xlcHNpbG9ufV90IFxzaW0gXHRleHR7TVZOfVxsZWZ0KFxtYXRoYmZ7MH0sXGJvbGRzeW1ib2x7XFNpZ21hCn1fdFxyaWdodClcXQotIGlubm92YXRpb25zIGFyZSBrZXkgdG8gdXNlIEthbG1hbiBGaWx0ZXIgZm9yIGRlY29tcG9zaXRpb24gb2YgdGhlIGxpa2VsaWhvb2QuCgoKCi0tLQoKPGJyIC8+CgojIyMjIFN1bW1hcnkgS2FsbWFuIEZpbHRlcgoKSWYgJFxtYXRoYmZ7WH1fezBcdmVydCAwfSQgYW5kICRcbWF0aGJme1B9X3swXHZlcnQgMH0kIGFyZSBrbm93biwgdGhlbiB0aGUgS2FsbWFuIGZpbHRlciBiZWNvbWVzOgoKZm9yICR0PTEsXGxkb3RzLCBuJCAgIAoKMS4gUHJlZGljdGlvbiBzdGVwCgpcWwpcYmVnaW57YXJyYXl9e3JjbH0KXG1hdGhiZntYfV97dFx2ZXJ0IHQtMX0mPSZcYm9sZHN5bWJvbHtcUGhpfV90IFxtYXRoYmZ7WH1fe3QtMVx2ZXJ0IHQtMX0gXFxcXApcbWF0aGJme1B9X3t0XHZlcnQgdC0xfSY9Jlxib2xkc3ltYm9se1xQaGl9X3QgXG1hdGhiZntQfV97dC0xXHZlcnQgdC0xfSBcYm9sZHN5bWJvbHtcUGhpfV90XlQgKyBcbWF0aGJme1F9X3QuClxlbmR7YXJyYXl9ClxdCgoyLiBVcGRhdGUgc3RlcApcWwpcYmVnaW57YXJyYXl9e3JjbH0KXG1hdGhiZntYfV97dFx2ZXJ0IHR9Jj0mXG1hdGhiZntYfV97dFx2ZXJ0IHQtMX0rIFxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9ICBcbWF0aGJme0F9X3ReVCBcYm9sZHN5bWJvbHtcU2lnbWF9X3Reey0xfSAoXG1hdGhiZnt5fV90IC0gXG1hdGhiZntBfV90IFxtYXRoYmZ7WH1fe3RcdmVydCB0LTF9IClcXFxcClxtYXRoYmZ7UH1fe3RcdmVydCB0fSY9JlxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9LVxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9IFxtYXRoYmZ7QX1fdF5UIFxib2xkc3ltYm9se1xTaWdtYX1fdF57LTF9IFxtYXRoYmZ7QX1fdCBcbWF0aGJme1B9X3t0XHZlcnQgdC0xfVxcXFwKXGJvbGRzeW1ib2x7XFNpZ21hfV90Jj0mXG1hdGhiZntBfV90IFxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9IFxtYXRoYmZ7QX1fdF5UICsgXG1hdGhiZntSfV90LgpcZW5ke2FycmF5fQpcXQoKLS0tCgo8YnIgLz4KCiMjIyBVbmRlciB0aGUgaG9vZCBvZiB0aGUgS2FsbWFuIFNtb290aGVyIAoKLSAkXHRleHR7RX1cbGVmdFtcbWF0aGJme1h9X3RcdmVydCBcbWF0aGJme1l9X05ccmlnaHRdJAoKLSBTdGFydCB3aXRoIHRoZSBmaW5hbCBxdWFudGl0aWVzLCAkXG1hdGhiZntYfV97blx2ZXJ0IG59JCBhbmQgJFxtYXRoYmZ7UH1fe25cdmVydCBufSQgYW5kIHByb2NlZWRzIGJhY2t3YXJkcy4KCi0gRm9yICR0PW4tMSwgXGxkb3RzLCAwJCwgaXQgY29uc2lzdHMgb2YgdGhlIGZvbGxvd2luZyBiYWNrd2FyZCByZWN1cnNpb25zIAoKXGJlZ2lue2FsaWdufQomXG1hdGhiZntYfV97dFx2ZXJ0IG59PVxtYXRoYmZ7WH1fe3RcdmVydCB0fStcbWF0aGJme0p9X3QoXG1hdGhiZntYfV97dCsxXHZlcnQgbn0tXG1hdGhiZntYfV97dCsxXHZlcnQgdH0pIFxsYWJlbHtTU19CMX0gXFwKJlxtYXRoYmZ7UH1fe3RcdmVydCBufT1cbWF0aGJme1B9X3t0XHZlcnQgdH0rXG1hdGhiZntKfV97dH0oXG1hdGhiZntQfV97dCsxXHZlcnQgbn0tXG1hdGhiZntQfV97dCsxXHZlcnQgdH0pXG1hdGhiZntKfV90XntUfSBcbGFiZWx7U1NfQjJ9XFwKJlxtYXRoYmZ7Sn1fdD1cbWF0aGJme1B9X3t0XHZlcnQgdH1cUGhpX3t0KzF9XlRcbWF0aGJme1B9X3t0KzFcdmVydCB0fV57LTF9LiBcbGFiZWx7U1NfQjN9ClxlbmR7YWxpZ259CgoKYGBge3IsIGFuaW1hdGlvbi5ob29rPSJnaWZza2kiLCBtZXNzYWdlID0gRkFMU0UsIHJlc3VsdHM9ImhpZGUiLCBpbnRlcnZhbCA9IDQsIGVjaG8gPSBGQUxTRX0KcGxvdEtGaWx0ZXJQcmVkaWN0aW9uCnBsb3RLRmlsdGVyCnBsb3RLU21vb3RoZXIKYGBgCgotLS0KCjxiciAvPgoKIyMgUGFyYW1ldGVyIEVzdGltYXRpb24KCiMjIyBMaWtlbGlob29kIGFuZCB0aGUgcHJlZGljdGlvbiBlcnJvciBkZWNvbXBvc2l0aW9uCgpDbGFzc2ljYWwgaWlkIHNldHRpbmcsIApcYmVnaW57ZXF1YXRpb24qfQpcbG9nIExfe1xtYXRoYmZ7WV9OfX0oXGJvbGRzeW1ib2x7XFBzaX0pPVxzdW1cbGltaXRzX3t0PTF9Xm4gXGxvZyBwKFxtYXRoYmZ7eV90fSksIApcZW5ke2VxdWF0aW9uKn0KTm90IHBvc3NpYmxlIGZvciBkZXBlbmRlbnQgb2JzZXJ2YXRpb25zLgpTdGF0ZS1zcGFjZSBtb2RlbCBhbGxvd3MgZmFjdG9yaXNhdGlvbiB1c2luZyBjb25kaXRpb25hbCBkZW5zaXR5IGZ1bmN0aW9ucwpcYmVnaW57ZXF1YXRpb24qfQpcbG9nIExfe1xtYXRoYmZ7WX1fTn0oXGJvbGRzeW1ib2x7XFBzaX0pPVxzdW1cbGltaXRzX3t0PTF9Xm5cbG9nIHAoXG1hdGhiZnt5fV90XHZlcnQgXG1hdGhiZntZfV97dC0xfSkKXGVuZHtlcXVhdGlvbip9ClxbXG1hdGhiZnt5fV90XHZlcnRcbWF0aGJme1l9X3t0LTF9XHNpbSBNVk4oXG1hdGhiZntBfV90IFxtYXRoYmZ7WH1fe3RcdmVydCB0LTF9LFxib2xkc3ltYm9se1xTaWdtYX1fdClcXQpcYmVnaW57ZXF1YXRpb24qfQpcbG9nIExfe1xtYXRoYmZ7WX1fTn0oXGJvbGRzeW1ib2x7XFBzaX0pPS1cZnJhY3twbn17Mn1cbG9nIDIgXHBpIC0gXGZyYWN7MX17Mn0gXHN1bVxsaW1pdHNfe3Q9MX1ebiBcbG9nIFx2ZXJ0IFxib2xkc3ltYm9se1xTaWdtYX1fdFx2ZXJ0IC1cZnJhY3sxfXsyfSBcc3VtXGxpbWl0c197dD0xfV5uIFxib2xkc3ltYm9se1xlcHNpbG9ufV90XlQgXGJvbGRzeW1ib2x7XFNpZ21hfV90XnstMX0gXGJvbGRzeW1ib2x7XGVwc2lsb259X3QsCiBcZW5ke2VxdWF0aW9uKn0KCldoaWNoIGNhbiBiZSBlZmZpY2llbnRseSBjYWxjdWxhdGVkIGJ5IHRoZSBLYWxtYW4gZmlsdGVyIGFuZCBjYW4gdGh1cyBiZSB1c2VkIHRvIGVzdGltYXRlIHRoZSBtb2RlbCBwYXJhbWV0ZXJzLiAKCi0tLQoKPGJyIC8+CgojIyMgTWF4aW11bSBMaWtlbGlob29kCgotIE51bWVyaWNhbCBvcHRpbWlzYXRpb24gb2YgbGlrZWxpaG9vZCAob2Z0ZW4gdHJvdWJsZXNvbWUpOiAKICAgIDEuIENob29zZSBpbml0aWFsIHZhbHVlcyBmb3IgdGhlIHBhcmFtZXRlcnMKICAgIDIuIFJ1biBLYWxtYW4gRmlsdGVyIGFuZCBjYWxjdWxhdGUgbGlrZWxpaG9vZCAKICAgIDMuIFJ1biBvbmUgaXRlcmF0aW9uIG9mIE5ld3Rvbi1SYXBoc29uIHdpdGggdGhlIC0yIGxvZyBsaWtlbGlob29kIGFzIGNyaXRlcmlvbiAKICAgIDQuIFJlcGVhdCBzdGVwcyAyLTMgd2l0aCB0aGUgY3VycmVudCBOZXd0b24tUmFwaHNvbiBwYXJhbWV0ZXIgZXN0aW1hdGVzIHVudGlsIGNvbnZlcmdlbmNlLiAKICAgIAo8YnIgLz4gCgotIEZvciB0aW1lIGludmFyaWFudCBzeXN0ZW06IEVNIGFsZ29yaXRobSAob2Z0ZW4gc2xvdykKICAgIAotLS0KCjxiciAvPgoKIyMjIEVNIGFsZ29yaXRobSAKCiMjIyMgQ29tcGxldGUgbGlrZWxpaG9vZCBvZiAkXG1hdGhiZntYfSQgYW5kICRcbWF0aGJme1l9JAoKXGJlZ2lue211bHRsaW5lKn0KXGxvZyBMX3tcbWF0aGJme1l9LFxtYXRoYmZ7WH19KFxib2xkc3ltYm9se1xQc2l9KSBcc2ltIC1cZnJhY3sxfXsyfSBcbG9nfFxib2xkc3ltYm9se1xTaWdtYX1fezB9fCAtXGZyYWN7MX17Mn0gKFxtYXRoYmZ7WH1fMC1cYm9sZHN5bWJvbHtcbXV9XzApXlQgXGJvbGRzeW1ib2x7XFNpZ21hfV97MH1eey0xfSAoXG1hdGhiZntYfV8wLVxib2xkc3ltYm9se1xtdX1fMClcXAogICAgLVxmcmFje259ezJ9IFxsb2cgfFxtYXRoYmZ7UX18LVxmcmFjezF9ezJ9XHN1bV97dD0xfV5uIChcbWF0aGJme1h9X3QtXGJvbGRzeW1ib2x7XFBoaSBYfV97dC0xfSleVCBcbWF0aGJme1F9XnstMX0oXG1hdGhiZntYfV90LVxib2xkc3ltYm9se1xQaGkgWH1fe3QtMX0pXFwgICAgCiAgICAtXGZyYWN7bn17Mn0gXGxvZ3xcbWF0aGJme1J9fCAtXGZyYWN7MX17Mn0gXHN1bV97dD0xfV5uIChcbWF0aGJme1l9X3QtXG1hdGhiZntBfV90XG1hdGhiZntYfV90KV5UXG1hdGhiZntSfV57LTF9KFxtYXRoYmZ7WX1fdC1cbWF0aGJme0F9X3RcbWF0aGJme1h9X3QpLApcZW5ke211bHRsaW5lKn0KCi0gQ2Fubm90IGJlIGNhbGN1bGF0ZWQ6IHN0YXRlIGlzIHVub2JzZXJ2YWJsZQoKLS0tCgo8YnIgLz4KCiMjIyMgRU0gYWxnb3JpdGhtCgoxLiBFLXN0ZXA6ICRRKFxib2xkc3ltYm9se1xQc2l9LCBcYm9sZHN5bWJvbHtcUHNpfV5rKSA9IFx0ZXh0e0V9XGxlZnRbLTJcbG9nIExfe1xtYXRoYmZ7WX0sXG1hdGhiZntYfX0oXGJvbGRzeW1ib2x7XFBzaX0pIFx2ZXJ0IFxtYXRoYmZ7WX1fTiwgXGJvbGRzeW1ib2x7XFBzaX1ea1xyaWdodF0kCgoyLiBNLXN0ZXA6IE1pbmltaXNlICRRKFxib2xkc3ltYm9se1xQc2l9LCBcYm9sZHN5bWJvbHtcUHNpfV5rKSQgdG8gb2J0YWluIHRoZSB1cGRhdGUgb2YgdGhlIHBhcmFtZXRlciBzZXQgJFxib2xkc3ltYm9se1xQc2l9XntrKzF9JC4KCjMuIFJlcGVhdGUgMS0yIHVudGlsIGNvbnZlcmdlbmNlCgpCZWZvcmUgd2UgZGVyaXZlIHRoZSBhbGdvcml0aG0gd2UgZmlyc3QgaW50cm9kdWNlIHRoZSBsYWcgb25lIGNvdmFyaWFuY2UgZXN0aW1hdG9ycyAKClxbXG1hdGhiZntQfV97dCx0LTFcdmVydCByfT1cdGV4dHtjb3Z9XGxlZnRbXG1hdGhiZntYfV90LFxtYXRoYmZ7WH1fe3QtMX1cdmVydCBcbWF0aGJme1l9X3JccmlnaHRdXF0uCgotIEZpbHRlcmVkIHZhbHVlcyAKXGJlZ2lue2VxdWF0aW9ufQpcbWF0aGJme1B9X3t0LHQtMVx2ZXJ0IHR9PShcbWF0aGJme0l9LVxtYXRoYmZ7UH1fe3RcdmVydCB0LTF9XG1hdGhiZntBfV90XlRcYm9sZHN5bWJvbHtcU2lnbWF9X3Reey0xfVxtYXRoYmZ7QX1fdClcYm9sZHN5bWJvbHtcUGhpfV90XG1hdGhiZntQfV97dC0xXHZlcnQgdC0xfSwgXGxhYmVse1NTX0Y2fQpcZW5ke2VxdWF0aW9ufQoKLSBzbW9vdGhlZCB2YWx1ZXMgClxiZWdpbntlcXVhdGlvbn0KXG1hdGhiZntQfV97dCx0LTFcdmVydCBufT1cbWF0aGJme1B9X3t0LHQtMVx2ZXJ0IHR9KyhcbWF0aGJme1B9X3t0XHZlcnQgbn0tXG1hdGhiZntQfV97dFx2ZXJ0IHR9KVxtYXRoYmZ7UH1fe3RcdmVydCB0fV57LTF9XG1hdGhiZntQfV97dCx0LTFcdmVydCB0fS4gXGxhYmVse1NTX0I0fQpcZW5ke2VxdWF0aW9ufQoKLS0tCgo8YnIgLz4KCiMjIyMgRU0tYWxnb3JpdGhtOiBFLXN0ZXAKClxiZWdpbnttdWx0bGluZSp9ClEoXGJvbGRzeW1ib2x7XFBzaX0sIFxib2xkc3ltYm9se1xQc2l9XmspIFxzaW0gXHRleHR7RX1cbGVmdFsgXGxvZ3xcYm9sZHN5bWJvbHtcU2lnbWF9X3swfXwgKyAoXG1hdGhiZntYfV8wLVxib2xkc3ltYm9se1xtdX1fezB9KV5UIFxib2xkc3ltYm9se1xTaWdtYX1fezB9XnstMX0gKFxtYXRoYmZ7WH1fMC1cYm9sZHN5bWJvbHtcbXV9X3swfSlcdmVydCBcbWF0aGJme1l9X04sIFxib2xkc3ltYm9se1xQc2l9XmtccmlnaHRdXFxcXAogICAgK1x0ZXh0e0V9XGxlZnRbbiBcbG9nIHxcbWF0aGJme1F9fCtcc3VtX3t0PTF9Xm4gKFxtYXRoYmZ7WH1fdC1cYm9sZHN5bWJvbHtcUGhpIFh9X3t0LTF9KV5UIFxtYXRoYmZ7UX1eey0xfShcbWF0aGJme1h9X3QtXGJvbGRzeW1ib2x7XFBoaSBYfV97dC0xfSlcdmVydCBcbWF0aGJme1l9X04sIFxib2xkc3ltYm9se1xQc2l9XmtccmlnaHRdXFxcXCAgICAKICAgICtcdGV4dHtFfVxsZWZ0W24gXGxvZ3xcbWF0aGJme1J9fCArIFxzdW1fe3Q9MX1ebiAoXG1hdGhiZntZfV90LVxtYXRoYmZ7QX1fdFxtYXRoYmZ7WH1fdCleVFxtYXRoYmZ7Un1eey0xfShcbWF0aGJme1l9X3QtXG1hdGhiZntBfV90XG1hdGhiZntYfV90KVx2ZXJ0IFxtYXRoYmZ7WX1fTiwgXGJvbGRzeW1ib2x7XFBzaX1ea1xyaWdodF0KXGVuZHttdWx0bGluZSp9CgpcWyBccXVhZCBcXQoKXGJlZ2lue211bHRsaW5lKn0KUShcYm9sZHN5bWJvbHtcUHNpfSwgXGJvbGRzeW1ib2x7XFBzaX1eaylcc2ltIFxsb2d8XGJvbGRzeW1ib2x7XFNpZ21hfV97MH18ICsgXHRleHR7dHJ9XGxlZnRbClxib2xkc3ltYm9se1xTaWdtYX1fezB9XnstMX0gXGxlZnQgXGxicmFjZSBcbWF0aGJme1B9X3swXHZlcnQgbn0gKyAoXG1hdGhiZntYfV97MFx2ZXJ0IG59LSBcYm9sZHN5bWJvbHtcbXV9X3swfSkoXG1hdGhiZntYfV97MFx2ZXJ0IG59LSBcYm9sZHN5bWJvbHtcbXV9X3swfSleVFxyaWdodFxyYnJhY2VccmlnaHRdXFxcXAorbiBcbG9nIHxcbWF0aGJme1F9fCArIFx0ZXh0e3RyfVxsZWZ0WyBcbWF0aGJme1Feey0xfX1cbGVmdFxsYnJhY2VcbWF0aGJme1N9X3sxMX0gLSBcbWF0aGJme1N9X3sxMH1cYm9sZHN5bWJvbHtcUGhpfV5ULVxib2xkc3ltYm9se1xQaGl9IFxtYXRoYmZ7U31fezEwfV5UK1xib2xkc3ltYm9se1xQaGl9IFxtYXRoYmZ7U31fezAwfSBcYm9sZHN5bWJvbHtcUGhpfV5UXHJpZ2h0XHJicmFjZVxyaWdodF1cXFxcK25cbG9nIHxcbWF0aGJme1J9fAorIFx0ZXh0e3RyfVxsZWZ0W1xtYXRoYmZ7Ul57LTF9fVxzdW1cbGltaXRzX3t0PTF9Xm4gXGxlZnRcbGJyYWNlKFxtYXRoYmZ7eX1fdC1cbWF0aGJme0F9X3QgXG1hdGhiZntYfV97dFx2ZXJ0IG59KShcbWF0aGJme3l9X3QtXG1hdGhiZntBfV90XG1hdGhiZntYfV97dFx2ZXJ0IG59KV5UK1xtYXRoYmZ7QX1fdFxtYXRoYmZ7UH1fe3RcdmVydCBufSBcbWF0aGJme0F9X3ReVFxyaWdodFxyYnJhY2VccmlnaHRdLApcZW5ke211bHRsaW5lKn0KCndpdGggClxiZWdpbnthbGlnbip9ClxtYXRoYmZ7U31fezExfSY9XHN1bVxsaW1pdHNfe3Q9MX1ebiAoXG1hdGhiZntYfV97dFx2ZXJ0IG59IFxtYXRoYmZ7WH1fe3RcdmVydCBufV5UICsgXG1hdGhiZntQfV97dFx2ZXJ0IG59KVxcClxtYXRoYmZ7U31fezEwfSY9XHN1bVxsaW1pdHNfe3Q9MX1ebiAoXG1hdGhiZntYfV97dFx2ZXJ0IG59XG1hdGhiZntYfV97dC0xXHZlcnQgbn1eVCArIFxtYXRoYmZ7UH1fe3QsdC0xXHZlcnQgbn0pXFwKXG1hdGhiZntTfV97MDB9Jj1cc3VtXGxpbWl0c197dD0xfV5uIChcbWF0aGJme1h9X3t0LTFcdmVydCBufSBcbWF0aGJme1h9X3t0LTFcdmVydCBufV5UICsgXG1hdGhiZntQfV97dC0xXHZlcnQgbn0pXFwKXGVuZHthbGlnbip9CgoKLS0tCgo8YnIgLz4KCgojIyMjIEVNIGFsZ29yaXRobTogTS1zdGVwIG1pbmltaXNlICRRKFxib2xkc3ltYm9se1xQc2l9LCBcYm9sZHN5bWJvbHtcUHNpfV5rKSQKClxiZWdpbnthbGlnbip9Clxib2xkc3ltYm9se1xQaGl9XntrKzF9PSZcbWF0aGJme1N9X3sxMH1cbWF0aGJme1N9X3swMH1eey0xfVxcXFwKXG1hdGhiZntRfV57aysxfT0mIG5eey0xfShcbWF0aGJme1N9X3sxMX0tXG1hdGhiZntTfV97MTB9XG1hdGhiZntTfV97MDB9XnstMX1cbWF0aGJme1N9X3sxMH1eVCksXFxcXApcbWF0aGJme1J9XntrKzF9PSZuXnstMX1cc3VtXGxpbWl0c197dD0xfV5uIFxsZWZ0WyhcbWF0aGJme3l9X3QtXG1hdGhiZntBfV90IFxtYXRoYmZ7WH1fe3RcdmVydCBufSkoXG1hdGhiZnt5fV90LVxtYXRoYmZ7QX1fdFxtYXRoYmZ7WH1fe3RcdmVydCBufSleVCtcbWF0aGJme0F9X3RcbWF0aGJme1B9X3t0XHZlcnQgbn0gXG1hdGhiZntBfV90XlRccmlnaHRdXFxcXApcYm9sZHN5bWJvbHtcbXV9XzBee2srMX09JiBcbWF0aGJme1h9X3swXHZlcnQgbn1cXFxcClxib2xkc3ltYm9se1xTaWdtYX1fMF57aysxfT0mXG1hdGhiZntQfV97MFx2ZXJ0IG59ClxlbmR7YWxpZ24qfQoKLS0tCgo8YnIgLz4KCgojIEV4dGVuc2lvbnMKCjEuIExpbmsgYmV0d2VlbiBTdGF0ZSBTcGFjZSBtb2RlbHMgYW5kIGN1YmljIHNtb290aGluZyBzcGxpbmVzCjIuIE1vcmUgY29tcGxleCB0ZW1wb3JhbCBzdHJ1Y3R1cmVzCjMuIFRpbWUgdmFyeWluZyBjb2VmZmljaWVudCBtb2RlbAo0LiBNaXNzaW5nIGRhdGEKNS4gS2FsbWFuIGZpbHRlciBmb3IgR2VuZXJhbGl6ZWQgTGVhc3QgU3F1YXJlcyAoR0xTKQo2LiBBZHZhbmNlZCB0b3BpY3MgCgotLS0KCjxiciAvPgoKIyMgTGluayB3aXRoIEN1YmljIFNtb290aGluZyBTcGxpbmVzIAoKQmFzaWMgaWRlYSBvZiBzbW9vdGhpbmcgc3BsaW5lczoKClxbeV90ID0gXG11X3QgKyB2X3RcXQoKd2l0aCAkdCA9IDEsLi4uLG4sJCBhbmQgJFxtdV90JCBhIHNtb290aCBmdW5jdGlvbiBvZiB0LCBhbmQgJHZfdCQgaXMgJE4oMCxcc2lnbWFeMl92KSQuIAoKSW4gY3ViaWMgc21vb3RoaW5nICRcbXVfdCQgaXMgZXN0aW1hdGVkIGJ5IG1pbmltaXppbmcKClxbClxzdW1cbGltaXRzX3t0PTF9Xm4gW3lfdCAtIFxtdV90XV4yICsgXGxhbWJkYSBcaW50XGxpbWl0c197dD0xfV5uIFxsZWZ0KFxmcmFje2ReMlxtdV90fXtkdF4yfVxyaWdodCleMiBkdApcXQoKd2l0aCByZXNwZWN0IHRvICRcbXVfdCQgLCB3aGVyZSAkXGxhbWJkYSA+IDAkIGlzIGEgc21vb3RoaW5nIHBhcmFtZXRlci4gCgotICRcbGFtYmRhJCBjb250cm9scyB0aGUKZGVncmVlIG9mIHNtb290aG5lc3MsIHdpdGggbGFyZ2VyIHZhbHVlcyB5aWVsZGluZyBzbW9vdGhlciBlc3RpbWF0ZXMuIAoKLSBJZiAkXGxhbWJkYSA9IDAkLCB0aGVuIG1pbmltaXplciBpcyB0aGUgZGF0YSBpdHNlbGYgJFxoYXQgXG11X3QgPSB5X3QkLCBub3Qgc21vb3RoISAgIAotIElmICRcbGFtYmRhID1caW5mdHkkICB3aWxsIGZvcmNlIHRoZSBzZWNvbmQgZGVyaXZhdGl2ZSB0byBiZSwgcmVzdWx0aW5nIGluIGEgbGluZWFyIHJlZ3Jlc3Npb24gOiAkXG11X3QgPSBcYmV0YV8wK1xiZXRhIHQkCgo8YnIgLz4gCgpXaGVuIGtub3RzIGFyZSBwbGFjZWQgYXQgdGhlIHRpbWUgcG9pbnRzICR0JCwgaXQgY2FuIGJlIHNob3duIHRoYXQgdGhlIGxvc3MgZnVuY3Rpb24gcmVkdWNlcyB0bwoKXFsKXHN1bVxsaW1pdHNfe3Q9MX1ebiBbeV90IC0gXG11X3RdXjIgKyBcbGFtYmRhIFxzdW1cbGltaXRzX3t0PTF9Xm4gIFxsZWZ0KFxiaWd0cmlhbmdsZWRvd25eMiBcbXVfdFxyaWdodCleMgpcXQoKd2l0aCAkXGJpZ3RyaWFuZ2xlZG93bl4yIFxtdV90ID0gXG11X3QgLSAyIFxtdV97dC0xfSArIFxtdV97dC0yfSQgZmluaXRlIGRpZmZlcmVuY2VzLgoKCi0tLQoKPGJyIC8+CgoKIyMjIFJlY2FzdGluZyBpbiBhIHN0YXRlIHNwYWNlIG1vZGVsIAoKClxbClxiaWd0cmlhbmdsZWRvd25eMiBcbXVfdCA9IHdfdCBcXApcXQoKYW5kIHJld3JpdGluZyBpdCAKClxbClxtdV90ICA9ICAyIFxtdV97dC0xfSAtIFxtdV97dC0yfSArIHdfdCAKXF0KCmVuYWJsZSB1cyB0byByZWNhc3QgdGhlIHNwbGluZSBpbiBhIHN0YXRlIHNwYWNlIG1vZGVsOgoKXGJlZ2lue2VxbmFycmF5Kn0KXGJlZ2lue2JtYXRyaXh9ClxtdV90XFwKXG11X3t0LTF9ClxlbmR7Ym1hdHJpeH0gJj0mIFxiZWdpbntibWF0cml4fSAyICYgLSAxXFwgMSAmIDBcZW5ke2JtYXRyaXh9IFxiZWdpbntibWF0cml4fSBcbXVfe3QtMX0gXFwgXG11X3t0LTJ9IFxlbmR7Ym1hdHJpeH0gKyBcYmVnaW57Ym1hdHJpeH0xXFwwXGVuZHtibWF0cml4fSB3X3RcXAp5X3QgJj0mICBcYmVnaW57Ym1hdHJpeH0gMSYwXGVuZHtibWF0cml4fVxiZWdpbntibWF0cml4fSBcbXVfe3QtMX0gXFwgXG11X3t0LTJ9IFxlbmR7Ym1hdHJpeH0gKyB2X3QKXGVuZHtlcW5hcnJheSp9CgotLS0KCjxiciAvPgoKCiMjIyBNYXhpbWl6ZSBjb21wbGV0ZSBkYXRhIGxpa2VsaWhvb2QgdG8gdGhlIFN0YXRlczogClxbClxsb2cgTF97XG1hdGhiZntZfSxcbWF0aGJme1h9fShcYm9sZHN5bWJvbHtcUHNpfSkgIFxwcm9wdG8gXHNpZ21hX3Zeey0yfSBcc3VtXGxpbWl0c197dD0xfV5uIFxsZWZ0KHlfdCAtIFxtdV90XHJpZ2h0KV4yICsgXHNpZ21hX3deey0yfSBcc3VtXGxpbWl0c197dD0xfV5uIFxsZWZ0KFxiaWd0cmlhbmdsZWRvd25eMiBcbXVfdFxyaWdodCleMiAgClxdCgppcyBlcXVpdmFsZW50IHRvIG1heGltaXppbmc6IAoKXFsKXGxvZyBMX3tcbWF0aGJme1l9LFxtYXRoYmZ7WH19KFxib2xkc3ltYm9se1xQc2l9KSAgXHByb3B0byAgXHN1bVxsaW1pdHNfe3Q9MX1ebiBcbGVmdCh5X3QgLSBcbXVfdFxyaWdodCleMiArIFxmcmFje1xzaWdtYV92XnsyfX17XHNpZ21hX3deezJ9fSBcc3VtXGxpbWl0c197dD0xfV5uIFxsZWZ0KFxiaWd0cmlhbmdsZWRvd25eMiBcbXVfdFxyaWdodCleMiAgClxdCgotIFNvIHRoZSBTdGF0ZSBTcGFjZSBtb2RlbCBoYXMgdGhlIHNhbWUgc29sdXRpb24gYXMgYSBzbW9vdGhpbmcgc3BsaW5lIHdpdGggcGVuYWx0eSAkXGxhbWJkYSA9IFxmcmFje1xzaWdtYV92XnsyfX17XHNpZ21hX3deezJ9fSQhCgotIE1lYW4gJFxsZWZ0cmlnaHRhcnJvdyQgVmFyaWFuY2UKCi0gTGluayBtaXhlZCBtb2RlbHMgYW5kIHJpZGdlIHJlZ3Jlc3Npb24vcGVuYWxpc2F0aW9uCgotLS0KCjxiciAvPgoKCiMjIyBFeGFtcGxlIAoKLSBXZSBzaW11bGF0ZSB0aGUgc2lnbmFsLCBvciBzdGF0ZSBwcm9jZXNzLCAkXG11X3QkIGFuZCBvYnNlcnZhdGlvbnMgJHlfdCQgd2l0aCAkbiA9IDUwJCwgJFxzaWdtYV4yX1xvbWVnYSA9IC4xJCBhbmQgJFxzaWdtYV4yX1xlcHNpbG9uJCA9IDEuCgpgYGB7cn0Kc2V0LnNlZWQoMTIzKQpudW0gPSA1MAp3ID0gcm5vcm0obnVtLDAsLjEpCm11ICAgPSBjdW1zdW0oY3Vtc3VtKHcpKQoKeSA9IG11ICsgcm5vcm0obnVtLDAsMSkKYGBgCgo8ZGV0YWlscz48c3VtbWFyeT5DbGljayB0byBzZWUgY29kZSBmb3IgcGxvdCA8L3N1bW1hcnk+PHA+CmBgYHtyfQpwbG90U21vb3RoZXJSZWFsIDwtIGRhdGEuZnJhbWUodD0xOm51bSxtdT1tdSx5PXkpICU+JSAKICBnZ3Bsb3QoYWVzKHg9dCx5PXkpKSArCiAgZ2VvbV9wb2ludCgpICsKICBnZW9tX2xpbmUoYWVzKHg9dCx5PW11KSkKYGBgCjwvcD48L2RldGFpbHM+CgpgYGB7cn0KcGxvdFNtb290aGVyUmVhbApgYGAKCiMjIyMgU3RhdGUgc3BhY2UgbW9kZWwgCgpgYGB7cn0KIyMgU3RhdGUgU3BhY2UgIyMKUGhpIDwtIG1hdHJpeChjKDIsMSwtMSwwKSwyKSAKQSA8LSBtYXRyaXgoYygxLDApLDEpIAptdTAgPC0gbWF0cml4KDAsMikKU2lnbWEwIDwtIGRpYWcoMSwyKQpgYGAKCiMjIyMgRXN0aW1hdGlvbgoKRXhwbGFpbiBtYXhpbXVtIGxpa2VsaWhvb2QgaW1wbGVtZW50YXRpb24uIAoKYGBge3IgcmVzdWx0cz0iaGlkZSJ9CiMjIEZpdHRpbmcgClBoaSA8LSBtYXRyaXgoYygyLDEsLTEsMCksMikgCkEgPC0gbWF0cml4KGMoMSwwKSwxKSAKbXUwIDwtIG1hdHJpeCgwLDIpIApTaWdtYTAgPC0gZGlhZygxLDIpCkxpbm4gPC0gZnVuY3Rpb24ocGFyYSl7CiAgc2lndyA8LSBwYXJhWzFdCiAgc2lndiA8LSBwYXJhWzJdCiAgY1EgICA8LSBkaWFnKGMoc2lndywwKSkKICBrZiAgIDwtIEtmaWx0ZXIwKG51bSwgeSwgQSwgbXUwLCBTaWdtYTAsIFBoaSwgY1EsIHNpZ3YpCiAgcmV0dXJuKGtmJGxpa2UpICAgfQoKaW5pdC5wYXIgPC0gYyguMSwgMSkKCmVzdCA8LSBvcHRpbSgKICBwYXIgPSBpbml0LnBhciwgCiAgZm4gPSBMaW5uLCAKICBtZXRob2Q9IkJGR1MiLCAKICBoZXNzaWFuPVRSVUUsCiAgY29udHJvbD1saXN0KHRyYWNlPTEsUkVQT1JUPTEpKQpgYGAKCiMjIyMgU21vb3RoZXIKCmBgYHtyfQpzaWd3IDwtIGVzdCRwYXJbMV0KY1EgPC0gZGlhZyhjKHNpZ3csMCkpCnNpZ3YgPC0gZXN0JHBhclsyXQprcyA8LSBLc21vb3RoMChudW0sIHksIEEsIG11MCwgU2lnbWEwLCBQaGksIGNRLCBzaWd2KQpgYGAKCgoKPGRldGFpbHM+PHN1bW1hcnk+Q2xpY2sgdG8gc2VlIGNvZGUgZm9yIHBsb3QgPC9zdW1tYXJ5PjxwPgpgYGB7cn0KZGF0YUhscDMgPC0gZGF0YS5mcmFtZSh0ID0gMTpudW0sIG11Rml0ID0ga3MkeHNbMSwxLF0pICU+JSAKICBtdXRhdGUoCiAgICBtdWxsID0gbXVGaXQgLSAyICogc3FydChrcyRQc1sxLDEsXSksCiAgICBtdXVsID0gbXVGaXQgKyAyICogc3FydChrcyRQc1sxLDEsXSksCiAgICAgICAgICkKCmRhdGFIbHA0IDwtIGRhdGEuZnJhbWUoCiAgdD1yZXAoMTpudW0sMyksCiAgbXU9YyhzbW9vdGguc3BsaW5lKHkpJHksbXUsa3MkeHNbMSwxLF0pLAogIG1ldGhvZD1yZXAoYygiR0NWIHNwbGluZSIsIkdyb3VuZCBUcnV0aCIsIkthbG1hbiBTbW9vdGhlciIpLGVhY2g9bnVtKSkKCmN1YmljU21vb3RoZXJQbG90IDwtIGdncGxvdCgpICsKICBnZW9tX3JpYmJvbigKICAgIGFlcyh4PXQseW1pbiA9IG11bGwseW1heCA9IG11dWwpLCAKICAgIGFscGhhID0gMC40NSwgCiAgICBjb2xvciA9IE5BLAogICAgZGF0YSA9IGRhdGFIbHAzKSArCiAgZ2VvbV9wb2ludCgKICAgIGFlcyh4PXgseT1vYnMpLAogICAgY29sb3I9ImJsYWNrIiwgCiAgICBkYXRhPWRhdGEuZnJhbWUoeD0xOm51bSxvYnM9eSkpICsKICBnZW9tX2xpbmUoCiAgICBhZXMoeCA9IHQsIHkgPSBtdSwgY29sb3IgPSBtZXRob2QsIGxpbmV0eXBlID0gbWV0aG9kKSwKICAgIGRhdGEgPSBkYXRhSGxwNCkgKwogIHNjYWxlX2NvbG9yX21hbnVhbCh2YWx1ZXMgPSBjKCJibHVlIiwiYmxhY2siLCJyZWQiKSkgKwogIHNjYWxlX2xpbmV0eXBlX21hbnVhbCh2YWx1ZXMgPSBjKDIsMSwxKSkgCmBgYAo8L3A+PC9kZXRhaWxzPgoKYGBge3J9CmN1YmljU21vb3RoZXJQbG90CmBgYAoKLS0tCgo8YnIgLz4KCiMjIE1vcmUgY29tcGxleCB0ZW1wb3JhbCBzdHJ1Y3R1cmVzIAoKLSBFeHRlbmQgc3RhdGUgdmVjdG9yIHdpdGggc3RhdGVzIGF0IHByZXZpb3VzIGxhZ3MsIGkuZS4gJHQtMSwgXGxkb3RzLCB0LXAkIAoKIFxbXG1hdGhiZntYfV90PVtYX3sxdH0gXGxkb3RzIFhfe210fSwgXGxkb3RzLCBYX3sxdC1wfVxsZG90cyBYX3ttdC1wfV1eVFxdCgotIEJ5IGVtYmVkZGluZyB0aGUgQVIocCkgU3RhdGUgaW4gdGhlIG1lYXN1cmVtZW50IGVxdWF0aW9uLCB0aGUgY29ycmVsYXRpb24gc3RydWN0dXJlIGFnYWluIGJlY29tZXMgbXVjaCBtb3JlIGZsZXhpYmxlLiAKCi0tLQoKPGJyIC8+CgojIyBUaW1lIFZhcnlpbmcgQ29lZmZpY2llbnQgTW9kZWwKClJlZ3Jlc3Npb24gbW9kZWxzIHdpdGggdGltZSB2YXJ5aW5nIG1vZGVsIHBhcmFtZXRlcnMgY2FuIGFsc28gYmUgZWFzaWx5IHByb3ZpZGVkIGJ5IGV4dGVuZGluZyB0aGUgc3RhdGUgdmVjdG9yLCBpLmUuIAoKXFtcbWF0aGJme1h9X3Q9W1hfezF0fSBcbGRvdHMgWF97bXR9LFxtYXRoYmZ7XGJldGF9X3RdXlRcXQoKCiMjIyBFeGFtcGxlIEhlZGdlIHJhdGlvIGNyeXB0by1jdXJyZW5jaWVzCgo8ZGV0YWlscz48c3VtbWFyeT5DbGljayB0byBzZWUgY29kZSBmb3IgcGxvdCA8L3N1bW1hcnk+PHA+CmBgYHtyfQpjb2luRGF0YSA8LSBjb2luRGF0YSAlPiUgCiAgbXV0YXRlKAogICAgeWVhciA9IGZvcm1hdChkYXRlLCIlWSIpICU+JSBhcy5mYWN0b3IsCiAgICBjb2xvcnMgPSBhcy5kb3VibGUoZGF0ZSktbWVhbihhcy5kb3VibGUoZGF0ZSkpCiAgICApIAoKcGxvdEhlZGdlIDwtIGNvaW5EYXRhICU+JQogIGdncGxvdChhZXMoZXRoX3ByaWNlc191c2QsIGx0Y19wcmljZXNfdXNkLCBjb2xvcj15ZWFyKSkgKwogIGdlb21fcG9pbnQoc2l6ZSA9IC43LCBzaGFwZSA9IDEpIApgYGAKPC9wPjwvZGV0YWlscz4KCmBgYHtyfQpwbG90SGVkZ2UKYGBgCgoKIyMjIERlZmluZSBzdGF0ZSBzcGFjZSBtb2RlbCAKClxbeV90ID0gXGJldGFfezB0fSArIFxiZXRhX3sxdH0gel90ICsgdl90XF0gCgoKd2l0aCAKCi0gJHlfdCQ6IGx0YyBwcmljZSBhbmQgCi0gJHpfdCQ6IGV0aCBwcmljZQoKU3RhdGUgc3BhY2UgbW9kZWw6ClxbClxsZWZ0XGxicmFjZQpcYmVnaW57YXJyYXl9e2xsbGx9CnlfdCY9JlxtYXRoYmZ7QX1fdFxtYXRoYmZ7WH1fdCt2X3QgJndpdGhcIHZfdFxzaW0gTigwLFxzaWdtYV92XjIpXFwKXG1hdGhiZntYfV90Jj0mXGJvbGRzeW1ib2x7XFBoaX0gXG1hdGhiZntYfV97dC0xfSArIFxtYXRoYmZ7d31fdCAmd2l0aFwgXG1hdGhiZnt3fV90XHNpbSBNVk4oXG1hdGhiZnswfSxcbWF0aGJme1F9KQpcZW5ke2FycmF5fQpccmlnaHQuXF0KCndpdGggCgotICRcbWF0aGJme0F9X3QgPSBcYmVnaW57Ym1hdHJpeH0gMSAmIHpfdFxlbmR7Ym1hdHJpeH0kCi0gJFxtYXRoYmZ7WH1fdD0gXGJlZ2lue2JtYXRyaXh9IFxiZXRhX3swdH1cXCBcYmV0YV97MXR9IFxlbmR7Ym1hdHJpeH0kCgoKIyMjIFIgaW1wbGVtZW50YXRpb24KCmBgYHtyIHJlc3VsdHM9ImhpZGUifQp5IDwtIGNvaW5EYXRhICU+JSAKICBwdWxsKCJsdGNfcHJpY2VzX3VzZCIpICU+JSAKICBhcy5tYXRyaXgobmNvbD0xKQoKeiA8LSBjb2luRGF0YSAlPiUgCiAgcHVsbCgiZXRoX3ByaWNlc191c2QiKSAKCm51bSA8LSBucm93KHkpCgojIE1lYXN1cmVtZW50IG1hdHJpeCBBID0gCkEgPC0gYXJyYXkoMCwgZGltPWMoMSwyLG51bSkpICAKQVssMSxdIDwtIDEKQVssMixdIDwtIHoKCiMgaW5pdGlhbCB2YWx1ZXMKbXUwIDwtIG1hdHJpeChjKDAsMSksMiwxKQpTaWdtYTAgPC0gZGlhZyhjKC4xLC4xKSwyKQpQaGkgPC0gZGlhZygxLDIpCmNRIDwtIGRpYWcoYyguMSwuMSksMikKY1IgPC0gZGlhZyhjKC4xKSwxKQoKZW0gPC0gRU0xKG51bSwgeSwgQSwgbXUwLCBTaWdtYTAsIFBoaSwgY1EsIGNSLCAxMDAsIC4wMDEpCmtzIDwtIEtzbW9vdGgxKG51bSwgeSwgQSwgZW0kbXUwLCBlbSRTaWdtYTAsIGVtJFBoaSwgMCwgMCwgY2hvbChlbSRRKSwgY2hvbChlbSRSKSwgMCkKYGBgCgoKPGRldGFpbHM+PHN1bW1hcnk+Q2xpY2sgdG8gc2VlIGNvZGUgZm9yIHBsb3QgPC9zdW1tYXJ5PjxwPgpgYGB7cn0KcGxvdEJldGFzVmFyeWluZyA8LSBkYXRhLmZyYW1lKAogICAgdGltZT1jb2luRGF0YSRkYXRlLCAKICAgIGJldGE9YyhrcyR4ZlsxLDEsXSwga3MkeGZbMiwxLF0pLAogICAgc3RhdGU9YyhyZXAoImludGVyY2VwdCIsbmRheXMpLCByZXAoInNsb3BlIixuZGF5cykpCiAgKSAlPiUgCiAgZ2dwbG90KGFlcyh0aW1lLCBiZXRhKSkgKwogIGdlb21fbGluZSgpICsgCiAgZmFjZXRfd3JhcCh+c3RhdGUsIG5yb3c9Miwgc2NhbGVzPSJmcmVlX3kiKSArCiAgdGhlbWVfbWluaW1hbCgpCmBgYAo8L3A+PC9kZXRhaWxzPgoKYGBge3J9CnBsb3RCZXRhc1ZhcnlpbmcKYGBgCgo8ZGV0YWlscz48c3VtbWFyeT5DbGljayB0byBzZWUgY29kZSBmb3IgcGxvdCA8L3N1bW1hcnk+PHA+CmBgYHtyfQpjb2luRGF0YSA8LSBjb2luRGF0YSAlPiUgCiAgbXV0YXRlKAogICAgaGVkZ2VJbnQgPSBrcyR4ZlsxLDEsXSwKICAgIGhlZGdlU2xwID0ga3MkeGZbMiwxLF0gIAogICAgKQoKcGxvdEhlZGdlIDwtIGxpc3QoKQppPC0gMApmb3IgKHQgaW4gcHJldHR5KGNvaW5EYXRhJGRhdGUsIDM2KSkKI2ZvciAodCBpbiBjKAojICBzZXEoCiMgICAgbWluKGNvaW5EYXRhJGRhdGUpLAojICAgIGFzLkRhdGUoIjIwMTktMTItMzEiKSwKIyAgICA3KSwKIyAgc2VxKAojICAgIGFzLkRhdGUoIjIwMjEtMDEtMDEiKSwKIyAgICBtYXgoY29pbkRhdGEkZGF0ZSksCiMgICAgNykKIyAgKQojICApCnsKICBpIDwtIGkrMQogIHBsb3RIZWRnZVtbaV1dIDwtIGNvaW5EYXRhICU+JQogICAgZ2dwbG90KGFlcyhldGhfcHJpY2VzX3VzZCwgbHRjX3ByaWNlc191c2QsIGNvbG9yPXllYXIpKSArCiAgICBnZW9tX3BvaW50KHNpemUgPSAuNywgc2hhcGUgPSAxKSArCiAgICBnZW9tX3BvaW50KGFlcyh4PWV0aF9wcmljZXNfdXNkLCB5ID0gbHRjX3ByaWNlc191c2QsIGNvbG9yID0geWVhciksIGRhdGEgPSBjb2luRGF0YSAlPiUgZmlsdGVyKGRhdGUgPT0gdCksIHNoYXBlID0gMTcsIHNpemUgPSA0KSArCiAgICBnZW9tX2FibGluZShhZXMoaW50ZXJjZXB0PWhlZGdlSW50LCBzbG9wZT1oZWRnZVNscCwgY29sb3IgPSB5ZWFyKSwgZGF0YSA9IGNvaW5EYXRhICU+JSBmaWx0ZXIoZGF0ZSA9PSB0KSkKfQpgYGAKPC9wPjwvZGV0YWlscz4KCkFuaW1hdGlvbiBpbmNsdWRlcyByZWdyZXNzaW9uIGxpbmUgZm9yIGZpcnN0IGRheSBvZiBlYWNoIG1vbnRoLgoKYGBge3IsIGFuaW1hdGlvbi5ob29rPSJnaWZza2kiLCBlY2hvPUZBTFNFLCBtZXNzYWdlID0gRkFMU0UsIHJlc3VsdHM9ImhpZGUiLCBpbnRlcnZhbCA9IC41fQpmb3IgKGsgaW4gMTo1KSBmb3IgKGkgaW4gMToyKSBwcmludChwbG90SGVkZ2VbW2tdXSkKZm9yIChrIGluIDY6bGVuZ3RoKHBsb3RIZWRnZSkpIHByaW50KHBsb3RIZWRnZVtba11dKQpgYGAKCi0tLQoKPGJyIC8+CgoKIyMgTWlzc2luZyBEYXRhIAoKIyMjIERhdGEgCi0gRGF0YSBmcm9tIEpvbmVzICgxOTg0KQotIE1lYXN1cmVtZW50cyBtYWRlIGZvciA5MSBkYXlzIG9uIHRocmVlIHZhcmlhYmxlczogCgogICAgLSAkeV8xJDogbG9nKHdoaXRlIGJsb29kIGNvdW50KSBbV0JDXQogICAgLSAkeV8yJDogbG9nKHBsYXRlbGV0KSBbUExUXQogICAgLSAkeV8zJDogaGVtYXRvY3JpdCBbSENUXQoKPGRldGFpbHM+PHN1bW1hcnk+Q2xpY2sgdG8gc2VlIGNvZGUgZm9yIHBsb3QgPC9zdW1tYXJ5PjxwPgpgYGB7cn0KYmxvb2RUaWR5IDwtIGJsb29kICU+JSAKICBhcy5kYXRhLmZyYW1lICU+JQogIG11dGF0ZSh0PTE6bnJvdyhibG9vZCkpICU+JSAKICBnYXRoZXIodmFyaWFibGUsIGNvbmNlbnRyYXRpb24sIC10KQpwbG90Qmxvb2QgPC0gYmxvb2RUaWR5ICU+JSAKICBnZ3Bsb3QoYWVzKHQsY29uY2VudHJhdGlvbikpICsKICBnZW9tX3BvaW50KCkgKwogIGZhY2V0X3dyYXAofnZhcmlhYmxlLG5yb3c9MyxzY2FsZXM9ImZyZWVfeSIpICsKICB0aGVtZV9taW5pbWFsKCkKYGBgCjwvcD48L2RldGFpbHM+CgpgYGB7ciByZXN1bHRzPSJoaWRlIn0KcGxvdEJsb29kCmBgYAoKLSBTb21lIGRhdGEgYXJlIG1pc3NpbmchCgojIyMgU29sdXRpb24gICAgCgoxLiBSZXBsYWNlIG1pc3NpbmcgZGF0YSB3aXRoIDAgYW5kIHJlbW92ZSB0aGUgY29ycmVsYXRpb25zIHVzZSAKICAgIApcWwpcbWF0aGJme3l9X3Q9XGxlZnRbXG1hdGhiZnt5fV90Xnsob2JzKX0gMFxyaWdodF1eVApcXQogICAgClxbXG1hdGhiZntSfV90PVxiZWdpbntibWF0cml4fVxtYXRoYmZ7Un1fezExdH0mIFxtYXRoYmZ7MH1cXFxtYXRoYmZ7MH0mXG1hdGhiZntSfV97MjJ0fVxlbmR7Ym1hdHJpeH1cXQoKXFtcbWF0aGJme0F9X3Q9XGJlZ2lue2JtYXRyaXh9XG1hdGhiZntBfV57KG9icyl9XFxcbWF0aGJmezB9XGVuZHtibWF0cml4fVxdCgoyLiBUaGVuIHlvdSBjYW4gYXBwbHkgdGhlIGV4aXN0aW5nIHJlY3Vyc2lvbnMgZm9yIHRoZSBLYWxtYW4gRmlsdGVyIGFuZCBTbW9vdGhlcgogICAgCjMuIFRoZSBFTSBhbGdvcml0aG0gaXMgZGVzaWduZWQgdG8gaGFuZGxlIG1pc3NpbmcgZGF0YS4KCiMjIyBFeGFtcGxlCgotIERlZmluZSBzdGF0ZSBzcGFjZSBtb2RlbCBhbmQgZXN0aW1hdGlvbiAKClxbClxsZWZ0XGxicmFjZQpcYmVnaW57YXJyYXl9e2xsbGx9ClxtYXRoYmZ7eX1fdCY9JlxtYXRoYmZ7QX1fdFxtYXRoYmZ7WH1fdCsgXG1hdGhiZnt2fV90ICZ3aXRoXCBcbWF0aGJme3Z9X3Rcc2ltIE4oMCxcbWF0aGJme1J9X3QpXFwKXG1hdGhiZntYfV90Jj0mXGJvbGRzeW1ib2x7XFBoaX0gXG1hdGhiZntYfV97dC0xfSArIFxtYXRoYmZ7d31fdCAmd2l0aFwgXG1hdGhiZnt3fV90XHNpbSBNVk4oXG1hdGhiZnswfSxcbWF0aGJme1F9KQpcZW5ke2FycmF5fQpccmlnaHQuXF0KCgp3aXRoICRcbWF0aGJme0F9PVxtYXRoYmZ7SX0kICAKCjEuIFJlcGxhY2UgbWlzc2luZyB2YWx1ZXMgYnkgMAoKYGBge3IgcmVzdWx0cz0iaGlkZSJ9CnkgPC0gYmxvb2QgJT4lIGFzLm1hdHJpeAp5W2lzLm5hKHkpXSA9IDAKbnVtIDwtIG5yb3coeSkKYGBgCgoyLiBDb25zdHJ1Y3QgdGltZSB2YXJpYW50IG1hdHJpeCBBLiAKCmBgYHtyIHJlc3VsdHM9ImhpZGUifQpBICA8LSBhcnJheSgwLCBkaW09YygzLDMsbnVtKSkKZm9yKGsgaW4gMTpudW0pIHsgaWYgKHlbaywxXSA+IDApIEFbLCxrXSA8LSBkaWFnKDEsMykgfSAjIApgYGAKCgozLiBJbml0YWxpc2F0aW9uIGFuZCBlc3RpbWF0aW9uLiBOb3RlLCB0aGF0IHdlIGRvIG5vdCBoYXZlIHRvIGFkanVzdCBjb3ZhcmlhbmNlIG1hdHJpeCAkXG1hdGhiZntSfSQgdG8gYWNjb3VudCBmb3IgbWlzc2luZ25lc3MgYmVjYXVzZSBhbGwgb2JzZXJ2YXRpb25zIGFyZSBtZWFzdXJlZCBvciBtaXNzaW5nIGF0IGEgcGFydGljdWxhciB0aW1lc3RlcC4gCgpgYGB7ciByZXN1bHRzPSJoaWRlIn0KI0luaXRpYWwgdmFsdWVzCm11MCA8LSBtYXRyaXgoMCwgMywgMSkKU2lnbWEwIDwtIGRpYWcoYyguMSwgLjEsIDEpLCAzKQpQaGkgPC0gZGlhZygxLCAzKQpjUSA8LSBkaWFnKGMoLjEsIC4xLCAxKSwgMykgCmNSIDwtIGRpYWcoYyguMSwgLjEsIDEpLCAzKQoKZW0gPC0gRU0xKG51bSwgeSwgQSwgbXUwLCBTaWdtYTAsIFBoaSwgY1EsIGNSLCAxMDAsIC4wMDEpCmtzIDwtIEtzbW9vdGgxKG51bSwgeSwgQSwgZW0kbXUwLCBlbSRTaWdtYTAsIGVtJFBoaSwgMCwgMCwgY2hvbChlbSRRKSwgY2hvbChlbSRSKSwgMCkKYGBgCgo8ZGV0YWlscz48c3VtbWFyeT5DbGljayB0byBzZWUgY29kZSBmb3IgcGxvdCA8L3N1bW1hcnk+PHA+CmBgYHtyfQpibG9vZFRpZHkgPC0gYmxvb2RUaWR5ICU+JSAKICBtdXRhdGUoCiAgICB4cz1rcyR4c1ssMSxdICU+JSB0ICU+JSBjLAogICAgeHNsbCA9IChrcyR4c1ssMSxdIC0gMiAqIHNhcHBseSgxOm51bSxmdW5jdGlvbihpKSBrcyRQc1ssLGldICU+JSBkaWFnICU+JSBzcXJ0KSkgJT4lIHQoLikgJT4lIGMsCiAgICB4c3VsID0gKGtzJHhzWywxLF0gKyAyICogc2FwcGx5KDE6bnVtLGZ1bmN0aW9uKGkpIGtzJFBmWywsaV0gJT4lIGRpYWcgJT4lIHNxcnQpKSAlPiUgdCguKSAlPiUgYwogICAgKQoKcGxvdEJsb29kUmVzdWx0cyA8LSBwbG90Qmxvb2QgKwogIGdlb21fcmliYm9uKAogICAgYWVzKHltaW4gPSB4c2xsLHltYXggPSB4c3VsKSwgCiAgICBhbHBoYSA9IDAuNDUsIAogICAgZGF0YSA9IGJsb29kVGlkeSkgKwogIGdlb21fbGluZShhZXMoeD10LHk9eHMpLGRhdGE9Ymxvb2RUaWR5KSArCiAgeGxhYigidGltZSAoZGF5cykiKSArCiAgZ2d0aXRsZSgiS2FsbWFuIFNtb290aGVyIikKYGBgCjwvcD48L2RldGFpbHM+CgpgYGB7cn0KcGxvdEJsb29kUmVzdWx0cwpgYGAKCi0tLQoKPGJyIC8+CgoKIyMgS2FsbWFuIEZpbHRlciBmb3IgR2VuZXJhbGl6ZWQgTGVhc3QgU3F1YXJlcyAoR0xTKQoKXFsKXGxlZnRcbGJyYWNlClxiZWdpbnthcnJheX17bGxsbH0KXG1hdGhiZnt5fV90ICY9JiBcbWF0aGJme0F9X3QgXG1hdGhiZntYfV90ICsgXG1hdGhiZntafV90XGJvbGRzeW1ib2x7XGJldGF9KyBcbWF0aGJme3Z9X3RcXApcbWF0aGJme1h9X3QgJj0mXGJvbGRzeW1ib2x7XFBoaX1fdCBcbWF0aGJme1h9X3t0LTF9ICsgXG1hdGhiZnt3fV90XFwKXGVuZHthcnJheX0KXHJpZ2h0LgpcXQoKVGhlIHN0YXRlLXNwYWNlIG1vZGVsIGNhbiBiZSBmdXJ0aGVyIHJlZm9ybXVsYXRlZCBhcyBhIHJlZ3Jlc3Npb24gbW9kZWwKXFsKXG1hdGhiZnt5fV90PVxtYXRoYmZ7Wn1fdFxib2xkc3ltYm9se1xiZXRhfSsgXG1hdGhiZnt1fV90LApcdGV4dHsgd2l0aCB9IFxtYXRoYmZ7dX1fdD1cbWF0aGJme0F9X3QgXG1hdGhiZntYfV90ICsgXG1hdGhiZnt2fV90ClxdCgpcYmVnaW57ZXF1YXRpb259ClxtYXRoYmZ7WX1fTj1cbWF0aGJme1p9X04gXGJvbGRzeW1ib2x7XGJldGF9ICsgXG1hdGhiZntVfV9OLApcbGFiZWx7bWVhc3VyZW1lbnQucmVnLmdsc30KXGVuZHtlcXVhdGlvbn0Kd2l0aCAkXG1hdGhiZntVfV9OIFxzaW0gTVZOKFxtYXRoYmZ7MH0sXG1hdGhiZntWfSkkLgpcYmVnaW57ZXF1YXRpb259ClxoYXR7XGJvbGRzeW1ib2x7XGJldGF9fV97R0xTfT0oXG1hdGhiZntafV9OXlRcbWF0aGJme1Z9XnstMX1cbWF0aGJme1p9X04pXnstMX1cbWF0aGJme1p9X05eVCBcbWF0aGJme1Z9XnstMX0gXG1hdGhiZntZfV9OLgpcZW5ke2VxdWF0aW9ufQoKRnJvbSBHTFMgdGhlb3J5LCAKXGJlZ2lue2VxdWF0aW9ufQpcdGV4dHtWYXJ9XGxlZnRbXGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19X3tHTFN9XHJpZ2h0XT0oXG1hdGhiZntafV9OXlRcbWF0aGJme1Z9XnstMX1cbWF0aGJme1p9X04pXnstMX0uClxlbmR7ZXF1YXRpb259CgpLYWxtYW4gRmlsdGVyIGFuZCBTbW9vdGhlcgoKMS4gSWYgJFxiZXRhJCBpcyBrbm93biwgdGhlIGthbG1hbiBmaWx0ZXIgYW5kIHNtb290aGVyIHJlY3Vyc2lvbnMgc3RpbGwgaG9sZCB3aGVuIHdlIGFjY291bnQgZm9yICRcbWF0aGJme1p9X3RcYm9sZHN5bWJvbHtcYmV0YX0kIGluIHRoZSB1cGRhdGUgc3RlcC4KXFsKXG1hdGhiZntYfV97dFx2ZXJ0IHR9PVxtYXRoYmZ7WH1fe3RcdmVydCB0LTF9KyBcbWF0aGJme1B9X3t0XHZlcnQgdC0xfSAgXG1hdGhiZntBfV90XlQgXGJvbGRzeW1ib2x7XFNpZ21hfV90XnstMX0gKFxtYXRoYmZ7eX1fdCAtIFxtYXRoYmZ7QX1fdCBcbWF0aGJme1h9X3t0XHZlcnQgdC0xfSAtIFxtYXRoYmZ7Wn1fdFxib2xkc3ltYm9se1xiZXRhfSkKXF0KCgoyLiBIYXJ2ZXkgKDE5ODkpIHNob3dlZCB0aGF0IGZvciBhIGdpdmVuICRcYm9sZHN5bWJvbHtcUHNpfSQKICAKICAtIGFwcGx5aW5nIHRoZSBzYW1lIEthbG1hbiBmaWx0ZXIgKHdpdGhvdXQgcmVjYWxjdWxhdGluZyAkXG1hdGhiZntQfV97dFx2ZXJ0IHQtMX0kLCAkXG1hdGhiZntQfV97dFx2ZXJ0IHR9JCBhbmQgJFxib2xkc3ltYm9se1xTaWdtYX1fdCQpIHRvICRcbWF0aGJme1l9X3QkIGFuZCBlYWNoIG9mIHRoZSBjb2x1bW5zIG9mICRcbWF0aGJme1p9X3QkCiAgLSByZXN1bHRzIGluIAogICAgICAtIEEgJHBcdGltZXMxJCB2ZWN0b3Igb2YgaW5ub3ZhdGlvbnMsICRcbWF0aGJme1l9X3ReKiQgb24gJFxtYXRoYmZ7WX1fdCQgYW5kCiAgICAgIC0gYSAkcFx0aW1lcyBtJCBtYXRyaXggb2YgaW5ub3ZhdGlvbnMsICRcbWF0aGJme1pfdF4qfSQgb24gJChcbWF0aGJme1pfezF0fX0sXGxkb3RzLCBcbWF0aGJme1pfe210fX0pJCBhcmUgcHJvZHVjZWQuCgogIC0gc28gdGhhdCB0aGUgR0xTIGVzdGltYXRvciBvZiAkXGJvbGRzeW1ib2x7XGJldGF9JCBjYW4gYmUgb2J0YWluZWQKClxbClxib2xkc3ltYm9se1xoYXQgXGJldGFfe0dMU319PVxsZWZ0W1xzdW1cbGltaXRzX3t0PTF9Xk4gXG1hdGhiZntaX3ReeypUfVxTaWdtYV90XnstMX1aX3Reeyp9fVxyaWdodF1eey0xfVxzdW1cbGltaXRzX3t0PTF9Xk4gXG1hdGhiZntaX3ReeypUfVxTaWdtYV90XnstMX15X3Reeyp9fS4KXF0KCiAgLSB0aGUgaW5ub3ZhdGlvbnMgJFxib2xkc3ltYm9se1xlcHNpbG9ufV90JCBhcmUgdGhlbiBlcXVpdmFsZW50IHRvICRcYm9sZHN5bWJvbHtcZXBzaWxvbn1fdD1cbWF0aGJme3l9X3ReKiAtXG1hdGhiZnt6fV90XiogXGhhdHsgXGJvbGRzeW1ib2x7XGJldGF9fV97R0xTfSQKXGJlZ2lue2VxdWF0aW9ufQpcbG9nIExfe1xtYXRoYmZ7WX1fTn0oXGJvbGRzeW1ib2x7XFBzaX0pPS1cZnJhY3twbn17Mn1cbG9nIDIgXHBpIC0gXGZyYWN7MX17Mn0gXHN1bVxsaW1pdHNfe3Q9MX1ebiBcbG9nIFx2ZXJ0IFxib2xkc3ltYm9se1xTaWdtYX1fdFx2ZXJ0IC1cZnJhY3sxfXsyfSBcc3VtXGxpbWl0c197dD0xfV5uIFxib2xkc3ltYm9se1xlcHNpbG9ufV90XlQgXGJvbGRzeW1ib2x7XFNpZ21hfV90XnstMX0gXGJvbGRzeW1ib2x7XGVwc2lsb259X3QuClxlbmR7ZXF1YXRpb259CgozLiBIZW5jZSwgd2UgY2FuIHRodXMgdXBkYXRlIHRoZSBNLXN0ZXAgb2YgdGhlIEVNIGFsZ29yaXRobSB3aXRoIHRoZSBHTFMgZXN0aW1hdG9yIGZvciAkXGJvbGRzeW1ib2x7XGJldGF9JC4KCi0tLQoKPGJyIC8+CgoKIyMgTW9yZSBBZHZhbmNlZCBUb3BpY3MKCi0gU3RhdGUgU3BhY2UgbW9kZWxzIGNhbiBhbHNvIGJlIHVzZWQgdG8gbW9kZWwgcHJvY2Vzc2VzIHdpdGggc3RvY2hhc3RpYyB2b2xhdGlsaXR5LCBlLmcuIHdoZW4gbW9kZWxpbmcgcmV0dXJucy4gCgotIFdoZW4gdGhlIHN0YXRlcyBhcmUgZGlzY3JldGUsIHRoZSBTdGF0ZSBTcGFjZSBNb2RlbCBiZWNvbWVzIGEgSGlkZGVuIE1hcmtvdiBNb2RlbAoKLSBOb24tc3RhdGlvbmFyeSB0aW1lIHNlcmllcy4gU3BlY2lmaWMgZm9ybXVsYXRpb25zIG9mIFN0YXRlLVNwYWNlIE1vZGVscyBmb3IgaW5zdGFuY2UgYWxsb3cgdG8gbW9kZWwgc2Vhc29uYWwgdmFyaWF0aW9uIGFuZCB0cmVuZHMuIAoKLSBOb24tbm9ybWFsaXR5LiBOb3RlLCB0aGF0IHRoZSBlcnJvcnMgb2YgdGhlIGxvZy1ub3JtYWwgbW9kZWwgYXJlIG5vbi1ndWFzc2lhbi4gQnV0LCB0aGV5IGFyZSBzeW1tZXRyaWMgd2l0aCBicm9hZGVyIHRhaWxzLiBUaGUgZXN0aW1hdG9ycyB0aGF0IGFyZSB1c2VkIGhlcmUgYXJlIGFzc3ltcHRvdGljYWxseSBub3JtYWxseSBkaXN0cmlidXRlZC4gSW4gcmVsYXRpdmVseSBzaG9ydCB0aW1lIHNlcmllcyB3ZSBjYW4gCiAgICAKICAgIC0gcmVzb3J0IHRvIGJvb3RzdHJhcHBpbmcgdGhlIGlubm92YXRpb25zIHRvIHByb3ZpZGUgYmV0dGVyIGluZmVyZW5jZSBvciAKICAgIC0gd2UgY2FuIGV4cGxpY2l0ZWx5IG1vZGVsIHRoZSBlcnJvcnMgd2l0aCBhbm90aGVyIGRpc3RyaWJ1dGlvbiAKCgoKLS0tCgo8YnIgLz4KCgojIExpdGVyYXR1cmUgCgotIFRoZSBwcmVzZW50YXRpb24gaXMgbGFyZ2VseSBiYXNlZCBvbiB0aGUgbWV0aG9kcyBpbiBjaGFwdGVyIDYgb2YgUi4gU2h1bXdheSBhbmQgRC4gU3RvZmZlciAoMjAxNykgVGltZSBTZXJpZXMgQW5hbHlzaXMgYW5kIEl0cyBBcHBsaWNhdGlvbnMgV2l0aCBSIEV4YW1wbGVzIC0gIDR0aCBFZGl0aW9uLCB3aGljaCBpcyBmcmVlbHkgYXZhaWxhYmxlIG9uIFByb2YuIERhdmlkIFN0b2ZmZXIncyB3ZWJzaXRlICBodHRwczovL3d3dy5zdGF0LnBpdHQuZWR1L3N0b2ZmZXIvdHNhNC90c2E0Lmh0bQoKCi0tLQo=</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("index.Rmd");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
